
var PhysicsType2d;(function(PhysicsType2d){var BitFlag=(function(){function BitFlag(initial){if(initial){this.m_flags=initial;}else{this.m_flags=0;}}
BitFlag.prototype.Set=function(flag){this.m_flags=this.m_flags|flag;};BitFlag.prototype.Clear=function(flag){this.m_flags=this.m_flags&(~flag);};BitFlag.prototype.IsSet=function(desiredFlags){return(this.m_flags&desiredFlags)==desiredFlags;};return BitFlag;})();PhysicsType2d.BitFlag=BitFlag;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){var Utils=(function(){function Utils(){}
Utils.log=function(format){var optionalArgs=[];for(var _i=0;_i<(arguments.length-1);_i++){optionalArgs[_i]=arguments[_i+1];}
optionalArgs.unshift(format);console.log.apply(console,optionalArgs);};Utils.AllocateArray=function(size,create){var array=[];for(var i=0;i<size;i++){array[i]=create();}
return array;};return Utils;})();PhysicsType2d.Utils=Utils;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){"use strict";var MathExtensions=(function(){function MathExtensions(){}
MathExtensions.IsValid=function(x){return!isNaN(x)&&isFinite(x);};MathExtensions.InvSqrt=function(num){var x=num;var convert={};convert.x=x;var xhalf=0.5*x;convert.i=0x5f3759df-(convert.i>>1);x=convert.x;x=x*(1.5-xhalf*x*x);return x;};MathExtensions.Cross2x1=function(a,s){return new PhysicsType2d.Vector2(s*a.y,-s*a.x);};MathExtensions.Cross1x2=function(s,a){return new PhysicsType2d.Vector2(-s*a.y,s*a.x);};MathExtensions.Cross2x2=function(a,b){return a.Cross(b);};MathExtensions.Dot=function(a,b){return a.Dot(b);};MathExtensions.NextPowerOfTwo=function(num){var x=num;x|=(x>>1);x|=(x>>2);x|=(x>>4);x|=(x>>8);x|=(x>>16);return x+1;};MathExtensions.IsPowerOfTwo=function(x){var result=x>0&&(x&(x-1))===0;return result;};MathExtensions.Clamp=function(a,low,high){return Math.max(low,Math.min(a,high));};MathExtensions.UInt8=function(x){return MathExtensions.Clamp(Math.floor(x),0,2^8);};MathExtensions.UInt16=function(x){return MathExtensions.Clamp(Math.floor(x),0,2^16);};return MathExtensions;})();PhysicsType2d.MathExtensions=MathExtensions;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){"use strict";function Assert(result,message){if(!result){if(message&&0<message.length){throw message;}else{throw"Assert Failed";}}}
PhysicsType2d.Assert=Assert;var Constants=(function(){function Constants(){}
Constants.MAX_FLOAT=Number.MAX_VALUE;Constants.EPSILON=Number.MIN_VALUE*10;Constants.PI=Math.PI;return Constants;})();PhysicsType2d.Constants=Constants;var Settings=(function(){function Settings(){}
Settings.isDebug=true;Settings.maxManifoldPoints=2;Settings.maxPolygonVertices=8;Settings.aabbExtension=0.1;Settings.aabbMultiplier=2.0;Settings.linearSlop=0.005;Settings.angularSlop=(2.0/180.0*Constants.PI);Settings.polygonRadius=(2.0*Settings.linearSlop);Settings.maxSubSteps=8;Settings.maxTOIContacts=32;Settings.velocityThreshold=1.0;Settings.maxLinearCorrection=0.2;Settings.maxAngularCorrection=(8.0/180.0*Constants.PI);Settings.maxTranslation=2.0;Settings.maxTranslationSquared=(Settings.maxTranslation*Settings.maxTranslation);Settings.maxRotation=(0.5*Constants.PI);Settings.maxRotationSquared=(Settings.maxRotation*Settings.maxRotation);Settings.baumgarte=0.2;Settings.toiBaugarte=0.75;Settings.timeToSleep=0.5;Settings.linearSleepTolerance=0.01;Settings.angularSleepTolerance=(2.0/180.0*Constants.PI);return Settings;})();PhysicsType2d.Settings=Settings;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){var Rotation=(function(){function Rotation(){}
Rotation.prototype.Clone=function(){var clone=new Rotation();clone.S=this.S;clone.C=this.C;return clone;};Rotation.FromRadians=function(angleInRadians){var r=new Rotation();r.Set(angleInRadians);return r;};Rotation.prototype.Set=function(angleInRadians){this.S=Math.sin(angleInRadians);this.C=Math.cos(angleInRadians);};Rotation.prototype.SetIdentity=function(){this.S=0.0;this.C=1.0;};Rotation.prototype.GetAngle=function(){return Math.atan2(this.S,this.C);};Rotation.prototype.GetXAxis=function(){return new PhysicsType2d.Vector2(this.C,this.S);};Rotation.prototype.GetYAxis=function(){return new PhysicsType2d.Vector2(-this.S,this.C);};Rotation.prototype.Multiply=function(r){var qr=new Rotation();qr.S=this.S*r.C+this.C*r.S;qr.C=this.C*r.C-this.S*r.S;return qr;};Rotation.prototype.MultiplyTranspose=function(r){var qr=new Rotation();qr.S=this.C*r.S-this.S*r.C;qr.C=this.C*r.C+this.S*r.S;return qr;};Rotation.prototype.ApplyToVector2=function(v){return new PhysicsType2d.Vector2(this.C*v.x-this.S*v.y,this.S*v.x+this.C*v.y);};Rotation.prototype.ApplyTransposeToVector2=function(v){return new PhysicsType2d.Vector2(this.C*v.x+this.S*v.y,-this.S*v.x+this.C*v.y);};return Rotation;})();PhysicsType2d.Rotation=Rotation;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){var Transform=(function(){function Transform(){this.q=new PhysicsType2d.Rotation();this.p=new PhysicsType2d.Vector2(0,0);}
Transform.prototype.Clone=function(){var clone=new Transform();clone.p=this.p.Clone();clone.q=this.q.Clone();return clone;};Transform.prototype.Initialize=function(position,rotation){this.p=position;this.q=rotation;};Transform.prototype.SetIdentity=function(){this.p.SetZero();this.q.SetIdentity();};Transform.prototype.Set=function(position,angle){this.p=position;this.q.Set(angle);};Transform.prototype.Multiply=function(B){var C=new Transform();C.q=this.q.Multiply(B.q);C.p=this.q.ApplyToVector2(B.p).Add(this.p);return C;};Transform.prototype.MultiplyTranspose=function(B){var C=new Transform();C.q=this.q.MultiplyTranspose(B.q);C.p=this.q.ApplyTransposeToVector2(B.p.Subtract(this.p));return C;};Transform.prototype.ApplyToVector2=function(v){var x=(this.q.C*v.x-this.q.S*v.y)+this.p.x;var y=(this.q.S*v.x+this.q.C*v.y)+this.p.y;return new PhysicsType2d.Vector2(x,y);};Transform.prototype.ApplyTransposeToVector2=function(v){var px=v.x-this.p.x;var py=v.y-this.p.y;var x=(this.q.C*px+this.q.S*py);var y=(-this.q.S*px+this.q.C*py);return new PhysicsType2d.Vector2(x,y);};return Transform;})();PhysicsType2d.Transform=Transform;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){"use strict";var Vector2=(function(){function Vector2(x,y){this.x=(x);this.y=(y);}
Vector2.Zero=function(){return new Vector2(0,0);};Vector2.prototype.AngleBetween=function(v2){var perpDot=this.x*v2.y-this.y*v2.x;return Math.atan2(perpDot,this.Dot(v2));};Vector2.prototype.Clone=function(){return new Vector2(this.x,this.y);};Vector2.prototype.IsValid=function(){return PhysicsType2d.MathExtensions.IsValid(this.x)&&PhysicsType2d.MathExtensions.IsValid(this.y);};Vector2.prototype.Skew=function(){return new Vector2(-this.y,this.x);};Vector2.prototype.SetZero=function(){this.x=0.0;this.y=0.0;};Vector2.prototype.Set=function(x,y){this.x=(x);this.y=(y);};Vector2.prototype.Negative=function(){return new Vector2(-this.x,-this.y);};Vector2.prototype.GetIndex=function(index){switch(index){case 0:return this.x;case 1:return this.y;default:throw new RangeException();}};Vector2.prototype.SetIndex=function(index,value){switch(index){case 0:this.x=value;break;case 1:this.y=value;break;default:throw new RangeException();}};Vector2.prototype.Add=function(v){return new Vector2(this.x+v.x,this.y+v.y);};Vector2.prototype.Subtract=function(v){return new Vector2(this.x-v.x,this.y-v.y);};Vector2.prototype.Multiply=function(a){return new Vector2(this.x*a,this.y*a);};Vector2.prototype.Equals=function(v){return this.x===v.x&&this.y===v.y;};Vector2.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y);};Vector2.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y;};Vector2.prototype.Normalize=function(){var length=this.Length();if(length<PhysicsType2d.Constants.EPSILON){return 0.0;}
var invLength=1.0/length;this.x*=invLength;this.y*=invLength;return length;};Vector2.prototype.Dot=function(b){return(this.x*b.x+this.y*b.y);};Vector2.prototype.Cross=function(b){return(this.x*b.y-this.y*b.x);};Vector2.prototype.Rotate=function(q){return new Vector2(q.C*this.x-q.S*this.y,q.S*this.x+q.C*this.y);};Vector2.prototype.RotateTranspose=function(q){return new Vector2(q.C*this.x+q.S*this.y,-q.S*this.x+q.C*this.y);};Vector2.prototype.DistanceFrom=function(b){var c=this.Subtract(b);return c.Length();};Vector2.prototype.DistanceFromSquared=function(b){var c=this.Subtract(b);return c.LengthSquared();};Vector2.prototype.Transform=function(T){var x=(T.q.C*this.x-T.q.S*this.y)+T.p.x;var y=(T.q.S*this.x+T.q.C*this.y)+T.p.y;return new Vector2(x,y);};Vector2.prototype.TransformTranspose=function(T){var px=this.x-T.p.x;var py=this.y-T.p.y;var x=(T.q.C*px+T.q.S*py);var y=(-T.q.S*px+T.q.C*py);return new Vector2(x,y);};Vector2.prototype.Abs=function(){return new Vector2(Math.abs(this.x),Math.abs(this.y));};Vector2.prototype.Clamp=function(low,high){return Vector2.Max(low,Vector2.Min(this,high));};Vector2.Min=function(a,b){return new Vector2(Math.min(a.x,b.x),Math.min(a.y,b.y));};Vector2.Max=function(a,b){return new Vector2(Math.max(a.x,b.x),Math.max(a.y,b.y));};Vector2.DistanceBetween=function(a,b){return(new Vector2(a.x,a.y)).DistanceFrom(b);};Vector2.FromPoint=function(pt){return new Vector2(pt.x,pt.y);};Vector2.prototype.toString=function(){return"{"+this.x.toPrecision(6)+", "+this.y.toPrecision(6)+"}";};return Vector2;})();PhysicsType2d.Vector2=Vector2;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(DrawFlags){DrawFlags[DrawFlags["SHAPE"]=0x0001]="SHAPE";DrawFlags[DrawFlags["JOINT"]=0x0002]="JOINT";DrawFlags[DrawFlags["AABB"]=0x0004]="AABB";DrawFlags[DrawFlags["PAIR"]=0x0008]="PAIR";DrawFlags[DrawFlags["CENTER_OF_MASS"]=0x0010]="CENTER_OF_MASS";})(PhysicsType2d.DrawFlags||(PhysicsType2d.DrawFlags={}));var DrawFlags=PhysicsType2d.DrawFlags;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){var Node=(function(){function Node(value){this.Data=value;this.Next=null;this.Previous=null;}
Node.prototype.InsertBefore=function(targetNode){var old=targetNode.Previous;if(old){old.Next=this;}
this.Previous=old;targetNode.Previous=this;this.Next=targetNode;};Node.prototype.InsertAfter=function(targetNode){var old=targetNode.Next;if(old){old.Previous=this;}
this.Next=old;targetNode.Next=this;this.Previous=targetNode;};return Node;})();var LinkedList=(function(){function LinkedList(){this._head=null;this._count=0;}
LinkedList.prototype.Add=function(value){var node=new Node(value);if(null!=this._head){node.InsertBefore(this._head);}
this._head=node;this._count++;};LinkedList.prototype.RemoveTop=function(){var data=this._head.Data;this._head=this._head.Next;this._count--;return data;};LinkedList.prototype.Remove=function(data){if(this._head){if(this._head.Data==data){this._head=this._head.Next;if(this._head){this._head.Previous=null;}
this._count--;return true;}
var node=this._head.Next;while(node){if(node.Data==data){node.Previous.Next=node.Next;if(node.Next){node.Next.Previous=node.Previous;}
this._count--;return true;}
node=node.Next;}}
return false;};LinkedList.prototype.DeleteCurrent=function(iterator){var iter=iterator;var currentNode=iter.GetCurrentNode();if(currentNode==this._head){this._head=currentNode.Next;if(this._head){this._head.Previous=null;}}else{currentNode.Previous.Next=currentNode.Next;if(currentNode.Next){currentNode.Next.Previous=currentNode.Previous;}}
this._count--;};LinkedList.prototype.Count=function(){return this._count;};LinkedList.prototype.GetIterator=function(){return new ListIterator(this._head);};return LinkedList;})();PhysicsType2d.LinkedList=LinkedList;var ListIterator=(function(){function ListIterator(head){this._head=head;this._started=false;this._current=null;}
ListIterator.prototype.GetCurrentNode=function(){PhysicsType2d.Assert(this._started);PhysicsType2d.Assert(null!=this._current);return this._current;};ListIterator.prototype.Reset=function(){this._started=false;this._current=null;};ListIterator.prototype.Current=function(){return this._current.Data;};ListIterator.prototype.SetCurrent=function(value){this._current.Data=value;};ListIterator.prototype.MoveNext=function(){if(!this._started){this._started=true;this._current=this._head;return this._current!=null;}else if(this._current){this._current=this._current.Next;return this._current!=null;}
return false;};ListIterator.prototype.MovePrevious=function(){if(this._current){this._current=this._current.Previous;return this._current!=null;}
return false;};return ListIterator;})();})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){var Matrix2x2=(function(){function Matrix2x2(){this.EX=new PhysicsType2d.Vector2(0,0);this.EY=new PhysicsType2d.Vector2(0,0);}
Matrix2x2.FromColumns=function(c1,c2){var m=new Matrix2x2();m.Set(c1,c2);return m;};Matrix2x2.FromScalars=function(a11,a12,a21,a22){var m=new Matrix2x2();m.EX.Set(a11,a21);m.EY.Set(a12,a22);return m;};Matrix2x2.prototype.Set=function(c1,c2){this.EX=c1;this.EY=c2;};Matrix2x2.prototype.SetIdentity=function(){this.EX.Set(1.0,0.0);this.EY.Set(0.0,1.0);};Matrix2x2.prototype.SetZero=function(){this.EX.SetZero();this.EY.SetZero();};Matrix2x2.prototype.GetInverse=function(){var a=this.EX.x;var b=this.EY.x;var c=this.EX.y;var d=this.EY.y;var inverse=new Matrix2x2();var det=a*d-b*c;if(det!=0.0){det=1.0/det;}
inverse.EX.Set(det*d,-det*c);inverse.EY.Set(-det*b,det*a);return inverse;};Matrix2x2.prototype.Solve=function(b){var a11=this.EX.x;var a12=this.EY.x;var a21=this.EX.y;var a22=this.EY.y;var det=a11*a22-a12*a21;if(det!=0.0){det=1.0/det;}
var solution=new PhysicsType2d.Vector2(det*(a22*b.x-a12*b.y),det*(a11*b.y-a21*b.x));return solution;};Matrix2x2.prototype.VectorMultiply=function(v){return new PhysicsType2d.Vector2(this.EX.x*v.x+this.EY.x*v.y,this.EX.y*v.x+this.EY.y*v.y);};Matrix2x2.prototype.VectorMultiplyTranspose=function(v){return new PhysicsType2d.Vector2(v.Dot(this.EX),v.Dot(this.EY));};Matrix2x2.prototype.Add=function(B){return Matrix2x2.FromColumns(this.EX.Add(B.EX),this.EY.Add(B.EY));};Matrix2x2.prototype.Multiply=function(B){return Matrix2x2.FromColumns(this.VectorMultiply(B.EX),this.VectorMultiply(B.EY));};Matrix2x2.prototype.MultiplyTranspose=function(B){var c1=new PhysicsType2d.Vector2(this.EX.Dot(B.EX),this.EY.Dot(B.EX));var c2=new PhysicsType2d.Vector2(this.EX.Dot(B.EY),this.EY.Dot(B.EY));return Matrix2x2.FromColumns(c1,c2);};Matrix2x2.prototype.Abs=function(){return Matrix2x2.FromColumns(this.EX.Abs(),this.EY.Abs());};return Matrix2x2;})();PhysicsType2d.Matrix2x2=Matrix2x2;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){var Vector3=(function(){function Vector3(x,y,z){this.x=(x);this.y=(y);this.z=(z);}
Vector3.prototype.SetZero=function(){this.x=0.0;this.y=0.0;this.z=0.0;};Vector3.prototype.Set=function(x,y,z){this.x=(x);this.y=(y);this.z=(z);};Vector3.prototype.Negative=function(){return new Vector3(-this.x,-this.y,-this.z);};Vector3.prototype.Add=function(v){return new Vector3(this.x+v.x,this.y+v.y,this.z+v.z);};Vector3.prototype.Subtract=function(v){return new Vector3(this.x-v.x,this.y-v.y,this.z-v.z);};Vector3.prototype.Multiply=function(a){return new Vector3(this.x*a,this.y*a,this.z*a);};Vector3.prototype.Dot=function(b){return(this.x*b.x+this.y*b.y+this.z*b.z);};Vector3.prototype.Cross=function(b){return new Vector3(this.y*b.z-this.z*b.y,this.z*b.x-this.x*b.z,this.x*b.y-this.y*b.x);};Vector3.prototype.Abs=function(){return new Vector3(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z));};return Vector3;})();PhysicsType2d.Vector3=Vector3;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){var Matrix3x3=(function(){function Matrix3x3(){this.EX=new PhysicsType2d.Vector3(0,0,0);this.EY=new PhysicsType2d.Vector3(0,0,0);this.EZ=new PhysicsType2d.Vector3(0,0,0);}
Matrix3x3.prototype.FromColumns=function(c1,c2,c3){this.EX=c1;this.EY=c2;this.EZ=c3;};Matrix3x3.prototype.SetZero=function(){this.EX.SetZero();this.EY.SetZero();this.EZ.SetZero();};Matrix3x3.prototype.Solve3x3=function(b){var det=this.EX.Dot(this.EY.Cross(this.EZ));if(det!=0.0){det=1.0/det;}
var x=new PhysicsType2d.Vector3(det*b.Dot(this.EY.Cross(this.EZ)),det*this.EX.Dot(b.Cross(this.EZ)),det*this.EX.Dot(this.EY.Cross(b)));return x;};Matrix3x3.prototype.Solve2x2=function(b){var a11=this.EX.x;var a12=this.EY.x;var a21=this.EX.y;var a22=this.EY.y;var det=a11*a22-a12*a21;if(det!=0.0){det=1.0/det;}
var x=det*(a22*b.x-a12*b.y);var y=det*(a11*b.y-a21*b.x);return new PhysicsType2d.Vector2(x,y);};Matrix3x3.prototype.GetInverse22=function(){var a=this.EX.x;var b=this.EY.x;var c=this.EX.y;var d=this.EY.y;var det=a*d-b*c;if(det!=0.0){det=1.0/det;}
var M=new Matrix3x3();M.EX.Set(det*d,-det*c,0.0);M.EY.Set(-det*b,det*a,0.0);M.EZ.Set(0.0,0.0,0.0);return M;};Matrix3x3.prototype.GetSymInverse33=function(){var det=this.EX.Dot(this.EY.Cross(this.EZ));if(det!=0.0){det=1.0/det;}
var a11=this.EX.x;var a12=this.EY.x;var a13=this.EZ.x;var a22=this.EY.y;var a23=this.EZ.y;var a33=this.EZ.z;var M=new Matrix3x3();M.EX.Set(det*(a22*a33-a23*a23),det*(a13*a23-a12*a33),det*(a12*a23-a13*a22));M.EY.Set(M.EX.y,det*(a11*a33-a13*a13),det*(a13*a12-a11*a23));M.EZ.Set(M.EX.z,M.EY.z,det*(a11*a22-a12*a12));return M;};Matrix3x3.prototype.Vector3Multiply=function(v){return this.EX.Multiply(v.x).Add(this.EY.Multiply(v.y)).Add(this.EZ.Multiply(v.z));};Matrix3x3.prototype.Vector2Multiply=function(v){return new PhysicsType2d.Vector2(this.EX.x*v.x+this.EY.x*v.y,this.EX.y*v.x+this.EY.y*v.y);};return Matrix3x3;})();PhysicsType2d.Matrix3x3=Matrix3x3;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){var RopeDefinition=(function(){function RopeDefinition(){this.gravity=new PhysicsType2d.Vector2(0,0);this.vertices=[];this.masses=[];this.damping=0.1;this.k2=0.9;this.k3=0.1;}
RopeDefinition.prototype.VertexCount=function(){if(this.vertices){return this.vertices.length;}
return 0;};return RopeDefinition;})();PhysicsType2d.RopeDefinition=RopeDefinition;var Rope=(function(){function Rope(){this._gravity=new PhysicsType2d.Vector2(0,0);this._ps=[];this._p0s=[];this._vs=[];this._ims=[];this._Ls=[];this._as=[];this._k2=1.0;this._k3=0.1;}
Rope.prototype.Initialize=function(def){PhysicsType2d.Assert(def.VertexCount()>=3,"Must have at least 3 vertices");var count=def.VertexCount();this._ps=new Array(count);this._p0s=new Array(count);this._vs=new Array(count);this._ims=new Array(count);var i=0;for(i=0;i<count;i++){this._ps[i]=def.vertices[i];this._p0s[i]=def.vertices[i];this._vs[i]=new PhysicsType2d.Vector2(0,0);var m=def.masses[i];if(m>0.0){this._ims[i]=1.0/m;}else{this._ims[i]=0.0;}}
var count2=count-1;var count3=count-2;this._Ls=new Array(count2);this._as=new Array(count3);for(i=0;i<count2;i++){var p1=this._ps[i];var p2=this._ps[i+1];this._Ls[i]=p1.DistanceFrom(p2);}
for(i=0;i<count3;i++){var p1=this._ps[i];var p2=this._ps[i+1];var p3=this._ps[i+2];var d1=p2.Subtract(p1);var d2=p3.Subtract(p2);var a=d1.Cross(d2);var b=d1.Dot(d2);this._as[i]=Math.atan2(a,b);}
this._gravity=def.gravity;this._damping=def.damping;this._k2=def.k2;this._k3=def.k3;};Rope.prototype.Step=function(h,iterations){if(h===0.0){return;}
var d=Math.exp(-h*this._damping);var i=0;for(i=0;i<this._ps.length;i++){this._p0s[i]=this._ps[i];if(this._ims[i]>0.0){this._vs[i]=this._vs[i].Add(this._gravity.Multiply(h));}
this._vs[i]=this._vs[i].Multiply(d);this._ps[i]=this._ps[i].Add(this._vs[i].Multiply(h));}
for(i=0;i<iterations;i++){this.SolveC2();this.SolveC3();this.SolveC2();}
var inv_h=1.0/h;for(i=0;i<this._ps.length;i++){this._vs[i]=(this._ps[i].Subtract(this._p0s[i])).Multiply(inv_h);}};Rope.prototype.GetVertexCount=function(){return this._ps.length;};Rope.prototype.GetVertices=function(){return this._ps;};Rope.prototype.Draw=function(draw,c){for(var i=0;i<this._ps.length-1;i++){draw.DrawSegment(this._ps[i],this._ps[i+1],c);}};Rope.prototype.SetAngle=function(angle){var count3=this._as.length-2;for(var i=0;i<count3;i++){this._as[i]=angle;}};Rope.prototype.SolveC2=function(){var count2=this._ps.length-1;for(var i=0;i<count2;i++){var p1=this._ps[i];var p2=this._ps[i+1];var d=p2.Subtract(p1);var L=d.Normalize();var im1=this._ims[i];var im2=this._ims[i+1];if((im1+im2)===0.0){continue;}
var s1=im1/(im1+im2);var s2=im2/(im1+im2);p1=p1.Subtract(d.Multiply(this._k2*s1*(this._Ls[i]-L)));p2=p2.Add(d.Multiply(this._k2*s2*(this._Ls[i]-L)));this._ps[i]=p1;this._ps[i+1]=p2;}};Rope.prototype.SolveC3=function(){var count3=this._ps.length-2;for(var i=0;i<count3;++i){var p1=this._ps[i];var p2=this._ps[i+1];var p3=this._ps[i+2];var m1=this._ims[i];var m2=this._ims[i+1];var m3=this._ims[i+2];var d1=p2.Subtract(p1);var d2=p3.Subtract(p2);var L1sqr=d1.LengthSquared();var L2sqr=d2.LengthSquared();if(L1sqr*L2sqr==0.0){continue;}
var a=d1.Cross(d2);var b=d1.Dot(d2);var angle=Math.atan2(a,b);var Jd1=(d1.Skew()).Multiply(-1.0/L1sqr);var Jd2=(d2.Skew()).Multiply(1.0/L2sqr);var J1=Jd1.Negative();var J2=Jd1.Subtract(Jd2);var J3=Jd2;var mass=m1*J1.Dot(J1)+m2*J2.Dot(J2)+m3*J3.Dot(J3);if(mass===0.0){continue;}
mass=1.0/mass;var C=angle-this._as[i];while(C>PhysicsType2d.Constants.PI){angle-=2*PhysicsType2d.Constants.PI;C=angle-this._as[i];}
while(C<-PhysicsType2d.Constants.PI){angle+=2.0*PhysicsType2d.Constants.PI;C=angle-this._as[i];}
var impulse=-this._k3*mass*C;p1=p1.Add(J1.Multiply(m1*impulse));p2=p2.Add(J2.Multiply(m2*impulse));p3=p3.Add(J3.Multiply(m3*impulse));this._ps[i]=p1;this._ps[i+1]=p2;this._ps[i+2]=p3;}};return Rope;})();PhysicsType2d.Rope=Rope;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){var TWO_PI=2.0*PhysicsType2d.Constants.PI;var Sweep=(function(){function Sweep(){this.a=0;this.a0=0;this.alpha0=0;this.c=PhysicsType2d.Vector2.Zero();this.c0=PhysicsType2d.Vector2.Zero();this.localCenter=PhysicsType2d.Vector2.Zero();}
Sweep.prototype.Clone=function(){var clone=new Sweep();clone.a=this.a;clone.a0=this.a0;clone.alpha0=this.alpha0;clone.c=this.c.Clone();clone.c0=this.c0.Clone();clone.localCenter=this.localCenter.Clone();return clone;};Sweep.prototype.GetTransform=function(beta){var xf=new PhysicsType2d.Transform();xf.p=this.c0.Multiply(1.0-beta).Add(this.c.Multiply(beta));var angle=(1.0-beta)*this.a0+beta*this.a;xf.q.Set(angle);xf.p=xf.p.Subtract(xf.q.ApplyToVector2(this.localCenter));return xf;};Sweep.prototype.Advance=function(alpha){PhysicsType2d.Assert(this.alpha0<1.0);var beta=(alpha-this.alpha0)/(1.0-this.alpha0);this.c0=this.c0.Multiply(1.0-beta).Add(this.c.Multiply(beta));this.a0=(1.0-beta)*this.a0+beta*this.a;this.alpha0=alpha;};Sweep.prototype.Normalize=function(){var d=TWO_PI*Math.floor(this.a0/TWO_PI);this.a0-=d;this.a-=d;};return Sweep;})();PhysicsType2d.Sweep=Sweep;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){var Timer=(function(){function Timer(){this.Reset();}
Timer.prototype.Reset=function(){this.m_start=(new Date()).getTime();};Timer.prototype.GetMilliseconds=function(){return(new Date()).getTime()-this.m_start;};return Timer;})();PhysicsType2d.Timer=Timer;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){(function(ContactFeatureType){ContactFeatureType[ContactFeatureType["VERTEX"]=0]="VERTEX";ContactFeatureType[ContactFeatureType["FACE"]=1]="FACE";})(Collision.ContactFeatureType||(Collision.ContactFeatureType={}));var ContactFeatureType=Collision.ContactFeatureType;;var ContactFeature=(function(){function ContactFeature(){this.indexA=0;this.indexB=0;this.typeA=0;this.typeB=0;}
return ContactFeature;})();Collision.ContactFeature=ContactFeature;var ContactID=(function(){function ContactID(){this.cf=new ContactFeature();this.key=0;}
return ContactID;})();Collision.ContactID=ContactID;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){var ClipVertex=(function(){function ClipVertex(){this.v=new PhysicsType2d.Vector2(0,0);this.id=new PhysicsType2d.Collision.ContactID();}
return ClipVertex;})();Collision.ClipVertex=ClipVertex;var RayCastInput=(function(){function RayCastInput(){this.p1=new PhysicsType2d.Vector2(0,0);this.p2=new PhysicsType2d.Vector2(0,0);}
return RayCastInput;})();Collision.RayCastInput=RayCastInput;var RayCastOutput=(function(){function RayCastOutput(){this.normal=new PhysicsType2d.Vector2(0,0);}
return RayCastOutput;})();Collision.RayCastOutput=RayCastOutput;var ManifoldPoint=(function(){function ManifoldPoint(){this.localPoint=new PhysicsType2d.Vector2(0,0);this.normalImpulse=0;this.tangentImpulse=0;this.id=new PhysicsType2d.Collision.ContactID();}
return ManifoldPoint;})();Collision.ManifoldPoint=ManifoldPoint;(function(ManifoldType){ManifoldType[ManifoldType["CIRCLES"]=0]="CIRCLES";ManifoldType[ManifoldType["FACE_A"]=1]="FACE_A";ManifoldType[ManifoldType["FACE_B"]=2]="FACE_B";})(Collision.ManifoldType||(Collision.ManifoldType={}));var ManifoldType=Collision.ManifoldType;;var Manifold=(function(){function Manifold(){this.points=[];this.localNormal=new PhysicsType2d.Vector2(0,0);this.localPoint=new PhysicsType2d.Vector2(0,0);}
return Manifold;})();Collision.Manifold=Manifold;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){var AxisAlignedBoundingBox=(function(){function AxisAlignedBoundingBox(){this.lowerBound=new PhysicsType2d.Vector2(0,0);this.upperBound=new PhysicsType2d.Vector2(0,0);}
AxisAlignedBoundingBox.prototype.Clone=function(){var clone=new AxisAlignedBoundingBox();clone.lowerBound=this.lowerBound.Clone();clone.upperBound=this.upperBound.Clone();return clone;};AxisAlignedBoundingBox.prototype.IsValid=function(){var d=this.upperBound.Subtract(this.lowerBound);var valid=d.x>=0.0&&d.y>=0.0;valid=valid&&this.lowerBound.IsValid()&&this.upperBound.IsValid();return valid;};AxisAlignedBoundingBox.prototype.GetCenter=function(){return(this.lowerBound.Add(this.upperBound)).Multiply(0.5);};AxisAlignedBoundingBox.prototype.GetExtents=function(){return(this.upperBound.Subtract(this.lowerBound)).Multiply(0.5);};AxisAlignedBoundingBox.prototype.GetPerimeter=function(){var wx=this.upperBound.x-this.lowerBound.x;var wy=this.upperBound.y-this.lowerBound.y;return 2.0*(wx+wy);};AxisAlignedBoundingBox.prototype.CombineWith=function(aabb){this.lowerBound=PhysicsType2d.Vector2.Min(this.lowerBound,aabb.lowerBound);this.upperBound=PhysicsType2d.Vector2.Max(this.upperBound,aabb.upperBound);};AxisAlignedBoundingBox.prototype.Combine=function(aabb1,aabb2){this.lowerBound=PhysicsType2d.Vector2.Min(aabb1.lowerBound,aabb2.lowerBound);this.upperBound=PhysicsType2d.Vector2.Max(aabb1.upperBound,aabb2.upperBound);};AxisAlignedBoundingBox.prototype.Contains=function(aabb){var result=true;result=result&&this.lowerBound.x<=aabb.lowerBound.x;result=result&&this.lowerBound.y<=aabb.lowerBound.y;result=result&&aabb.upperBound.x<=this.upperBound.x;result=result&&aabb.upperBound.y<=this.upperBound.y;return result;};AxisAlignedBoundingBox.prototype.RayCast=function(input){var tmin=-PhysicsType2d.Constants.MAX_FLOAT;var tmax=PhysicsType2d.Constants.MAX_FLOAT;var p=input.p1.Clone();var d=input.p2.Subtract(input.p1);var absD=d.Abs();var normal=new PhysicsType2d.Vector2(0,0);for(var i=0;i<2;++i){if(absD.GetIndex(i)<PhysicsType2d.Constants.EPSILON){if(p.GetIndex(i)<this.lowerBound.GetIndex(i)||this.upperBound.GetIndex(i)<p.GetIndex(i)){return null;}}else{var inv_d=1.0/d.GetIndex(i);var t1=(this.lowerBound.GetIndex(i)-p.GetIndex(i))*inv_d;var t2=(this.upperBound.GetIndex(i)-p.GetIndex(i))*inv_d;var s=-1.0;if(t1>t2){var temp=t1;t1=t2;t2=temp;s=1.0;}
if(t1>tmin){normal.SetZero();normal.SetIndex(i,s);tmin=t1;}
tmax=Math.min(tmax,t2);if(tmin>tmax){return null;}}}
if(tmin<0.0||input.maxFraction<tmin){return null;}
var output=new PhysicsType2d.Collision.RayCastOutput();output.fraction=tmin;output.normal=normal;return output;};AxisAlignedBoundingBox.prototype.TestOverlap=function(b){PhysicsType2d.Assert(this.IsValid());PhysicsType2d.Assert(b.IsValid());var d1=b.lowerBound.Subtract(this.upperBound);var d2=this.lowerBound.Subtract(b.upperBound);if(d1.x>0.0||d1.y>0.0){return false;}
if(d2.x>0.0||d2.y>0.0){return false;}
return true;};return AxisAlignedBoundingBox;})();Collision.AxisAlignedBoundingBox=AxisAlignedBoundingBox;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){(function(TreeConstants){TreeConstants[TreeConstants["NULL_NODE"]=-1]="NULL_NODE";})(Collision.TreeConstants||(Collision.TreeConstants={}));var TreeConstants=Collision.TreeConstants;var TreeNode=(function(){function TreeNode(){this.aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();}
TreeNode.prototype.Clone=function(){var clone=new TreeNode();clone._link=this._link;clone.aabb=this.aabb.Clone();clone.child1=this.child1;clone.child2=this.child2;clone.height=this.height;return clone;};TreeNode.prototype.IsLeaf=function(){return this.child1==-1;};TreeNode.prototype.parent=function(value){if(PhysicsType2d.MathExtensions.IsValid(value)){this._link=value;}
return this._link;};TreeNode.prototype.next=function(value){if(PhysicsType2d.MathExtensions.IsValid(value)){this._link=value;}
return this._link;};return TreeNode;})();Collision.TreeNode=TreeNode;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){var DynamicTree=(function(){function DynamicTree(){this.m_root=-1;this.m_nodeCapacity=16;this.m_nodeCount=0;this.m_nodes=PhysicsType2d.Utils.AllocateArray(this.m_nodeCapacity,function(){return new PhysicsType2d.Collision.TreeNode();});for(var i=0;i<this.m_nodeCapacity-1;++i){this.m_nodes[i].next(i+1);this.m_nodes[i].height=-1;}
this.m_nodes[this.m_nodeCapacity-1].next(-1);this.m_nodes[this.m_nodeCapacity-1].height=-1;this.m_freeList=0;this.m_path=0;this.m_insertionCount=0;}
DynamicTree.prototype.CreateProxy=function(aabb,userData){var proxyId=this.AllocateNode();var r=new PhysicsType2d.Vector2(PhysicsType2d.Settings.aabbExtension,PhysicsType2d.Settings.aabbExtension);this.m_nodes[proxyId].aabb.lowerBound=aabb.lowerBound.Subtract(r);this.m_nodes[proxyId].aabb.upperBound=aabb.upperBound.Add(r);this.m_nodes[proxyId].userData=userData;this.m_nodes[proxyId].height=0;this.InsertLeaf(proxyId);return proxyId;};DynamicTree.prototype.DestroyProxy=function(proxyId){PhysicsType2d.Assert(0<=proxyId&&proxyId<this.m_nodeCapacity);PhysicsType2d.Assert(this.m_nodes[proxyId].IsLeaf());this.RemoveLeaf(proxyId);this.FreeNode(proxyId);};DynamicTree.prototype.MoveProxy=function(proxyId,aabb,displacement){PhysicsType2d.Assert(0<=proxyId&&proxyId<this.m_nodeCapacity);PhysicsType2d.Assert(this.m_nodes[proxyId].IsLeaf());if(this.m_nodes[proxyId].aabb.Contains(aabb)){return false;}
this.RemoveLeaf(proxyId);var b=aabb.Clone();var r=new PhysicsType2d.Vector2(PhysicsType2d.Settings.aabbExtension,PhysicsType2d.Settings.aabbExtension);b.lowerBound=b.lowerBound.Subtract(r);b.upperBound=b.upperBound.Add(r);var d=displacement.Multiply(PhysicsType2d.Settings.aabbMultiplier);if(d.x<0.0){b.lowerBound.x+=d.x;}else{b.upperBound.x+=d.x;}
if(d.y<0.0){b.lowerBound.y+=d.y;}else{b.upperBound.y+=d.y;}
this.m_nodes[proxyId].aabb=b;this.InsertLeaf(proxyId);return true;};DynamicTree.prototype.GetUserData=function(proxyId){PhysicsType2d.Assert(0<=proxyId&&proxyId<this.m_nodeCapacity);return this.m_nodes[proxyId].userData;};DynamicTree.prototype.GetFatAABB=function(proxyId){PhysicsType2d.Assert(0<=proxyId&&proxyId<this.m_nodeCapacity);return this.m_nodes[proxyId].aabb.Clone();};DynamicTree.prototype.Query=function(listener,aabb){var stack=[];stack.push(this.m_root);while(stack.length>0){var nodeId=stack.pop();if(nodeId==-1){continue;}
var node=this.m_nodes[nodeId];if(node.aabb.TestOverlap(aabb)){if(node.IsLeaf()){var proceed=listener.QueryCallback(nodeId);if(proceed==false){return;}}else{stack.push(node.child1);stack.push(node.child2);}}}};DynamicTree.prototype.RayCast=function(callback,input){var p1=input.p1;var p2=input.p2;var r=p2.Subtract(p1);PhysicsType2d.Assert(r.LengthSquared()>0.0);r.Normalize();var v=PhysicsType2d.MathExtensions.Cross1x2(1.0,r);var abs_v=v.Abs();var maxFraction=input.maxFraction;var segmentAABB=(function(self){var t=p1.Add((p2.Subtract(p1)).Multiply(maxFraction));var aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();aabb.lowerBound=PhysicsType2d.Vector2.Min(p1,t);aabb.upperBound=PhysicsType2d.Vector2.Max(p1,t);return aabb;})(this);var stack=[];stack.push(this.m_root);while(stack.length>0){var nodeId=stack.pop();if(nodeId==-1){continue;}
var node=this.m_nodes[nodeId];if(node.aabb.TestOverlap(segmentAABB)==false){continue;}
var c=node.aabb.GetCenter();var h=node.aabb.GetExtents();var separation=Math.abs(v.Dot(p1.Subtract(c)))-abs_v.Dot(h);if(separation>0.0){continue;}
if(node.IsLeaf()){var subInput=new PhysicsType2d.Collision.RayCastInput();subInput.p1=input.p1;subInput.p2=input.p2;subInput.maxFraction=maxFraction;var value=callback.RayCastCallback(subInput,nodeId);if(value==0.0){return;}
if(value>0.0){maxFraction=value;var t=p1.Add((p2.Subtract(p1)).Multiply(maxFraction));segmentAABB.lowerBound=PhysicsType2d.Vector2.Min(p1,t);segmentAABB.upperBound=PhysicsType2d.Vector2.Max(p1,t);}}else{stack.push(node.child1);stack.push(node.child2);}}};DynamicTree.prototype.Validate=function(){this.ValidateStructure(this.m_root);this.ValidateMetrics(this.m_root);var freeCount=0;var freeIndex=this.m_freeList;while(freeIndex!=-1){PhysicsType2d.Assert(0<=freeIndex&&freeIndex<this.m_nodeCapacity);freeIndex=this.m_nodes[freeIndex].next();++freeCount;}
PhysicsType2d.Assert(this.GetHeight()==this.ComputeHeight());PhysicsType2d.Assert(this.m_nodeCount+freeCount==this.m_nodeCapacity);};DynamicTree.prototype.GetHeight=function(){if(this.m_root==-1){return 0;}
return this.m_nodes[this.m_root].height;};DynamicTree.prototype.GetMaxBalance=function(){var maxBalance=0;for(var i=0;i<this.m_nodeCapacity;++i){var node=this.m_nodes[i];if(node.height<=1){continue;}
PhysicsType2d.Assert(node.IsLeaf()==false);var child1=node.child1;var child2=node.child2;var balance=Math.abs(this.m_nodes[child2].height-this.m_nodes[child1].height);maxBalance=Math.max(maxBalance,balance);}
return maxBalance;};DynamicTree.prototype.GetAreaRatio=function(){if(this.m_root==-1){return 0.0;}
var root=this.m_nodes[this.m_root];var rootArea=root.aabb.GetPerimeter();var totalArea=0.0;for(var i=0;i<this.m_nodeCapacity;++i){var node=this.m_nodes[i];if(node.height<0){continue;}
totalArea+=node.aabb.GetPerimeter();}
return totalArea/rootArea;};DynamicTree.prototype.RebuildBottomUp=function(){var nodes=new Array(this.m_nodeCount);var count=0;for(var i=0;i<this.m_nodeCapacity;++i){if(this.m_nodes[i].height<0){continue;}
if(this.m_nodes[i].IsLeaf()){this.m_nodes[i].parent(-1);nodes[count]=i;++count;}else{this.FreeNode(i);}}
while(count>1){var minCost=PhysicsType2d.Constants.MAX_FLOAT;var iMin=-1;var jMin=-1;for(var i=0;i<count;++i){var aabbi=this.m_nodes[nodes[i]].aabb.Clone();for(var j=i+1;j<count;++j){var aabbj=this.m_nodes[nodes[j]].aabb.Clone();var b=new PhysicsType2d.Collision.AxisAlignedBoundingBox();b.Combine(aabbi,aabbj);var cost=b.GetPerimeter();if(cost<minCost){iMin=i;jMin=j;minCost=cost;}}}
var index1=nodes[iMin];var index2=nodes[jMin];var child1=this.m_nodes[index1];var child2=this.m_nodes[index2];var parentIndex=this.AllocateNode();var parent=this.m_nodes[parentIndex];parent.child1=index1;parent.child2=index2;parent.height=1+Math.max(child1.height,child2.height);parent.aabb.Combine(child1.aabb,child2.aabb);parent.parent(-1);child1.parent(parentIndex);child2.parent(parentIndex);nodes[jMin]=nodes[count-1];nodes[iMin]=parentIndex;--count;}
this.m_root=nodes[0];nodes=null;this.Validate();};DynamicTree.prototype.AllocateNode=function(){if(this.m_freeList==-1){PhysicsType2d.Assert(this.m_nodeCount==this.m_nodeCapacity);var oldNodes=this.m_nodes;this.m_nodeCapacity*=2;this.m_nodes=PhysicsType2d.Utils.AllocateArray(this.m_nodeCapacity,function(){return new PhysicsType2d.Collision.TreeNode();});for(var i=0;i<oldNodes.length;i++){this.m_nodes[i]=oldNodes[i];}
oldNodes=null;for(var i=this.m_nodeCount;i<this.m_nodeCapacity-1;++i){this.m_nodes[i].next(i+1);this.m_nodes[i].height=-1;}
this.m_nodes[this.m_nodeCapacity-1].next(-1);this.m_nodes[this.m_nodeCapacity-1].height=-1;this.m_freeList=this.m_nodeCount;}
var nodeId=this.m_freeList;this.m_freeList=this.m_nodes[nodeId].next();this.m_nodes[nodeId].parent(-1);this.m_nodes[nodeId].child1=-1;this.m_nodes[nodeId].child2=-1;this.m_nodes[nodeId].height=0;this.m_nodes[nodeId].userData=null;++this.m_nodeCount;return nodeId;};DynamicTree.prototype.FreeNode=function(nodeId){PhysicsType2d.Assert(0<=nodeId&&nodeId<this.m_nodeCapacity);PhysicsType2d.Assert(0<this.m_nodeCount);this.m_nodes[nodeId].next(this.m_freeList);this.m_nodes[nodeId].height=-1;this.m_freeList=nodeId;--this.m_nodeCount;};DynamicTree.prototype.InsertLeaf=function(leaf){++this.m_insertionCount;if(this.m_root==-1){this.m_root=leaf;this.m_nodes[this.m_root].parent(-1);return;}
var leafAABB=this.m_nodes[leaf].aabb;var index=this.m_root;while(this.m_nodes[index].IsLeaf()==false){var child1=this.m_nodes[index].child1;var child2=this.m_nodes[index].child2;var area=this.m_nodes[index].aabb.GetPerimeter();var combinedAABB=new PhysicsType2d.Collision.AxisAlignedBoundingBox();combinedAABB.Combine(this.m_nodes[index].aabb,leafAABB);var combinedArea=combinedAABB.GetPerimeter();var cost=2.0*combinedArea;var inheritanceCost=2.0*(combinedArea-area);var cost1=0.0;if(this.m_nodes[child1].IsLeaf()){var aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();aabb.Combine(leafAABB,this.m_nodes[child1].aabb);cost1=aabb.GetPerimeter()+inheritanceCost;}else{var aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();aabb.Combine(leafAABB,this.m_nodes[child1].aabb);var oldArea=this.m_nodes[child1].aabb.GetPerimeter();var newArea=aabb.GetPerimeter();cost1=(newArea-oldArea)+inheritanceCost;}
var cost2;if(this.m_nodes[child2].IsLeaf()){var aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();aabb.Combine(leafAABB,this.m_nodes[child2].aabb);cost2=aabb.GetPerimeter()+inheritanceCost;}else{var aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();aabb.Combine(leafAABB,this.m_nodes[child2].aabb);var oldArea=this.m_nodes[child2].aabb.GetPerimeter();var newArea=aabb.GetPerimeter();cost2=newArea-oldArea+inheritanceCost;}
if(cost<cost1&&cost<cost2){break;}
if(cost1<cost2){index=child1;}else{index=child2;}}
var sibling=index;var oldParent=this.m_nodes[sibling].parent();var newParent=this.AllocateNode();this.m_nodes[newParent].parent(oldParent);this.m_nodes[newParent].userData=null;this.m_nodes[newParent].aabb.Combine(leafAABB,this.m_nodes[sibling].aabb);this.m_nodes[newParent].height=this.m_nodes[sibling].height+1;if(oldParent!=-1){if(this.m_nodes[oldParent].child1==sibling){this.m_nodes[oldParent].child1=newParent;}else{this.m_nodes[oldParent].child2=newParent;}
this.m_nodes[newParent].child1=sibling;this.m_nodes[newParent].child2=leaf;this.m_nodes[sibling].parent(newParent);this.m_nodes[leaf].parent(newParent);}else{this.m_nodes[newParent].child1=sibling;this.m_nodes[newParent].child2=leaf;this.m_nodes[sibling].parent(newParent);this.m_nodes[leaf].parent(newParent);this.m_root=newParent;}
index=this.m_nodes[leaf].parent();while(index!=-1){index=this.Balance(index);var child1=this.m_nodes[index].child1;var child2=this.m_nodes[index].child2;PhysicsType2d.Assert(child1!=-1);PhysicsType2d.Assert(child2!=-1);this.m_nodes[index].height=1+Math.max(this.m_nodes[child1].height,this.m_nodes[child2].height);this.m_nodes[index].aabb.Combine(this.m_nodes[child1].aabb,this.m_nodes[child2].aabb);index=this.m_nodes[index].parent();}};DynamicTree.prototype.RemoveLeaf=function(leaf){if(leaf==this.m_root){this.m_root=-1;return;}
var parent=this.m_nodes[leaf].parent();var grandParent=this.m_nodes[parent].parent();var sibling;if(this.m_nodes[parent].child1==leaf){sibling=this.m_nodes[parent].child2;}else{sibling=this.m_nodes[parent].child1;}
if(grandParent!=-1){if(this.m_nodes[grandParent].child1==parent){this.m_nodes[grandParent].child1=sibling;}else{this.m_nodes[grandParent].child2=sibling;}
this.m_nodes[sibling].parent(grandParent);this.FreeNode(parent);var index=grandParent;while(index!=-1){index=this.Balance(index);var child1=this.m_nodes[index].child1;var child2=this.m_nodes[index].child2;this.m_nodes[index].aabb.Combine(this.m_nodes[child1].aabb,this.m_nodes[child2].aabb);this.m_nodes[index].height=1+Math.max(this.m_nodes[child1].height,this.m_nodes[child2].height);index=this.m_nodes[index].parent();}}else{this.m_root=sibling;this.m_nodes[sibling].parent(-1);this.FreeNode(parent);}};DynamicTree.prototype.Balance=function(iA){PhysicsType2d.Assert(iA!=-1);var A=this.m_nodes[iA];if(A.IsLeaf()||A.height<2){return iA;}
var iB=A.child1;var iC=A.child2;PhysicsType2d.Assert(0<=iB&&iB<this.m_nodeCapacity);PhysicsType2d.Assert(0<=iC&&iC<this.m_nodeCapacity);var B=this.m_nodes[iB];var C=this.m_nodes[iC];var balance=C.height-B.height;if(balance>1){var iF=C.child1;var iG=C.child2;var F=this.m_nodes[iF];var G=this.m_nodes[iG];PhysicsType2d.Assert(0<=iF&&iF<this.m_nodeCapacity);PhysicsType2d.Assert(0<=iG&&iG<this.m_nodeCapacity);C.child1=iA;C.parent(A.parent());A.parent(iC);if(C.parent()!=-1){if(this.m_nodes[C.parent()].child1==iA){this.m_nodes[C.parent()].child1=iC;}else{PhysicsType2d.Assert(this.m_nodes[C.parent()].child2==iA);this.m_nodes[C.parent()].child2=iC;}}else{this.m_root=iC;}
if(F.height>G.height){C.child2=iF;A.child2=iG;G.parent(iA);A.aabb.Combine(B.aabb,G.aabb);C.aabb.Combine(A.aabb,F.aabb);A.height=1+Math.max(B.height,G.height);C.height=1+Math.max(A.height,F.height);}else{C.child2=iG;A.child2=iF;F.parent(iA);A.aabb.Combine(B.aabb,F.aabb);C.aabb.Combine(A.aabb,G.aabb);A.height=1+Math.max(B.height,F.height);C.height=1+Math.max(A.height,G.height);}
return iC;}
if(balance<-1){var iD=B.child1;var iE=B.child2;var D=this.m_nodes[iD];var E=this.m_nodes[iE];PhysicsType2d.Assert(0<=iD&&iD<this.m_nodeCapacity);PhysicsType2d.Assert(0<=iE&&iE<this.m_nodeCapacity);B.child1=iA;B.parent(A.parent());A.parent(iB);if(B.parent()!=-1){if(this.m_nodes[B.parent()].child1==iA){this.m_nodes[B.parent()].child1=iB;}else{PhysicsType2d.Assert(this.m_nodes[B.parent()].child2==iA);this.m_nodes[B.parent()].child2=iB;}}else{this.m_root=iB;}
if(D.height>E.height){B.child2=iD;A.child1=iE;E.parent(iA);A.aabb.Combine(C.aabb,E.aabb);B.aabb.Combine(A.aabb,D.aabb);A.height=1+Math.max(C.height,E.height);B.height=1+Math.max(A.height,D.height);}else{B.child2=iE;A.child1=iD;D.parent(iA);A.aabb.Combine(C.aabb,D.aabb);B.aabb.Combine(A.aabb,E.aabb);A.height=1+Math.max(C.height,D.height);B.height=1+Math.max(A.height,E.height);}
return iB;}
return iA;};DynamicTree.prototype.ComputeHeight=function(){var height=this.ComputeHeightAtNode(this.m_root);return height;};DynamicTree.prototype.ComputeHeightAtNode=function(nodeId){PhysicsType2d.Assert(0<=nodeId&&nodeId<this.m_nodeCapacity);var node=this.m_nodes[nodeId];if(node.IsLeaf()){return 0;}
var height1=this.ComputeHeightAtNode(node.child1);var height2=this.ComputeHeightAtNode(node.child2);return 1+Math.max(height1,height2);};DynamicTree.prototype.ValidateStructure=function(index){if(index==-1){return;}
if(index==this.m_root){PhysicsType2d.Assert(this.m_nodes[index].parent()==-1);}
var node=this.m_nodes[index];var child1=node.child1;var child2=node.child2;if(node.IsLeaf()){PhysicsType2d.Assert(child1==-1);PhysicsType2d.Assert(child2==-1);PhysicsType2d.Assert(node.height==0);return;}
PhysicsType2d.Assert(0<=child1&&child1<this.m_nodeCapacity);PhysicsType2d.Assert(0<=child2&&child2<this.m_nodeCapacity);PhysicsType2d.Assert(this.m_nodes[child1].parent()==index);PhysicsType2d.Assert(this.m_nodes[child2].parent()==index);this.ValidateStructure(child1);this.ValidateStructure(child2);};DynamicTree.prototype.ValidateMetrics=function(index){if(index==-1){return;}
var node=this.m_nodes[index];var child1=node.child1;var child2=node.child2;if(node.IsLeaf()){PhysicsType2d.Assert(child1==-1);PhysicsType2d.Assert(child2==-1);PhysicsType2d.Assert(node.height==0);return;}
PhysicsType2d.Assert(0<=child1&&child1<this.m_nodeCapacity);PhysicsType2d.Assert(0<=child2&&child2<this.m_nodeCapacity);var height1=this.m_nodes[child1].height;var height2=this.m_nodes[child2].height;var height=1+Math.max(height1,height2);PhysicsType2d.Assert(node.height==height);var aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();aabb.Combine(this.m_nodes[child1].aabb,this.m_nodes[child2].aabb);PhysicsType2d.Assert(aabb.lowerBound==node.aabb.lowerBound);PhysicsType2d.Assert(aabb.upperBound==node.aabb.upperBound);this.ValidateMetrics(child1);this.ValidateMetrics(child2);};return DynamicTree;})();Collision.DynamicTree=DynamicTree;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){var Pair=(function(){function Pair(){this.proxyIdA=0;this.proxyIdB=0;this.next=0;}
Pair.LessThan=function(pair1,pair2){if(pair1.proxyIdA<pair2.proxyIdA){return-1;}
if(pair1.proxyIdA==pair2.proxyIdA){if(pair1.proxyIdB<pair2.proxyIdB){return-1;}else if(pair1.proxyIdB>pair2.proxyIdB){return 1;}else{return 0;}}
return 1;};return Pair;})();Collision.Pair=Pair;(function(BroadPhaseConstants){BroadPhaseConstants[BroadPhaseConstants["NULL_PROXY"]=-1]="NULL_PROXY";})(Collision.BroadPhaseConstants||(Collision.BroadPhaseConstants={}));var BroadPhaseConstants=Collision.BroadPhaseConstants;var BroadPhase=(function(){function BroadPhase(){this.m_proxyCount=0;this.m_tree=new PhysicsType2d.Collision.DynamicTree();this.m_moveBuffer=[];this.m_pairBuffer=[];}
BroadPhase.prototype.CreateProxy=function(aabb,userData){var proxyId=this.m_tree.CreateProxy(aabb,userData);this.m_proxyCount++;this.BufferMove(proxyId);return proxyId;};BroadPhase.prototype.DestroyProxy=function(proxyId){this.m_proxyCount--;this.UnBufferMove(proxyId);this.m_tree.DestroyProxy(proxyId);};BroadPhase.prototype.MoveProxy=function(proxyId,aabb,displacement){var buffer=this.m_tree.MoveProxy(proxyId,aabb,displacement);if(buffer){this.BufferMove(proxyId);}};BroadPhase.prototype.TouchProxy=function(proxyId){this.BufferMove(proxyId);};BroadPhase.prototype.GetFatAABB=function(proxyId){return this.m_tree.GetFatAABB(proxyId);};BroadPhase.prototype.GetUserData=function(proxyId){return this.m_tree.GetUserData(proxyId);};BroadPhase.prototype.TestOverlap=function(proxyIdA,proxyIdB){var aabbA=this.m_tree.GetFatAABB(proxyIdA);var aabbB=this.m_tree.GetFatAABB(proxyIdB);return aabbA.TestOverlap(aabbB);};BroadPhase.prototype.GetProxyCount=function(){return this.m_proxyCount;};BroadPhase.prototype.UpdatePairs=function(callback){this.m_pairBuffer=[];for(var i=0;i<this.m_moveBuffer.length;++i){this.m_queryProxyId=this.m_moveBuffer[i];if(this.m_queryProxyId==-1){continue;}
var fatAABB=this.m_tree.GetFatAABB(this.m_queryProxyId);this.m_tree.Query(this,fatAABB);}
this.m_moveBuffer=[];this.m_pairBuffer=this.m_pairBuffer.sort(Pair.LessThan);var i=0;while(i<this.m_pairBuffer.length){var primaryPair=this.m_pairBuffer[i];var userDataA=this.m_tree.GetUserData(primaryPair.proxyIdA);var userDataB=this.m_tree.GetUserData(primaryPair.proxyIdB);callback.AddPair(userDataA,userDataB);++i;while(i<this.m_pairBuffer.length){var pair=this.m_pairBuffer[i];if(pair.proxyIdA!=primaryPair.proxyIdA||pair.proxyIdB!=primaryPair.proxyIdB){break;}
++i;}}};BroadPhase.prototype.Query=function(callback,aabb){this.m_tree.Query(callback,aabb);};BroadPhase.prototype.RayCast=function(callback,input){this.m_tree.RayCast(callback,input);};BroadPhase.prototype.GetTreeHeight=function(){return this.m_tree.GetHeight();};BroadPhase.prototype.GetTreeBalance=function(){return this.m_tree.GetMaxBalance();};BroadPhase.prototype.GetTreeQuality=function(){return this.m_tree.GetAreaRatio();};BroadPhase.prototype.BufferMove=function(proxyId){this.m_moveBuffer.push(proxyId);};BroadPhase.prototype.UnBufferMove=function(proxyId){for(var i=0;i<this.m_moveBuffer.length;++i){if(this.m_moveBuffer[i]==proxyId){this.m_moveBuffer[i]=-1;return;}}};BroadPhase.prototype.QueryCallback=function(proxyId){if(proxyId==this.m_queryProxyId){return true;}
var pair=new Pair();pair.proxyIdA=Math.min(proxyId,this.m_queryProxyId);pair.proxyIdB=Math.max(proxyId,this.m_queryProxyId);this.m_pairBuffer.push(pair);return true;};return BroadPhase;})();Collision.BroadPhase=BroadPhase;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){(function(Shapes){var MassData=(function(){function MassData(){this.center=new PhysicsType2d.Vector2(0,0);}
return MassData;})();Shapes.MassData=MassData;})(Collision.Shapes||(Collision.Shapes={}));var Shapes=Collision.Shapes;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){(function(Shapes){(function(ShapeType){ShapeType[ShapeType["CIRCLE"]=0]="CIRCLE";ShapeType[ShapeType["EDGE"]=1]="EDGE";ShapeType[ShapeType["POLYGON"]=2]="POLYGON";ShapeType[ShapeType["CHAIN"]=3]="CHAIN";ShapeType[ShapeType["COUNT"]=4]="COUNT";})(Shapes.ShapeType||(Shapes.ShapeType={}));var ShapeType=Shapes.ShapeType;;})(Collision.Shapes||(Collision.Shapes={}));var Shapes=Collision.Shapes;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){(function(Shapes){var CircleShape=(function(){function CircleShape(){this.m_p=new PhysicsType2d.Vector2(0,0);this.m_radius=0.0;}
CircleShape.prototype.GetRadius=function(){return this.m_radius;};CircleShape.prototype.Clone=function(){var clone=new CircleShape();clone.m_p=this.m_p.Clone();clone.m_radius=this.m_radius;return clone;};CircleShape.prototype.GetType=function(){return 0;};CircleShape.prototype.GetChildCount=function(){return 1;};CircleShape.prototype.TestPoint=function(transform,p){var center=transform.p.Add(transform.q.ApplyToVector2(this.m_p));var d=p.Subtract(center);return d.Dot(d)<=this.m_radius*this.m_radius;};CircleShape.prototype.RayCast=function(input,transform,childIndex){var position=transform.p.Add(transform.q.ApplyToVector2(this.m_p));var s=input.p1.Subtract(position);var b=s.Dot(s)-this.m_radius*this.m_radius;var r=input.p2.Subtract(input.p1);var c=s.Dot(r);var rr=r.Dot(r);var sigma=c*c-rr*b;if(sigma<0.0||rr<PhysicsType2d.Constants.EPSILON){return null;}
var a=-(c+Math.sqrt(sigma));if(0.0<=a&&a<=input.maxFraction*rr){a/=rr;var output=new PhysicsType2d.Collision.RayCastOutput();output.fraction=a;output.normal=s.Add(r.Multiply(a));output.normal.Normalize();return output;}
return null;};CircleShape.prototype.ComputeAABB=function(transform,childIndex){var aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();var p=transform.p.Add(transform.q.ApplyToVector2(this.m_p));aabb.lowerBound.Set(p.x-this.m_radius,p.y-this.m_radius);aabb.upperBound.Set(p.x+this.m_radius,p.y+this.m_radius);return aabb;};CircleShape.prototype.ComputeMass=function(density){var massData=new PhysicsType2d.Collision.Shapes.MassData();massData.mass=density*PhysicsType2d.Constants.PI*this.m_radius*this.m_radius;massData.center=this.m_p;massData.I=massData.mass*(0.5*this.m_radius*this.m_radius+this.m_p.Dot(this.m_p));return massData;};CircleShape.prototype.GetSupport=function(d){return 0;};CircleShape.prototype.GetSupportVertex=function(d){return this.m_p;};CircleShape.prototype.GetVertexCount=function(){return 1;};CircleShape.prototype.GetVertex=function(index){PhysicsType2d.Assert(index==0);return this.m_p;};return CircleShape;})();Shapes.CircleShape=CircleShape;})(Collision.Shapes||(Collision.Shapes={}));var Shapes=Collision.Shapes;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){(function(Shapes){var PolygonShape=(function(){function PolygonShape(){this.m_vertices=[];this.m_normals=[];this.m_radius=PhysicsType2d.Settings.polygonRadius;this.m_centroid=new PhysicsType2d.Vector2(0,0);}
PolygonShape.prototype.GetRadius=function(){return this.m_radius;};PolygonShape.prototype.Clone=function(){var clone=new PolygonShape();clone.m_centroid=this.m_centroid.Clone();clone.m_radius=this.m_radius;clone.m_normals=this.m_normals.map(function(value,index,array){return value.Clone();});clone.m_vertices=this.m_vertices.map(function(value,index,array){return value.Clone();});return clone;};PolygonShape.prototype.GetType=function(){return 2;};PolygonShape.prototype.GetChildCount=function(){return 1;};PolygonShape.prototype.TestPoint=function(xf,p){var pLocal=xf.q.ApplyTransposeToVector2(p.Subtract(xf.p));for(var i=0;i<this.m_normals.length;++i){var dot=this.m_normals[i].Dot(pLocal.Subtract(this.m_vertices[i]));if(dot>0.0){return false;}}
return true;};PolygonShape.prototype.RayCast=function(input,xf,childIndex){var p1=xf.q.ApplyTransposeToVector2(input.p1.Subtract(xf.p));var p2=xf.q.ApplyTransposeToVector2(input.p2.Subtract(xf.p));var d=p2.Subtract(p1);var lower=0.0;var upper=input.maxFraction;var index=-1;for(var i=0;i<this.m_normals.length;++i){var numerator=this.m_normals[i].Dot(this.m_vertices[i].Subtract(p1));var denominator=this.m_normals[i].Dot(d);if(denominator==0.0){if(numerator<0.0){return null;}}else{if(denominator<0.0&&numerator<lower*denominator){lower=numerator/denominator;index=i;}else if(denominator>0.0&&numerator<upper*denominator){upper=numerator/denominator;}}
if(upper<lower){return null;}}
PhysicsType2d.Assert(0.0<=lower&&lower<=input.maxFraction);if(index>=0){var output=new PhysicsType2d.Collision.RayCastOutput();output.fraction=lower;output.normal=xf.q.ApplyToVector2(this.m_normals[index]);return output;}
return null;};PolygonShape.prototype.ComputeAABB=function(xf,childIndex){var lower=xf.ApplyToVector2(this.m_vertices[0]);var upper=lower;for(var i=1;i<this.m_vertices.length;++i){var v=xf.ApplyToVector2(this.m_vertices[i]);lower=PhysicsType2d.Vector2.Min(lower,v);upper=PhysicsType2d.Vector2.Max(upper,v);}
var r=new PhysicsType2d.Vector2(this.m_radius,this.m_radius);var aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();aabb.lowerBound=lower.Subtract(r);aabb.upperBound=upper.Add(r);return aabb;};PolygonShape.prototype.ComputeMass=function(density){PhysicsType2d.Assert(this.m_vertices.length>=3);var center=new PhysicsType2d.Vector2(0.0,0.0);var area=0.0;var I=0.0;var s=new PhysicsType2d.Vector2(0.0,0.0);for(var i=0;i<this.m_vertices.length;++i){s=s.Add(this.m_vertices[i]);}
s=s.Multiply(1.0/this.m_vertices.length);var k_inv3=1.0/3.0;for(var i=0;i<this.m_vertices.length;++i){var e1=this.m_vertices[i].Subtract(s);var e2=((i+1)<this.m_vertices.length)?this.m_vertices[i+1].Subtract(s):this.m_vertices[0].Subtract(s);var D=e1.Cross(e2);var triangleArea=0.5*D;area+=triangleArea;center=center.Add((e1.Add(e2)).Multiply(triangleArea*k_inv3));var ex1=e1.x;var ey1=e1.y;var ex2=e2.x;var ey2=e2.y;var intx2=ex1*ex1+ex2*ex1+ex2*ex2;var inty2=ey1*ey1+ey2*ey1+ey2*ey2;I+=(0.25*k_inv3*D)*(intx2+inty2);}
var massData=new PhysicsType2d.Collision.Shapes.MassData();massData.mass=density*area;PhysicsType2d.Assert(area>PhysicsType2d.Constants.EPSILON);center=center.Multiply(1.0/area);massData.center=center.Add(s);massData.I=density*I;massData.I+=massData.mass*(massData.center.Dot(massData.center)-center.Dot(center));return massData;};PolygonShape.prototype.GetVertex=function(index){PhysicsType2d.Assert(0<=index&&index<this.m_vertices.length);return this.m_vertices[index];};PolygonShape.prototype.SetAsBoxAtOrigin=function(hx,hy){this.m_vertices=[];this.m_vertices[0]=new PhysicsType2d.Vector2(-hx,-hy);this.m_vertices[1]=new PhysicsType2d.Vector2(hx,-hy);this.m_vertices[2]=new PhysicsType2d.Vector2(hx,hy);this.m_vertices[3]=new PhysicsType2d.Vector2(-hx,hy);this.m_normals=[];this.m_normals[0]=new PhysicsType2d.Vector2(0.0,-1.0);this.m_normals[1]=new PhysicsType2d.Vector2(1.0,0.0);this.m_normals[2]=new PhysicsType2d.Vector2(0.0,1.0);this.m_normals[3]=new PhysicsType2d.Vector2(-1.0,0.0);this.m_centroid.SetZero();};PolygonShape.prototype.SetAsBox=function(hx,hy,center,angle){this.m_vertices=[];this.m_vertices[0]=new PhysicsType2d.Vector2(-hx,-hy);this.m_vertices[1]=new PhysicsType2d.Vector2(hx,-hy);this.m_vertices[2]=new PhysicsType2d.Vector2(hx,hy);this.m_vertices[3]=new PhysicsType2d.Vector2(-hx,hy);this.m_normals=[];this.m_normals[0]=new PhysicsType2d.Vector2(0.0,-1.0);this.m_normals[1]=new PhysicsType2d.Vector2(1.0,0.0);this.m_normals[2]=new PhysicsType2d.Vector2(0.0,1.0);this.m_normals[3]=new PhysicsType2d.Vector2(-1.0,0.0);this.m_centroid=center;var xf=new PhysicsType2d.Transform();xf.p=center;xf.q.Set(angle);for(var i=0;i<this.m_vertices.length;++i){this.m_vertices[i]=xf.ApplyToVector2(this.m_vertices[i]);this.m_normals[i]=xf.q.ApplyToVector2(this.m_normals[i]);}};PolygonShape.ComputeCentroid=function(vs){PhysicsType2d.Assert(vs.length>=3);var c=new PhysicsType2d.Vector2(0.0,0.0);var area=0.0;var pRef=new PhysicsType2d.Vector2(0.0,0.0);var inv3=1.0/3.0;for(var i=0;i<vs.length;++i){var p1=pRef;var p2=vs[i];var p3=i+1<vs.length?vs[i+1]:vs[0];var e1=p2.Subtract(p1);var e2=p3.Subtract(p1);var D=e1.Cross(e2);var triangleArea=0.5*D;area+=triangleArea;c=c.Add((p1.Add(p2).Add(p3)).Multiply(inv3*triangleArea));}
PhysicsType2d.Assert(area>PhysicsType2d.Constants.EPSILON);c=c.Multiply(1.0/area);return c;};PolygonShape.prototype.Set=function(vertices){PhysicsType2d.Assert(3<=vertices.length&&vertices.length<=PhysicsType2d.Settings.maxPolygonVertices);this.m_vertices=vertices.slice(0);for(var i=0;i<this.m_vertices.length;++i){var i1=i;var i2=(i+1)<this.m_vertices.length?i+1:0;var edge=this.m_vertices[i2].Subtract(this.m_vertices[i1]);PhysicsType2d.Assert(edge.LengthSquared()>PhysicsType2d.Constants.EPSILON*PhysicsType2d.Constants.EPSILON);this.m_normals[i]=PhysicsType2d.MathExtensions.Cross2x1(edge,1.0);this.m_normals[i].Normalize();}
if(PhysicsType2d.Settings.isDebug){for(var i=0;i<this.m_vertices.length;++i){var i1=i;var i2=(i+1)<this.m_vertices.length?i+1:0;var edge=this.m_vertices[i2].Subtract(this.m_vertices[i1]);for(var j=0;j<this.m_vertices.length;++j){if(j==i1||j==i2){continue;}
var r=this.m_vertices[j].Subtract(this.m_vertices[i1]);var s=edge.Cross(r);PhysicsType2d.Assert(s>0.0,"ERROR: Please ensure your polygon is convex and has a CCW winding order");}}}
this.m_centroid=PolygonShape.ComputeCentroid(this.m_vertices);};return PolygonShape;})();Shapes.PolygonShape=PolygonShape;})(Collision.Shapes||(Collision.Shapes={}));var Shapes=Collision.Shapes;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){function CollideCircles(manifold,circleA,xfA,circleB,xfB){manifold.points=[];var pA=xfA.ApplyToVector2(circleA.m_p);var pB=xfB.ApplyToVector2(circleB.m_p);var d=pB.Subtract(pA);var distSqr=d.Dot(d);var rA=circleA.m_radius;var rB=circleB.m_radius;var radius=rA+rB;if(distSqr>radius*radius){return manifold;}
manifold.type=0;manifold.localPoint=circleA.m_p;manifold.localNormal.SetZero();manifold.points[0]=new PhysicsType2d.Collision.ManifoldPoint();manifold.points[0].localPoint=circleB.m_p;manifold.points[0].id.key=0;return manifold;}
Collision.CollideCircles=CollideCircles;function CollidePolygonAndCircle(manifold,polygonA,xfA,circleB,xfB){manifold.points=[];var c=xfB.ApplyToVector2(circleB.m_p);var cLocal=xfA.ApplyTransposeToVector2(c);var normalIndex=0;var separation=-PhysicsType2d.Constants.MAX_FLOAT;var radius=polygonA.m_radius+circleB.m_radius;var vertexCount=polygonA.m_vertices.length;var vertices=polygonA.m_vertices;var normals=polygonA.m_normals;for(var i=0;i<vertexCount;++i){var s=normals[i].Dot(cLocal.Subtract(vertices[i]));if(s>radius){return manifold;}
if(s>separation){separation=s;normalIndex=i;}}
var vertIndex1=normalIndex;var vertIndex2=(vertIndex1+1)<vertexCount?vertIndex1+1:0;var v1=vertices[vertIndex1];var v2=vertices[vertIndex2];if(separation<PhysicsType2d.Constants.EPSILON){manifold.type=1;manifold.localNormal=normals[normalIndex];manifold.localPoint=(v1.Add(v2)).Multiply(0.5);manifold.points[0]=new PhysicsType2d.Collision.ManifoldPoint();manifold.points[0].localPoint=circleB.m_p;manifold.points[0].id.key=0;return manifold;}
var u1=(cLocal.Subtract(v1)).Dot(v2.Subtract(v1));var u2=(cLocal.Subtract(v2)).Dot(v1.Subtract(v2));if(u1<=0.0){if(cLocal.DistanceFromSquared(v1)>radius*radius){return manifold;}
manifold.type=1;manifold.localNormal=cLocal.Subtract(v1);manifold.localNormal.Normalize();manifold.localPoint=v1;manifold.points[0]=new PhysicsType2d.Collision.ManifoldPoint();manifold.points[0].localPoint=circleB.m_p;manifold.points[0].id.key=0;}else if(u2<=0.0){if(cLocal.DistanceFromSquared(v2)>radius*radius){return manifold;}
manifold.type=1;manifold.localNormal=cLocal.Subtract(v2);manifold.localNormal.Normalize();manifold.localPoint=v2;manifold.points[0]=new PhysicsType2d.Collision.ManifoldPoint();manifold.points[0].localPoint=circleB.m_p;manifold.points[0].id.key=0;}else{var faceCenter=(v1.Add(v2)).Multiply(0.5);var separation=(cLocal.Subtract(faceCenter)).Dot(normals[vertIndex1]);if(separation>radius){return manifold;}
manifold.type=1;manifold.localNormal=normals[vertIndex1];manifold.localPoint=faceCenter;manifold.points[0]=new PhysicsType2d.Collision.ManifoldPoint();manifold.points[0].localPoint=circleB.m_p;manifold.points[0].id.key=0;}
return manifold;}
Collision.CollidePolygonAndCircle=CollidePolygonAndCircle;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){(function(Shapes){var EdgeShape=(function(){function EdgeShape(){this.m_vertex1=new PhysicsType2d.Vector2(0,0);this.m_vertex2=new PhysicsType2d.Vector2(0,0);this.m_vertex0=new PhysicsType2d.Vector2(0,0);this.m_vertex3=new PhysicsType2d.Vector2(0,0);this.m_radius=PhysicsType2d.Settings.polygonRadius;this.m_hasVertex0=false;this.m_hasVertex3=false;}
EdgeShape.prototype.GetRadius=function(){return this.m_radius;};EdgeShape.prototype.Clone=function(){var clone=new EdgeShape();clone.m_radius=this.m_radius;clone.m_vertex1=this.m_vertex1.Clone();clone.m_vertex2=this.m_vertex2.Clone();clone.m_vertex0=this.m_vertex0.Clone();clone.m_vertex3=this.m_vertex3.Clone();clone.m_hasVertex0=this.m_hasVertex0;clone.m_hasVertex3=this.m_hasVertex3;return clone;};EdgeShape.prototype.GetType=function(){return 1;};EdgeShape.prototype.GetChildCount=function(){return 1;};EdgeShape.prototype.TestPoint=function(xf,p){return false;};EdgeShape.prototype.RayCast=function(input,xf,childIndex){var p1=xf.q.ApplyTransposeToVector2(input.p1.Subtract(xf.p));var p2=xf.q.ApplyTransposeToVector2(input.p2.Subtract(xf.p));var d=p2.Subtract(p1);var v1=this.m_vertex1;var v2=this.m_vertex2;var e=v2.Subtract(v1);var normal=new PhysicsType2d.Vector2(e.y,-e.x);normal.Normalize();var numerator=normal.Dot(v1.Subtract(p1));var denominator=normal.Dot(d);if(denominator==0.0){return null;}
var t=numerator/denominator;if(t<0.0||input.maxFraction<t){return null;}
var q=p1.Add(d.Multiply(t));var r=v2.Subtract(v1);var rr=r.Dot(r);if(rr==0.0){return null;}
var s=(q.Subtract(v1)).Dot(r)/rr;if(s<0.0||1.0<s){return null;}
var output=new PhysicsType2d.Collision.RayCastOutput();output.fraction=t;if(numerator>0.0){output.normal=normal.Negative();}else{output.normal=normal;}
return output;};EdgeShape.prototype.ComputeAABB=function(xf,childIndex){var aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();var v1=xf.ApplyToVector2(this.m_vertex1);var v2=xf.ApplyToVector2(this.m_vertex2);var lower=PhysicsType2d.Vector2.Min(v1,v2);var upper=PhysicsType2d.Vector2.Max(v1,v2);var r=new PhysicsType2d.Vector2(this.m_radius,this.m_radius);aabb.lowerBound=lower.Subtract(r);aabb.upperBound=upper.Add(r);return aabb;};EdgeShape.prototype.ComputeMass=function(density){var massData=new PhysicsType2d.Collision.Shapes.MassData();massData.mass=0.0;massData.center=(this.m_vertex1.Add(this.m_vertex2)).Multiply(0.5);massData.I=0.0;return massData;};EdgeShape.prototype.Set=function(v1,v2){this.m_vertex1=v1;this.m_vertex2=v2;this.m_hasVertex0=false;this.m_hasVertex3=false;};return EdgeShape;})();Shapes.EdgeShape=EdgeShape;})(Collision.Shapes||(Collision.Shapes={}));var Shapes=Collision.Shapes;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){(function(Shapes){var ChainShape=(function(){function ChainShape(){this.m_prevVertex=new PhysicsType2d.Vector2(0,0);this.m_nextVertex=new PhysicsType2d.Vector2(0,0);this.m_radius=PhysicsType2d.Settings.polygonRadius;this.m_vertices=[];this.m_hasPrevVertex=null;this.m_hasNextVertex=null;}
ChainShape.prototype.Clone=function(){var clone=new ChainShape();clone.m_hasNextVertex=this.m_hasNextVertex;clone.m_hasPrevVertex=this.m_hasPrevVertex;clone.m_nextVertex=this.m_nextVertex.Clone();clone.m_prevVertex=this.m_prevVertex.Clone();clone.m_vertices=this.m_vertices.map(function(value,index,array){return value.Clone();});clone.m_radius=this.m_radius;return clone;};ChainShape.prototype.GetRadius=function(){return this.m_radius;};ChainShape.prototype.GetType=function(){return 3;};ChainShape.prototype.CreateLoop=function(vertices){PhysicsType2d.Assert(this.m_vertices.length==0);PhysicsType2d.Assert(vertices.length>=3);this.m_vertices=vertices.slice(0);this.m_vertices.push(this.m_vertices[0]);this.m_prevVertex=this.m_vertices[this.m_vertices.length-2];this.m_nextVertex=this.m_vertices[1];this.m_hasPrevVertex=true;this.m_hasNextVertex=true;};ChainShape.prototype.CreateChain=function(vertices){PhysicsType2d.Assert(this.m_vertices.length==0);PhysicsType2d.Assert(vertices.length>=2);this.m_vertices=vertices.slice(0);this.m_hasPrevVertex=false;this.m_hasNextVertex=false;};ChainShape.prototype.SetPrevVertex=function(prevVertex){this.m_prevVertex=prevVertex;this.m_hasPrevVertex=true;};ChainShape.prototype.SetNextVertex=function(nextVertex){this.m_nextVertex=nextVertex;this.m_hasNextVertex=true;};ChainShape.prototype.GetChildEdge=function(index){PhysicsType2d.Assert(0<=index&&index<this.m_vertices.length-1);var edge=new PhysicsType2d.Collision.Shapes.EdgeShape();edge.m_radius=this.m_radius;edge.m_vertex1=this.m_vertices[index+0];edge.m_vertex2=this.m_vertices[index+1];if(index>0){edge.m_vertex0=this.m_vertices[index-1];edge.m_hasVertex0=true;}else{edge.m_vertex0=this.m_prevVertex;edge.m_hasVertex0=this.m_hasPrevVertex;}
if(index<this.m_vertices.length-2){edge.m_vertex3=this.m_vertices[index+2];edge.m_hasVertex3=true;}else{edge.m_vertex3=this.m_nextVertex;edge.m_hasVertex3=this.m_hasNextVertex;}
return edge;};ChainShape.prototype.GetChildCount=function(){return this.m_vertices.length-1;};ChainShape.prototype.TestPoint=function(xf,p){return false;};ChainShape.prototype.RayCast=function(input,xf,childIndex){PhysicsType2d.Assert(childIndex<this.m_vertices.length);var edgeShape=new PhysicsType2d.Collision.Shapes.EdgeShape();var i1=childIndex;var i2=childIndex+1;if(i2==this.m_vertices.length){i2=0;}
edgeShape.m_vertex1=this.m_vertices[i1];edgeShape.m_vertex2=this.m_vertices[i2];return edgeShape.RayCast(input,xf,0);};ChainShape.prototype.ComputeAABB=function(xf,childIndex){PhysicsType2d.Assert(childIndex<this.m_vertices.length);var i1=childIndex;var i2=childIndex+1;if(i2==this.m_vertices.length){i2=0;}
var v1=xf.ApplyToVector2(this.m_vertices[i1]);var v2=xf.ApplyToVector2(this.m_vertices[i2]);var aabb=new PhysicsType2d.Collision.AxisAlignedBoundingBox();aabb.lowerBound=PhysicsType2d.Vector2.Min(v1,v2);aabb.upperBound=PhysicsType2d.Vector2.Max(v1,v2);return aabb;};ChainShape.prototype.ComputeMass=function(density){var massData=new PhysicsType2d.Collision.Shapes.MassData();massData.mass=0.0;massData.center.SetZero();massData.I=0.0;return massData;};return ChainShape;})();Shapes.ChainShape=ChainShape;})(Collision.Shapes||(Collision.Shapes={}));var Shapes=Collision.Shapes;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){var DistanceProxy=(function(){function DistanceProxy(){this.m_vertices=null;this.m_radius=0.0;}
DistanceProxy.prototype.Clone=function(){var clone=new DistanceProxy();clone.m_vertices=this.m_vertices.slice(0);clone.m_radius=this.m_radius;return clone;};DistanceProxy.prototype.Set=function(shape,index){this.m_vertices=[];switch(shape.GetType()){case 0:{var circle=shape;this.m_vertices=[circle.m_p];this.m_radius=circle.m_radius;}
break;case 2:{var polygon=shape;this.m_vertices=polygon.m_vertices;this.m_radius=polygon.m_radius;}
break;case 3:{var chain=shape;PhysicsType2d.Assert(0<=index&&index<chain.m_vertices.length);this.m_vertices[0]=chain.m_vertices[index];if(index+1<chain.m_vertices.length){this.m_vertices[1]=chain.m_vertices[index+1];}else{this.m_vertices[1]=chain.m_vertices[0];}
this.m_radius=chain.m_radius;}
break;case 1:{var edge=shape;this.m_vertices=[edge.m_vertex1,edge.m_vertex2];this.m_radius=edge.m_radius;}
break;default:PhysicsType2d.Assert(false);}};DistanceProxy.prototype.GetSupport=function(d){var bestIndex=0;var bestValue=this.m_vertices[0].Dot(d);for(var i=1;i<this.m_vertices.length;++i){var value=this.m_vertices[i].Dot(d);if(value>bestValue){bestIndex=i;bestValue=value;}}
return bestIndex;};DistanceProxy.prototype.GetSupportVertex=function(d){var bestIndex=0;var bestValue=this.m_vertices[0].Dot(d);for(var i=1;i<this.m_vertices.length;++i){var value=this.m_vertices[i].Dot(d);if(value>bestValue){bestIndex=i;bestValue=value;}}
return this.m_vertices[bestIndex];};DistanceProxy.prototype.GetVertexCount=function(){return this.m_vertices.length;};DistanceProxy.prototype.GetVertex=function(index){PhysicsType2d.Assert(0<=index&&index<this.m_vertices.length);return this.m_vertices[index];};return DistanceProxy;})();Collision.DistanceProxy=DistanceProxy;var SimplexCache=(function(){function SimplexCache(){this.metric=0;this.Clear();}
SimplexCache.prototype.Count=function(){return this.index.length;};SimplexCache.prototype.Clear=function(){this.index=[];};SimplexCache.prototype.AddIndices=function(iA,iB){this.index.push({A:iA,B:iB});};SimplexCache.prototype.GetA=function(i){return this.index[i].A;};SimplexCache.prototype.GetB=function(i){return this.index[i].B;};SimplexCache.prototype.Clone=function(){var clone=new SimplexCache();clone.metric=this.metric;clone.index=this.index.slice(0);return clone;};return SimplexCache;})();Collision.SimplexCache=SimplexCache;var DistanceInput=(function(){function DistanceInput(){this.proxyA=new DistanceProxy();this.proxyB=new DistanceProxy();this.transformA=new PhysicsType2d.Transform();this.transformB=new PhysicsType2d.Transform();}
DistanceInput.prototype.Clone=function(){var clone=new DistanceInput();clone.proxyA=this.proxyA.Clone();clone.proxyB=this.proxyB.Clone();clone.transformA=this.transformA.Clone();clone.transformB=this.transformB.Clone();clone.useRadii=this.useRadii;return clone;};return DistanceInput;})();Collision.DistanceInput=DistanceInput;var DistanceOutput=(function(){function DistanceOutput(){this.pointA=new PhysicsType2d.Vector2(0,0);this.pointB=new PhysicsType2d.Vector2(0,0);}
DistanceOutput.prototype.Clone=function(){var clone=new DistanceOutput();clone.pointA=this.pointA.Clone();clone.pointB=this.pointB.Clone();clone.distance=this.distance;clone.iterations=this.iterations;return clone;};return DistanceOutput;})();Collision.DistanceOutput=DistanceOutput;function Distance(cache,input){++gjk.Calls;var proxyA=input.proxyA;var proxyB=input.proxyB;var transformA=input.transformA;var transformB=input.transformB;var simplex=new Simplex();simplex.ReadCache(cache,proxyA,transformA,proxyB,transformB);var vertices=simplex.GetAsArray();var k_maxIters=20;var saveA=[];var saveB=[];var saveCount=0;var closestPoint=simplex.GetClosestPoint();var distanceSqr1=closestPoint.LengthSquared();var distanceSqr2=distanceSqr1;var iter=0;while(iter<k_maxIters){saveCount=simplex.m_count;for(var i=0;i<saveCount;++i){saveA[i]=vertices[i].indexA;saveB[i]=vertices[i].indexB;}
switch(simplex.m_count){case 1:break;case 2:simplex.Solve2();break;case 3:simplex.Solve3();break;default:PhysicsType2d.Assert(false);}
if(simplex.m_count==3){break;}
var p=simplex.GetClosestPoint();distanceSqr2=p.LengthSquared();if(distanceSqr2>=distanceSqr1){}
distanceSqr1=distanceSqr2;var d=simplex.GetSearchDirection();if(d.LengthSquared()<PhysicsType2d.Constants.EPSILON*PhysicsType2d.Constants.EPSILON){break;}
var vertex=vertices[simplex.m_count];vertex.indexA=proxyA.GetSupport(transformA.q.ApplyTransposeToVector2(d.Negative()));vertex.wA=transformA.ApplyToVector2(proxyA.GetVertex(vertex.indexA));vertex.indexB=proxyB.GetSupport(transformB.q.ApplyTransposeToVector2(d));vertex.wB=transformB.ApplyToVector2(proxyB.GetVertex(vertex.indexB));vertex.w=vertex.wB.Subtract(vertex.wA);++iter;++gjk.Iters;var duplicate=false;for(var i=0;i<saveCount;++i){if(vertex.indexA==saveA[i]&&vertex.indexB==saveB[i]){duplicate=true;break;}}
if(duplicate){break;}
++simplex.m_count;}
gjk.MaxIters=Math.max(gjk.MaxIters,iter);var output=new DistanceOutput();var witnessPoints=simplex.GetWitnessPoints();output.pointA=witnessPoints.A;output.pointB=witnessPoints.B;output.distance=output.pointA.DistanceFrom(output.pointB);output.iterations=iter;simplex.WriteCache(cache);if(input.useRadii){var rA=proxyA.m_radius;var rB=proxyB.m_radius;if(output.distance>rA+rB&&output.distance>PhysicsType2d.Constants.EPSILON){output.distance-=rA+rB;var normal=output.pointB.Subtract(output.pointA);normal.Normalize();output.pointA=output.pointA.Add(normal.Multiply(rA));output.pointB=output.pointB.Subtract(normal.Multiply(rB));}else{var p=(output.pointA.Add(output.pointB)).Multiply(0.5);output.pointA=p;output.pointB=p;output.distance=0.0;}}
return output;}
Collision.Distance=Distance;var gjk=(function(){function gjk(){}
gjk.Calls=0;gjk.Iters=0;gjk.MaxIters=0;return gjk;})();Collision.gjk=gjk;var SimplexVertex=(function(){function SimplexVertex(){this.wA=new PhysicsType2d.Vector2(0,0);this.wB=new PhysicsType2d.Vector2(0,0);this.w=new PhysicsType2d.Vector2(0,0);this.a=0;this.indexA=0;this.indexB=0;}
SimplexVertex.prototype.Clone=function(){var clone=new SimplexVertex();clone.wA=this.wA.Clone();clone.wB=this.wB.Clone();clone.w=this.w.Clone();clone.a=this.a;clone.indexA=this.indexA;clone.indexB=this.indexB;return clone;};return SimplexVertex;})();var Simplex=(function(){function Simplex(){this.m_v1=new SimplexVertex();this.m_v2=new SimplexVertex();this.m_v3=new SimplexVertex();this.m_count=0;}
Simplex.prototype.Clone=function(){var clone=new Simplex();clone.m_v1=this.m_v1.Clone();clone.m_v2=this.m_v2.Clone();clone.m_v3=this.m_v3.Clone();clone.m_count=this.m_count;return clone;};Simplex.prototype.GetAsArray=function(){return[this.m_v1,this.m_v2,this.m_v3];};Simplex.prototype.Set=function(i,vertex){switch(i){case 0:this.m_v1=vertex;break;case 1:this.m_v2=vertex;break;case 2:this.m_v3=vertex;break;default:PhysicsType2d.Assert(false,"Index does not exist for SimplexCache.");}};Simplex.prototype.SetFromArray=function(vertices){this.m_v1=vertices[0];this.m_v2=vertices[1];this.m_v3=vertices[2];};Simplex.prototype.ReadCache=function(cache,proxyA,transformA,proxyB,transformB){PhysicsType2d.Assert(cache.Count()<=3);this.m_count=cache.Count();var vertices=this.GetAsArray();for(var i=0;i<this.m_count;++i){var v=vertices[i];v.indexA=cache.GetA(i);v.indexB=cache.GetB(i);var wALocal=proxyA.GetVertex(v.indexA);var wBLocal=proxyB.GetVertex(v.indexB);v.wA=transformA.ApplyToVector2(wALocal);v.wB=transformB.ApplyToVector2(wBLocal);v.w=v.wB.Subtract(v.wA);v.a=0.0;}
if(this.m_count>1){var metric1=cache.metric;var metric2=this.GetMetric();if(metric2<0.5*metric1||2.0*metric1<metric2||metric2<PhysicsType2d.Constants.EPSILON){this.m_count=0;}}
if(this.m_count==0){var v=vertices[0];v.indexA=0;v.indexB=0;var wALocal=proxyA.GetVertex(0);var wBLocal=proxyB.GetVertex(0);v.wA=transformA.ApplyToVector2(wALocal);v.wB=transformB.ApplyToVector2(wBLocal);v.w=v.wB.Subtract(v.wA);this.m_count=1;}
this.SetFromArray(vertices);};Simplex.prototype.WriteCache=function(cache){cache.metric=this.GetMetric();var vertices=this.GetAsArray();cache.Clear();for(var i=0;i<this.m_count;++i){cache.AddIndices(vertices[i].indexA,vertices[i].indexB);}};Simplex.prototype.GetSearchDirection=function(){switch(this.m_count){case 1:return this.m_v1.w.Negative();case 2:{var e12=this.m_v2.w.Subtract(this.m_v1.w);var sgn=e12.Cross(this.m_v1.w.Negative());if(sgn>0.0){return PhysicsType2d.MathExtensions.Cross1x2(1.0,e12);}else{return PhysicsType2d.MathExtensions.Cross2x1(e12,1.0);}}
default:PhysicsType2d.Assert(false);return PhysicsType2d.Vector2.Zero();}};Simplex.prototype.GetClosestPoint=function(){switch(this.m_count){case 0:PhysicsType2d.Assert(false);return PhysicsType2d.Vector2.Zero();case 1:return this.m_v1.w;case 2:return(this.m_v1.w.Multiply(this.m_v1.a)).Add(this.m_v2.w.Multiply(this.m_v2.a));case 3:return PhysicsType2d.Vector2.Zero();default:PhysicsType2d.Assert(false);return PhysicsType2d.Vector2.Zero();}};Simplex.prototype.GetWitnessPoints=function(){var p;switch(this.m_count){case 0:PhysicsType2d.Assert(false);break;case 1:p={A:this.m_v1.wA,B:this.m_v1.wB};break;case 2:p={A:(this.m_v1.wA.Multiply(this.m_v1.a)).Add(this.m_v2.wA.Multiply(this.m_v2.a)),B:(this.m_v1.wB.Multiply(this.m_v1.a)).Add(this.m_v2.wB.Multiply(this.m_v2.a))};break;case 3:var a=(this.m_v1.wA.Multiply(this.m_v1.a)).Add(this.m_v2.wA.Multiply(this.m_v2.a)).Add(this.m_v3.wA.Multiply(this.m_v3.a));p={A:a,B:a};break;default:PhysicsType2d.Assert(false);break;}
return p;};Simplex.prototype.GetMetric=function(){switch(this.m_count){case 0:PhysicsType2d.Assert(false);return 0.0;case 1:return 0.0;case 2:return this.m_v1.w.DistanceFrom(this.m_v2.w);case 3:return(this.m_v2.w.Subtract(this.m_v1.w)).Cross(this.m_v3.w.Subtract(this.m_v1.w));default:PhysicsType2d.Assert(false);return 0.0;}};Simplex.prototype.Solve2=function(){var w1=this.m_v1.w;var w2=this.m_v2.w;var e12=w2.Subtract(w1);var d12_2=-w1.Dot(e12);if(d12_2<=0.0){this.m_v1.a=1.0;this.m_count=1;return;}
var d12_1=w2.Dot(e12);if(d12_1<=0.0){this.m_v2.a=1.0;this.m_count=1;this.m_v1=this.m_v2.Clone();return;}
var inv_d12=1.0/(d12_1+d12_2);this.m_v1.a=d12_1*inv_d12;this.m_v2.a=d12_2*inv_d12;this.m_count=2;};Simplex.prototype.Solve3=function(){var w1=this.m_v1.w;var w2=this.m_v2.w;var w3=this.m_v3.w;var e12=w2.Subtract(w1);var w1e12=w1.Dot(e12);var w2e12=w2.Dot(e12);var d12_1=w2e12;var d12_2=-w1e12;var e13=w3.Subtract(w1);var w1e13=w1.Dot(e13);var w3e13=w3.Dot(e13);var d13_1=w3e13;var d13_2=-w1e13;var e23=w3.Subtract(w2);var w2e23=w2.Dot(e23);var w3e23=w3.Dot(e23);var d23_1=w3e23;var d23_2=-w2e23;var n123=e12.Cross(e13);var d123_1=n123*w2.Cross(w3);var d123_2=n123*w3.Cross(w1);var d123_3=n123*w1.Cross(w2);if(d12_2<=0.0&&d13_2<=0.0){this.m_v1.a=1.0;this.m_count=1;return;}
if(d12_1>0.0&&d12_2>0.0&&d123_3<=0.0){var inv_d12=1.0/(d12_1+d12_2);this.m_v1.a=d12_1*inv_d12;this.m_v2.a=d12_2*inv_d12;this.m_count=2;return;}
if(d13_1>0.0&&d13_2>0.0&&d123_2<=0.0){var inv_d13=1.0/(d13_1+d13_2);this.m_v1.a=d13_1*inv_d13;this.m_v3.a=d13_2*inv_d13;this.m_count=2;this.m_v2=this.m_v3.Clone();return;}
if(d12_1<=0.0&&d23_2<=0.0){this.m_v2.a=1.0;this.m_count=1;this.m_v1=this.m_v2.Clone();return;}
if(d13_1<=0.0&&d23_1<=0.0){this.m_v3.a=1.0;this.m_count=1;this.m_v1=this.m_v3.Clone();return;}
if(d23_1>0.0&&d23_2>0.0&&d123_1<=0.0){var inv_d23=1.0/(d23_1+d23_2);this.m_v2.a=d23_1*inv_d23;this.m_v3.a=d23_2*inv_d23;this.m_count=2;this.m_v1=this.m_v3.Clone();return;}
var inv_d123=1.0/(d123_1+d123_2+d123_3);this.m_v1.a=d123_1*inv_d123;this.m_v2.a=d123_2*inv_d123;this.m_v3.a=d123_3*inv_d123;this.m_count=3;};return Simplex;})();})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){(function(PointState){PointState[PointState["NULL"]=0]="NULL";PointState[PointState["ADD"]=1]="ADD";PointState[PointState["PERSIST"]=2]="PERSIST";PointState[PointState["REMOVE"]=3]="REMOVE";})(Collision.PointState||(Collision.PointState={}));var PointState=Collision.PointState;function GetPointStates(manifold1,manifold2){var transition={state1:PhysicsType2d.Utils.AllocateArray(PhysicsType2d.Settings.maxManifoldPoints,function(){return 0;}),state2:PhysicsType2d.Utils.AllocateArray(PhysicsType2d.Settings.maxManifoldPoints,function(){return 0;})};for(var i=0;i<manifold1.points.length;++i){var id=manifold1.points[i].id;transition.state1[i]=3;for(var j=0;j<manifold2.points.length;++j){if(manifold2.points[j].id.key==id.key){transition.state1[i]=2;break;}}}
for(var i=0;i<manifold2.points.length;++i){var id=manifold2.points[i].id;transition.state2[i]=1;for(var j=0;j<manifold1.points.length;++j){if(manifold1.points[j].id.key==id.key){transition.state2[i]=2;break;}}}
return transition;}
Collision.GetPointStates=GetPointStates;function ClipSegmentToLine(vIn,normal,offset,vertexIndexA){var vOut=[];var distance0=normal.Dot(vIn[0].v)-offset;var distance1=normal.Dot(vIn[1].v)-offset;if(distance0<=0.0){vOut.push(vIn[0]);}
if(distance1<=0.0){vOut.push(vIn[1]);}
if(distance0*distance1<0.0){var interp=distance0/(distance0-distance1);var vertex=new PhysicsType2d.Collision.ClipVertex();vertex.v=vIn[0].v.Add((vIn[1].v.Subtract(vIn[0].v)).Multiply(interp));vertex.id.cf.indexA=vertexIndexA;vertex.id.cf.indexB=vIn[0].id.cf.indexB;vertex.id.cf.typeA=0;vertex.id.cf.typeB=1;vOut.push(vertex);}
return vOut;}
Collision.ClipSegmentToLine=ClipSegmentToLine;function TestOverlap(shapeA,indexA,shapeB,indexB,xfA,xfB){var input=new PhysicsType2d.Collision.DistanceInput();input.proxyA.Set(shapeA,indexA);input.proxyB.Set(shapeB,indexB);input.transformA=xfA;input.transformB=xfB;input.useRadii=true;var cache=new PhysicsType2d.Collision.SimplexCache();var output=PhysicsType2d.Collision.Distance(cache,input);return output.distance<10.0*PhysicsType2d.Constants.EPSILON;}
Collision.TestOverlap=TestOverlap;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){function CollideEdgeAndCircle(manifold,edgeA,xfA,circleB,xfB){manifold.points=[];var Q=xfA.ApplyTransposeToVector2(xfB.ApplyToVector2(circleB.m_p));var A=edgeA.m_vertex1;var B=edgeA.m_vertex2;var e=B.Subtract(A);var u=PhysicsType2d.MathExtensions.Dot(e,B.Subtract(Q));var v=PhysicsType2d.MathExtensions.Dot(e,Q.Subtract(A));var radius=edgeA.m_radius+circleB.m_radius;var cf=new PhysicsType2d.Collision.ContactFeature();cf.indexB=0;cf.typeB=0;if(v<=0.0){var P=A;var d=Q.Subtract(P);var dd=PhysicsType2d.MathExtensions.Dot(d,d);if(dd>radius*radius){return manifold;}
if(edgeA.m_hasVertex0){var A1=edgeA.m_vertex0;var B1=A;var e1=B1.Subtract(A1);var u1=PhysicsType2d.MathExtensions.Dot(e1,B1.Subtract(Q));if(u1>0.0){return manifold;}}
cf.indexA=0;cf.typeA=0;manifold.type=0;manifold.localNormal.SetZero();manifold.localPoint=P;manifold.points[0]=new PhysicsType2d.Collision.ManifoldPoint();manifold.points[0].id.key=0;manifold.points[0].id.cf=cf;manifold.points[0].localPoint=circleB.m_p;return manifold;}
if(u<=0.0){var P=B;var d=Q.Subtract(P);var dd=PhysicsType2d.MathExtensions.Dot(d,d);if(dd>radius*radius){return manifold;}
if(edgeA.m_hasVertex3){var B2=edgeA.m_vertex3;var A2=B;var e2=B2.Subtract(A2);var v2=PhysicsType2d.MathExtensions.Dot(e2,Q.Subtract(A2));if(v2>0.0){return manifold;}}
cf.indexA=1;cf.typeA=0;manifold.type=0;manifold.localNormal.SetZero();manifold.localPoint=P;manifold.points[0]=new PhysicsType2d.Collision.ManifoldPoint();manifold.points[0].id.key=0;manifold.points[0].id.cf=cf;manifold.points[0].localPoint=circleB.m_p;return manifold;}
var den=PhysicsType2d.MathExtensions.Dot(e,e);PhysicsType2d.Assert(den>0.0);var P=((A.Multiply(u)).Add(B.Multiply(v))).Multiply(1.0/den);var d=Q.Subtract(P);var dd=PhysicsType2d.MathExtensions.Dot(d,d);if(dd>radius*radius){return manifold;}
var n=new PhysicsType2d.Vector2(-e.y,e.x);if(PhysicsType2d.MathExtensions.Dot(n,Q.Subtract(A))<0.0){n.Set(-n.x,-n.y);}
n.Normalize();cf.indexA=0;cf.typeA=1;manifold.type=1;manifold.localNormal=n;manifold.localPoint=A;manifold.points[0]=new PhysicsType2d.Collision.ManifoldPoint();manifold.points[0].id.key=0;manifold.points[0].id.cf=cf;manifold.points[0].localPoint=circleB.m_p;return manifold;}
Collision.CollideEdgeAndCircle=CollideEdgeAndCircle;var AxisType;(function(AxisType){AxisType[AxisType["UNKNOWN"]=0]="UNKNOWN";AxisType[AxisType["EDGE_A"]=1]="EDGE_A";AxisType[AxisType["EDGE_B"]=2]="EDGE_B";})(AxisType||(AxisType={}));;var EPAxis=(function(){function EPAxis(){}
return EPAxis;})();var TempPolygon=(function(){function TempPolygon(){this.vertices=[];this.normals=[];}
return TempPolygon;})();var ReferenceFace=(function(){function ReferenceFace(){this.v1=new PhysicsType2d.Vector2(0,0);this.v2=new PhysicsType2d.Vector2(0,0);this.normal=new PhysicsType2d.Vector2(0,0);this.sideNormal1=new PhysicsType2d.Vector2(0,0);this.sideNormal2=new PhysicsType2d.Vector2(0,0);}
return ReferenceFace;})();var EPCollider=(function(){function EPCollider(){this.m_polygonB=new TempPolygon();this.m_xf=new PhysicsType2d.Transform();this.m_centroidB=new PhysicsType2d.Vector2(0,0);this.m_v0=new PhysicsType2d.Vector2(0,0);this.m_v1=new PhysicsType2d.Vector2(0,0);this.m_v2=new PhysicsType2d.Vector2(0,0);this.m_v3=new PhysicsType2d.Vector2(0,0);this.m_normal0=new PhysicsType2d.Vector2(0,0);this.m_normal1=new PhysicsType2d.Vector2(0,0);this.m_normal2=new PhysicsType2d.Vector2(0,0);this.m_normal=new PhysicsType2d.Vector2(0,0);this.m_lowerLimit=new PhysicsType2d.Vector2(0,0);this.m_upperLimit=new PhysicsType2d.Vector2(0,0);}
EPCollider.prototype.Collide=function(manifold,edgeA,xfA,polygonB,xfB){this.m_xf=xfA.MultiplyTranspose(xfB);this.m_centroidB=this.m_xf.ApplyToVector2(polygonB.m_centroid);this.m_v0=edgeA.m_vertex0;this.m_v1=edgeA.m_vertex1;this.m_v2=edgeA.m_vertex2;this.m_v3=edgeA.m_vertex3;var hasVertex0=edgeA.m_hasVertex0;var hasVertex3=edgeA.m_hasVertex3;var edge1=this.m_v2.Subtract(this.m_v1);edge1.Normalize();this.m_normal1.Set(edge1.y,-edge1.x);var offset1=PhysicsType2d.MathExtensions.Dot(this.m_normal1,this.m_centroidB.Subtract(this.m_v1));var offset0=0.0,offset2=0.0;var convex1=false,convex2=false;if(hasVertex0){var edge0=this.m_v1.Subtract(this.m_v0);edge0.Normalize();this.m_normal0.Set(edge0.y,-edge0.x);convex1=PhysicsType2d.MathExtensions.Cross2x2(edge0,edge1)>=0.0;offset0=PhysicsType2d.MathExtensions.Dot(this.m_normal0,this.m_centroidB.Subtract(this.m_v0));}
if(hasVertex3){var edge2=this.m_v3.Subtract(this.m_v2);edge2.Normalize();this.m_normal2.Set(edge2.y,-edge2.x);convex2=PhysicsType2d.MathExtensions.Cross2x2(edge1,edge2)>0.0;offset2=PhysicsType2d.MathExtensions.Dot(this.m_normal2,this.m_centroidB.Subtract(this.m_v2));}
if(hasVertex0&&hasVertex3){if(convex1&&convex2){this.m_front=offset0>=0.0||offset1>=0.0||offset2>=0.0;if(this.m_front){this.m_normal=this.m_normal1;this.m_lowerLimit=this.m_normal0;this.m_upperLimit=this.m_normal2;}else{this.m_normal=this.m_normal1.Negative();this.m_lowerLimit=this.m_normal1.Negative();this.m_upperLimit=this.m_normal1.Negative();}}else if(convex1){this.m_front=offset0>=0.0||(offset1>=0.0&&offset2>=0.0);if(this.m_front){this.m_normal=this.m_normal1;this.m_lowerLimit=this.m_normal0;this.m_upperLimit=this.m_normal1;}else{this.m_normal=this.m_normal1.Negative();this.m_lowerLimit=this.m_normal2.Negative();this.m_upperLimit=this.m_normal1.Negative();}}else if(convex2){this.m_front=offset2>=0.0||(offset0>=0.0&&offset1>=0.0);if(this.m_front){this.m_normal=this.m_normal1;this.m_lowerLimit=this.m_normal1;this.m_upperLimit=this.m_normal2;}else{this.m_normal=this.m_normal1.Negative();this.m_lowerLimit=this.m_normal1.Negative();this.m_upperLimit=this.m_normal0.Negative();}}else{this.m_front=offset0>=0.0&&offset1>=0.0&&offset2>=0.0;if(this.m_front){this.m_normal=this.m_normal1;this.m_lowerLimit=this.m_normal1;this.m_upperLimit=this.m_normal1;}else{this.m_normal=this.m_normal1.Negative();this.m_lowerLimit=this.m_normal2.Negative();this.m_upperLimit=this.m_normal0.Negative();}}}else if(hasVertex0){if(convex1){this.m_front=offset0>=0.0||offset1>=0.0;if(this.m_front){this.m_normal=this.m_normal1;this.m_lowerLimit=this.m_normal0;this.m_upperLimit=this.m_normal1.Negative();}else{this.m_normal=this.m_normal1.Negative();this.m_lowerLimit=this.m_normal1;this.m_upperLimit=this.m_normal1.Negative();}}else{this.m_front=offset0>=0.0&&offset1>=0.0;if(this.m_front){this.m_normal=this.m_normal1;this.m_lowerLimit=this.m_normal1;this.m_upperLimit=this.m_normal1.Negative();}else{this.m_normal=this.m_normal1.Negative();this.m_lowerLimit=this.m_normal1;this.m_upperLimit=this.m_normal0.Negative();}}}else if(hasVertex3){if(convex2){this.m_front=offset1>=0.0||offset2>=0.0;if(this.m_front){this.m_normal=this.m_normal1;this.m_lowerLimit=this.m_normal1.Negative();this.m_upperLimit=this.m_normal2;}else{this.m_normal=this.m_normal1.Negative();this.m_lowerLimit=this.m_normal1.Negative();this.m_upperLimit=this.m_normal1;}}else{this.m_front=offset1>=0.0&&offset2>=0.0;if(this.m_front){this.m_normal=this.m_normal1;this.m_lowerLimit=this.m_normal1.Negative();this.m_upperLimit=this.m_normal1;}else{this.m_normal=this.m_normal1.Negative();this.m_lowerLimit=this.m_normal2.Negative();this.m_upperLimit=this.m_normal1;}}}else{this.m_front=offset1>=0.0;if(this.m_front){this.m_normal=this.m_normal1;this.m_lowerLimit=this.m_normal1.Negative();this.m_upperLimit=this.m_normal1.Negative();}else{this.m_normal=this.m_normal1.Negative();this.m_lowerLimit=this.m_normal1;this.m_upperLimit=this.m_normal1;}}
this.m_polygonB.vertices=new Array(polygonB.m_vertices.length);for(var i=0;i<polygonB.m_vertices.length;++i){this.m_polygonB.vertices[i]=this.m_xf.ApplyToVector2(polygonB.m_vertices[i]);this.m_polygonB.normals[i]=this.m_xf.q.ApplyToVector2(polygonB.m_normals[i]);}
this.m_radius=2.0*PhysicsType2d.Settings.polygonRadius;manifold.points=[];var edgeAxis=this.ComputeEdgeSeparation();if(edgeAxis.type==0){return manifold;}
if(edgeAxis.separation>this.m_radius){return manifold;}
var polygonAxis=this.ComputePolygonSeparation();if(polygonAxis.type!=0&&polygonAxis.separation>this.m_radius){return manifold;}
var k_relativeTol=0.98;var k_absoluteTol=0.001;var primaryAxis;if(polygonAxis.type==0){primaryAxis=edgeAxis;}else if(polygonAxis.separation>k_relativeTol*edgeAxis.separation+k_absoluteTol){primaryAxis=polygonAxis;}else{primaryAxis=edgeAxis;}
var ie=[];var rf=new ReferenceFace();if(primaryAxis.type==1){manifold.type=1;var bestIndex=0;var bestValue=PhysicsType2d.MathExtensions.Dot(this.m_normal,this.m_polygonB.normals[0]);for(var i=1;i<this.m_polygonB.normals.length;++i){var value=PhysicsType2d.MathExtensions.Dot(this.m_normal,this.m_polygonB.normals[i]);if(value<bestValue){bestValue=value;bestIndex=i;}}
var i1=bestIndex;var i2=i1+1<this.m_polygonB.vertices.length?i1+1:0;ie[0]=new PhysicsType2d.Collision.ClipVertex();ie[0].v=this.m_polygonB.vertices[i1];ie[0].id.cf.indexA=0;ie[0].id.cf.indexB=i1;ie[0].id.cf.typeA=1;ie[0].id.cf.typeB=0;ie[1]=new PhysicsType2d.Collision.ClipVertex();ie[1].v=this.m_polygonB.vertices[i2];ie[1].id.cf.indexA=0;ie[1].id.cf.indexB=i2;ie[1].id.cf.typeA=1;ie[1].id.cf.typeB=0;if(this.m_front){rf.i1=0;rf.i2=1;rf.v1=this.m_v1;rf.v2=this.m_v2;rf.normal=this.m_normal1;}else{rf.i1=1;rf.i2=0;rf.v1=this.m_v2;rf.v2=this.m_v1;rf.normal=this.m_normal1.Negative();}}else{manifold.type=2;ie[0]=new PhysicsType2d.Collision.ClipVertex();ie[0].v=this.m_v1;ie[0].id.cf.indexA=0;ie[0].id.cf.indexB=primaryAxis.index;ie[0].id.cf.typeA=0;ie[0].id.cf.typeB=1;ie[1]=new PhysicsType2d.Collision.ClipVertex();ie[1].v=this.m_v2;ie[1].id.cf.indexA=0;ie[1].id.cf.indexB=primaryAxis.index;ie[1].id.cf.typeA=0;ie[1].id.cf.typeB=1;rf.i1=primaryAxis.index;rf.i2=rf.i1+1<this.m_polygonB.vertices.length?rf.i1+1:0;rf.v1=this.m_polygonB.vertices[rf.i1];rf.v2=this.m_polygonB.vertices[rf.i2];rf.normal=this.m_polygonB.normals[rf.i1];}
rf.sideNormal1.Set(rf.normal.y,-rf.normal.x);rf.sideNormal2=rf.sideNormal1.Negative();rf.sideOffset1=PhysicsType2d.MathExtensions.Dot(rf.sideNormal1,rf.v1);rf.sideOffset2=PhysicsType2d.MathExtensions.Dot(rf.sideNormal2,rf.v2);var clipPoints1=PhysicsType2d.Collision.ClipSegmentToLine(ie,rf.sideNormal1,rf.sideOffset1,rf.i1);if(clipPoints1.length<PhysicsType2d.Settings.maxManifoldPoints){return manifold;}
var clipPoints2=PhysicsType2d.Collision.ClipSegmentToLine(clipPoints1,rf.sideNormal2,rf.sideOffset2,rf.i2);if(clipPoints2.length<PhysicsType2d.Settings.maxManifoldPoints){return manifold;}
if(primaryAxis.type==1){manifold.localNormal=rf.normal;manifold.localPoint=rf.v1;}else{manifold.localNormal=polygonB.m_normals[rf.i1];manifold.localPoint=polygonB.m_vertices[rf.i1];}
manifold.points=[];for(var i=0;i<clipPoints2.length;++i){var separation=PhysicsType2d.MathExtensions.Dot(rf.normal,clipPoints2[i].v.Subtract(rf.v1));if(separation<=this.m_radius){var cp=new PhysicsType2d.Collision.ManifoldPoint();if(primaryAxis.type==1){cp.localPoint=this.m_xf.ApplyTransposeToVector2(clipPoints2[i].v);cp.id=clipPoints2[i].id;}else{cp.localPoint=clipPoints2[i].v;cp.id.cf.typeA=clipPoints2[i].id.cf.typeB;cp.id.cf.typeB=clipPoints2[i].id.cf.typeA;cp.id.cf.indexA=clipPoints2[i].id.cf.indexB;cp.id.cf.indexB=clipPoints2[i].id.cf.indexA;}
manifold.points.push(cp);}}
return manifold;};EPCollider.prototype.ComputeEdgeSeparation=function(){var axis=new EPAxis();axis.type=1;axis.index=this.m_front?0:1;axis.separation=PhysicsType2d.Constants.MAX_FLOAT;for(var i=0;i<this.m_polygonB.vertices.length;++i){var s=PhysicsType2d.MathExtensions.Dot(this.m_normal,this.m_polygonB.vertices[i].Subtract(this.m_v1));if(s<axis.separation){axis.separation=s;}}
return axis;};EPCollider.prototype.ComputePolygonSeparation=function(){var axis=new EPAxis();axis.type=0;axis.index=-1;axis.separation=-PhysicsType2d.Constants.MAX_FLOAT;var perp=new PhysicsType2d.Vector2(-this.m_normal.y,this.m_normal.x);for(var i=0;i<this.m_polygonB.vertices.length;++i){var n=this.m_polygonB.normals[i].Negative();var s1=PhysicsType2d.MathExtensions.Dot(n,this.m_polygonB.vertices[i].Subtract(this.m_v1));var s2=PhysicsType2d.MathExtensions.Dot(n,this.m_polygonB.vertices[i].Subtract(this.m_v2));var s=Math.min(s1,s2);if(s>this.m_radius){axis.type=2;axis.index=i;axis.separation=s;return axis;}
if(PhysicsType2d.MathExtensions.Dot(n,perp)>=0.0){if(PhysicsType2d.MathExtensions.Dot(n.Subtract(this.m_upperLimit),this.m_normal)<-PhysicsType2d.Settings.angularSlop){continue;}}else{if(PhysicsType2d.MathExtensions.Dot(n.Subtract(this.m_lowerLimit),this.m_normal)<-PhysicsType2d.Settings.angularSlop){continue;}}
if(s>axis.separation){axis.type=2;axis.index=i;axis.separation=s;}}
return axis;};return EPCollider;})();var EPColliderVertexType;(function(EPColliderVertexType){EPColliderVertexType[EPColliderVertexType["ISOLATED"]=0]="ISOLATED";EPColliderVertexType[EPColliderVertexType["CONCAVE"]=1]="CONCAVE";EPColliderVertexType[EPColliderVertexType["CONVEX"]=2]="CONVEX";})(EPColliderVertexType||(EPColliderVertexType={}));function CollideEdgeAndPolygon(manifold,edgeA,xfA,polygonB,xfB){var collider=new EPCollider();return collider.Collide(manifold,edgeA,xfA,polygonB,xfB);}
Collision.CollideEdgeAndPolygon=CollideEdgeAndPolygon;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){function EdgeSeparation(poly1,xf1,edge1,poly2,xf2){var vertices1=poly1.m_vertices;var normals1=poly1.m_normals;var count2=poly2.m_vertices.length;var vertices2=poly2.m_vertices;PhysicsType2d.Assert(0<=edge1&&edge1<poly1.m_vertices.length);var normal1World=xf1.q.ApplyToVector2(normals1[edge1]);var normal1=xf2.q.ApplyTransposeToVector2(normal1World);var index=0;var minDot=PhysicsType2d.Constants.MAX_FLOAT;for(var i=0;i<count2;++i){var dot=PhysicsType2d.MathExtensions.Dot(vertices2[i],normal1);if(dot<minDot){minDot=dot;index=i;}}
var v1=xf1.ApplyToVector2(vertices1[edge1]);var v2=xf2.ApplyToVector2(vertices2[index]);return PhysicsType2d.MathExtensions.Dot(v2.Subtract(v1),normal1World);}
function FindMaxSeparation(poly1,xf1,poly2,xf2){var count1=poly1.m_vertices.length;var normals1=poly1.m_normals;var d=(xf2.ApplyToVector2(poly2.m_centroid)).Subtract(xf1.ApplyToVector2(poly1.m_centroid));var dLocal1=xf1.q.ApplyTransposeToVector2(d);var edge=0;var maxDot=-PhysicsType2d.Constants.MAX_FLOAT;for(var i=0;i<count1;++i){var dot=PhysicsType2d.MathExtensions.Dot(normals1[i],dLocal1);if(dot>maxDot){maxDot=dot;edge=i;}}
var s=EdgeSeparation(poly1,xf1,edge,poly2,xf2);var prevEdge=(edge-1)>=0?edge-1:count1-1;var sPrev=EdgeSeparation(poly1,xf1,prevEdge,poly2,xf2);var nextEdge=(edge+1)<count1?edge+1:0;var sNext=EdgeSeparation(poly1,xf1,nextEdge,poly2,xf2);var bestEdge;var bestSeparation;var increment;if(sPrev>s&&sPrev>sNext){increment=-1;bestEdge=prevEdge;bestSeparation=sPrev;}else if(sNext>s){increment=1;bestEdge=nextEdge;bestSeparation=sNext;}else{var sep={index:edge,separation:s};return sep;}
for(;;){if(increment==-1)
edge=(bestEdge-1)>=0?bestEdge-1:count1-1;else
edge=(bestEdge+1)<count1?bestEdge+1:0;s=EdgeSeparation(poly1,xf1,edge,poly2,xf2);if(s>bestSeparation){bestEdge=edge;bestSeparation=s;}else{break;}}
var sep={index:bestEdge,separation:bestSeparation};return sep;}
function FindIncidentEdge(poly1,xf1,edge1,poly2,xf2){var normals1=poly1.m_normals;var count2=poly2.m_vertices.length;var vertices2=poly2.m_vertices;var normals2=poly2.m_normals;PhysicsType2d.Assert(0<=edge1&&edge1<poly1.m_vertices.length);var normal1=xf2.q.ApplyTransposeToVector2(xf1.q.ApplyToVector2(normals1[edge1]));var index=0;var minDot=PhysicsType2d.Constants.MAX_FLOAT;for(var i=0;i<count2;++i){var dot=PhysicsType2d.MathExtensions.Dot(normal1,normals2[i]);if(dot<minDot){minDot=dot;index=i;}}
var i1=index;var i2=(i1+1)<count2?i1+1:0;var c=[];c[0]=new PhysicsType2d.Collision.ClipVertex();c[0].v=xf2.ApplyToVector2(vertices2[i1]);c[0].id.cf.indexA=PhysicsType2d.MathExtensions.UInt8(edge1);c[0].id.cf.indexB=PhysicsType2d.MathExtensions.UInt8(i1);c[0].id.cf.typeA=1;c[0].id.cf.typeB=0;c[1]=new PhysicsType2d.Collision.ClipVertex();c[1].v=xf2.ApplyToVector2(vertices2[i2]);c[1].id.cf.indexA=PhysicsType2d.MathExtensions.UInt8(edge1);c[1].id.cf.indexB=PhysicsType2d.MathExtensions.UInt8(i2);c[1].id.cf.typeA=1;c[1].id.cf.typeB=0;return c;}
function CollidePolygons(manifold,polyA,xfA,polyB,xfB){var totalRadius=polyA.m_radius+polyB.m_radius;var maxSeparation=FindMaxSeparation(polyA,xfA,polyB,xfB);var edgeA=maxSeparation.index;var separationA=maxSeparation.separation;if(separationA>totalRadius){return manifold;}
maxSeparation=FindMaxSeparation(polyB,xfB,polyA,xfA);var edgeB=maxSeparation.index;var separationB=maxSeparation.separation;if(separationB>totalRadius){return manifold;}
var poly1;var poly2;var xf1;var xf2;var edge1;var flip;var k_relativeTol=0.98;var k_absoluteTol=0.001;if(separationB>k_relativeTol*separationA+k_absoluteTol){poly1=polyB;poly2=polyA;xf1=xfB.Clone();xf2=xfA.Clone();edge1=edgeB;manifold.type=2;flip=1;}else{poly1=polyA;poly2=polyB;xf1=xfA.Clone();xf2=xfB.Clone();edge1=edgeA;manifold.type=1;flip=0;}
var incidentEdge=FindIncidentEdge(poly1,xf1,edge1,poly2,xf2);var count1=poly1.m_vertices.length;var vertices1=poly1.m_vertices;var iv1=edge1;var iv2=(edge1+1)<count1?edge1+1:0;var v11=vertices1[iv1];var v12=vertices1[iv2];var localTangent=v12.Subtract(v11);localTangent.Normalize();var localNormal=PhysicsType2d.MathExtensions.Cross2x1(localTangent,1.0);var planePoint=(v11.Add(v12)).Multiply(0.5);var tangent=xf1.q.ApplyToVector2(localTangent);var normal=PhysicsType2d.MathExtensions.Cross2x1(tangent,1.0);v11=xf1.ApplyToVector2(v11);v12=xf1.ApplyToVector2(v12);var frontOffset=PhysicsType2d.MathExtensions.Dot(normal,v11);var sideOffset1=-PhysicsType2d.MathExtensions.Dot(tangent,v11)+totalRadius;var sideOffset2=PhysicsType2d.MathExtensions.Dot(tangent,v12)+totalRadius;var clipPoints1=PhysicsType2d.Collision.ClipSegmentToLine(incidentEdge,tangent.Negative(),sideOffset1,iv1);;if(clipPoints1.length<2){return manifold;}
var clipPoints2=PhysicsType2d.Collision.ClipSegmentToLine(clipPoints1,tangent,sideOffset2,iv2);if(clipPoints1.length<2){return manifold;}
manifold.localNormal=localNormal;manifold.localPoint=planePoint;manifold.points=[];for(var i=0;i<clipPoints2.length;++i){var separation=PhysicsType2d.MathExtensions.Dot(normal,clipPoints2[i].v)-frontOffset;if(separation<=totalRadius){var cp=new PhysicsType2d.Collision.ManifoldPoint();cp.localPoint=xf2.ApplyTransposeToVector2(clipPoints2[i].v);cp.id=clipPoints2[i].id;if(flip){var cf=cp.id.cf;cp.id.cf.indexA=cf.indexB;cp.id.cf.indexB=cf.indexA;cp.id.cf.typeA=cf.typeB;cp.id.cf.typeB=cf.typeA;}
manifold.points.push(cp);}}
return manifold;}
Collision.CollidePolygons=CollidePolygons;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){var TOIInput=(function(){function TOIInput(){this.proxyA=new PhysicsType2d.Collision.DistanceProxy();this.proxyB=new PhysicsType2d.Collision.DistanceProxy();this.sweepA=new PhysicsType2d.Sweep();this.sweepB=new PhysicsType2d.Sweep();}
return TOIInput;})();Collision.TOIInput=TOIInput;(function(OutputState){OutputState[OutputState["UNKNOWN"]=0]="UNKNOWN";OutputState[OutputState["FAILED"]=1]="FAILED";OutputState[OutputState["OVERLAPPED"]=2]="OVERLAPPED";OutputState[OutputState["TOUCHING"]=3]="TOUCHING";OutputState[OutputState["SEPARATED"]=4]="SEPARATED";})(Collision.OutputState||(Collision.OutputState={}));var OutputState=Collision.OutputState;var TOIOutput=(function(){function TOIOutput(){}
return TOIOutput;})();Collision.TOIOutput=TOIOutput;var toi=(function(){function toi(){}
toi.Calls=0;toi.Iters=0;toi.MaxIters=0;toi.RootIters=0;toi.MaxRootIters=0;toi.Time=0;toi.MaxTime=0;return toi;})();Collision.toi=toi;var SeparationType;(function(SeparationType){SeparationType[SeparationType["POINTS"]=0]="POINTS";SeparationType[SeparationType["FACE_A"]=1]="FACE_A";SeparationType[SeparationType["FACE_B"]=2]="FACE_B";})(SeparationType||(SeparationType={}));;var SeparationFunction=(function(){function SeparationFunction(){this.m_localPoint=new PhysicsType2d.Vector2(0,0);this.m_axis=new PhysicsType2d.Vector2(0,0);}
SeparationFunction.prototype.Initialize=function(cache,proxyA,sweepA,proxyB,sweepB,t1){this.m_proxyA=proxyA;this.m_proxyB=proxyB;var count=cache.Count();PhysicsType2d.Assert(0<count&&count<3);this.m_sweepA=sweepA;this.m_sweepB=sweepB;var xfA=this.m_sweepA.GetTransform(t1);var xfB=this.m_sweepB.GetTransform(t1);if(count==1){this.m_type=0;var localPointA=this.m_proxyA.GetVertex(cache.GetA(0));var localPointB=this.m_proxyB.GetVertex(cache.GetB(0));var pointA=xfA.ApplyToVector2(localPointA);var pointB=xfB.ApplyToVector2(localPointB);this.m_axis=pointB.Subtract(pointA);var s=this.m_axis.Normalize();return s;}else if(cache.GetA(0)==cache.GetA(1)){this.m_type=2;var localPointB1=proxyB.GetVertex(cache.GetB(0));var localPointB2=proxyB.GetVertex(cache.GetB(1));this.m_axis=PhysicsType2d.MathExtensions.Cross2x1(localPointB2.Subtract(localPointB1),1.0);this.m_axis.Normalize();var normal=xfB.q.ApplyToVector2(this.m_axis);this.m_localPoint=(localPointB1.Add(localPointB2)).Multiply(0.5);var pointB=xfB.ApplyToVector2(this.m_localPoint);var localPointA=proxyA.GetVertex(cache.GetA(0));var pointA=xfA.ApplyToVector2(localPointA);var s=(pointA.Subtract(pointB)).Dot(normal);if(s<0.0){this.m_axis=this.m_axis.Negative();s=-s;}
return s;}else{this.m_type=1;var localPointA1=this.m_proxyA.GetVertex(cache.GetA(0));var localPointA2=this.m_proxyA.GetVertex(cache.GetA(1));this.m_axis=PhysicsType2d.MathExtensions.Cross2x1(localPointA2.Subtract(localPointA1),1.0);this.m_axis.Normalize();var normal=xfA.q.ApplyToVector2(this.m_axis);this.m_localPoint=(localPointA1.Add(localPointA2)).Multiply(0.5);var pointA=xfA.ApplyToVector2(this.m_localPoint);var localPointB=this.m_proxyB.GetVertex(cache.GetB(0));var pointB=xfB.ApplyToVector2(localPointB);var s=(pointB.Subtract(pointA)).Dot(normal);if(s<0.0){this.m_axis=this.m_axis.Negative();s=-s;}
return s;}};SeparationFunction.prototype.FindMinSeparation=function(t){var s={indexA:0,indexB:0,separation:0};var xfA=this.m_sweepA.GetTransform(t);var xfB=this.m_sweepB.GetTransform(t);switch(this.m_type){case 0:{var axisA=xfA.q.ApplyTransposeToVector2(this.m_axis);var axisB=xfB.q.ApplyTransposeToVector2(this.m_axis.Negative());s.indexA=this.m_proxyA.GetSupport(axisA);s.indexB=this.m_proxyB.GetSupport(axisB);var localPointA=this.m_proxyA.GetVertex(s.indexA);var localPointB=this.m_proxyB.GetVertex(s.indexB);var pointA=xfA.ApplyToVector2(localPointA);var pointB=xfB.ApplyToVector2(localPointB);s.separation=(pointB.Subtract(pointA)).Dot(this.m_axis);return s;}
case 1:{var normal=xfA.q.ApplyToVector2(this.m_axis);var pointA=xfA.ApplyToVector2(this.m_localPoint);var axisB=xfB.q.ApplyTransposeToVector2(normal.Negative());s.indexA=-1;s.indexB=this.m_proxyB.GetSupport(axisB);var localPointB=this.m_proxyB.GetVertex(s.indexB);var pointB=xfB.ApplyToVector2(localPointB);s.separation=(pointB.Subtract(pointA)).Dot(normal);return s;}
case 2:{var normal=xfB.q.ApplyToVector2(this.m_axis);var pointB=xfB.ApplyToVector2(this.m_localPoint);var axisA=xfA.q.ApplyTransposeToVector2(normal.Negative());s.indexB=-1;s.indexA=this.m_proxyA.GetSupport(axisA);var localPointA=this.m_proxyA.GetVertex(s.indexA);var pointA=xfA.ApplyToVector2(localPointA);s.separation=(pointA.Subtract(pointB)).Dot(normal);return s;}
default:PhysicsType2d.Assert(false);s.indexA=-1;s.indexB=-1;return s;}};SeparationFunction.prototype.Evaluate=function(sep,t){var s={indexA:sep.indexA,indexB:sep.indexB,separation:0};var xfA=this.m_sweepA.GetTransform(t);var xfB=this.m_sweepB.GetTransform(t);switch(this.m_type){case 0:{var axisA=xfA.q.ApplyTransposeToVector2(this.m_axis);var axisB=xfB.q.ApplyTransposeToVector2(this.m_axis.Negative());var localPointA=this.m_proxyA.GetVertex(s.indexA);var localPointB=this.m_proxyB.GetVertex(s.indexB);var pointA=xfA.ApplyToVector2(localPointA);var pointB=xfB.ApplyToVector2(localPointB);s.separation=(pointB.Subtract(pointA)).Dot(this.m_axis);return s;}
case 1:{var normal=xfA.q.ApplyToVector2(this.m_axis);var pointA=xfA.ApplyToVector2(this.m_localPoint);var axisB=xfB.q.ApplyTransposeToVector2(normal.Negative());var localPointB=this.m_proxyB.GetVertex(s.indexB);var pointB=xfB.ApplyToVector2(localPointB);s.separation=(pointB.Subtract(pointA)).Dot(normal);return s;}
case 2:{var normal=xfB.q.ApplyToVector2(this.m_axis);var pointB=xfB.ApplyToVector2(this.m_localPoint);var axisA=xfA.q.ApplyTransposeToVector2(normal.Negative());var localPointA=this.m_proxyA.GetVertex(s.indexA);var pointA=xfA.ApplyToVector2(localPointA);s.separation=(pointA.Subtract(pointB)).Dot(normal);return s;}
default:PhysicsType2d.Assert(false);return s;}};return SeparationFunction;})();function TimeOfImpact(input){++toi.Calls;var output=new TOIOutput();output.state=0;output.t=input.tMax;var proxyA=input.proxyA;var proxyB=input.proxyB;var sweepA=input.sweepA;var sweepB=input.sweepB;sweepA.Normalize();sweepB.Normalize();var tMax=input.tMax;var totalRadius=proxyA.m_radius+proxyB.m_radius;var target=Math.max(PhysicsType2d.Settings.linearSlop,totalRadius-3.0*PhysicsType2d.Settings.linearSlop);var tolerance=0.25*PhysicsType2d.Settings.linearSlop;PhysicsType2d.Assert(target>tolerance);var t1=0.0;var k_maxIterations=20;var iter=0;var cache=new PhysicsType2d.Collision.SimplexCache();var distanceInput=new PhysicsType2d.Collision.DistanceInput();distanceInput.proxyA=input.proxyA;distanceInput.proxyB=input.proxyB;distanceInput.useRadii=false;for(;;){var xfA=sweepA.GetTransform(t1);var xfB=sweepB.GetTransform(t1);distanceInput.transformA=xfA;distanceInput.transformB=xfB;var distanceOutput=PhysicsType2d.Collision.Distance(cache,distanceInput);if(distanceOutput.distance<=0.0){output.state=2;output.t=0.0;break;}
if(distanceOutput.distance<target+tolerance){output.state=3;output.t=t1;break;}
var separationFunction=new SeparationFunction();separationFunction.Initialize(cache,proxyA,sweepA,proxyB,sweepB,t1);var done=false;var t2=tMax;var pushBackIter=0;for(;;){var s2=separationFunction.FindMinSeparation(t2);if(s2.separation>target+tolerance){output.state=4;output.t=tMax;done=true;break;}
if(s2.separation>target-tolerance){t1=t2;break;}
var s1=separationFunction.Evaluate(s2,t1);if(s1.separation<target-tolerance){output.state=1;output.t=t1;done=true;break;}
if(s1.separation<=target+tolerance){output.state=3;output.t=t1;done=true;break;}
var rootIterCount=0;var a1=t1;var a2=t2;for(;;){var t;if(rootIterCount&1){t=a1+(target-s1.separation)*(a2-a1)/(s2.separation-s1.separation);}else{t=0.5*(a1+a2);}
var s=separationFunction.Evaluate(s1,t);if(Math.abs(s.separation-target)<tolerance){t2=t;break;}
if(s.separation>target){a1=t;s1=s;}else{a2=t;s2.separation=s.separation;}
++rootIterCount;++toi.RootIters;if(rootIterCount==50){break;}}
toi.MaxRootIters=Math.max(toi.MaxRootIters,rootIterCount);++pushBackIter;if(pushBackIter==PhysicsType2d.Settings.maxPolygonVertices){break;}}
++iter;++toi.Iters;if(done){break;}
if(iter==k_maxIterations){output.state=1;output.t=t1;break;}}
toi.MaxIters=Math.max(toi.MaxIters,iter);return output;}
Collision.TimeOfImpact=TimeOfImpact;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Collision){var WorldManifold=(function(){function WorldManifold(){this.normal=new PhysicsType2d.Vector2(0,0);this.points=[];}
WorldManifold.prototype.Initialize=function(manifold,xfA,radiusA,xfB,radiusB){if(manifold.points.length===0){return;}
switch(manifold.type){case 0:{this.normal.Set(1.0,0.0);var pointA=xfA.ApplyToVector2(manifold.localPoint);var pointB=xfB.ApplyToVector2(manifold.points[0].localPoint);if(pointA.DistanceFromSquared(pointB)>(PhysicsType2d.Constants.EPSILON*PhysicsType2d.Constants.EPSILON)){this.normal=pointB.Subtract(pointA);this.normal.Normalize();}
var cA=pointA.Add(this.normal.Multiply(radiusA));var cB=pointB.Subtract(this.normal.Multiply(radiusB));this.points[0]=(cA.Add(cB)).Multiply(0.5);}
break;case 1:{this.normal=xfA.q.ApplyToVector2(manifold.localNormal);var planePoint=xfA.ApplyToVector2(manifold.localPoint);for(var i=0;i<manifold.points.length;++i){var clipPoint=xfB.ApplyToVector2(manifold.points[i].localPoint);var cA=clipPoint.Add(this.normal.Multiply(radiusA-(clipPoint.Subtract(planePoint)).Dot(this.normal)));var cB=clipPoint.Subtract(this.normal.Multiply(radiusB));this.points[i]=(cA.Add(cB)).Multiply(0.5);}}
break;case 2:{this.normal=xfB.q.ApplyToVector2(manifold.localNormal);var planePoint=xfB.ApplyToVector2(manifold.localPoint);for(var i=0;i<manifold.points.length;++i){var clipPoint=xfA.ApplyToVector2(manifold.points[i].localPoint);var cB=clipPoint.Add(this.normal.Multiply((radiusB-(clipPoint.Subtract(planePoint)).Dot(this.normal))));var cA=clipPoint.Subtract(this.normal.Multiply(radiusA));this.points[i]=(cA.Add(cB)).Multiply(0.5);}
this.normal=this.normal.Negative();}
break;}};return WorldManifold;})();Collision.WorldManifold=WorldManifold;})(PhysicsType2d.Collision||(PhysicsType2d.Collision={}));var Collision=PhysicsType2d.Collision;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(BodyType){BodyType[BodyType["STATIC"]=0]="STATIC";BodyType[BodyType["KINEMATIC"]=1]="KINEMATIC";BodyType[BodyType["DYNAMIC"]=2]="DYNAMIC";})(Dynamics.BodyType||(Dynamics.BodyType={}));var BodyType=Dynamics.BodyType;(function(BodyFlags){BodyFlags[BodyFlags["ISLAND"]=0x0001]="ISLAND";BodyFlags[BodyFlags["AWAKE"]=0x0002]="AWAKE";BodyFlags[BodyFlags["AUTO_SLEEP"]=0x0004]="AUTO_SLEEP";BodyFlags[BodyFlags["BULLET"]=0x0008]="BULLET";BodyFlags[BodyFlags["FIXED_ROTATION"]=0x0010]="FIXED_ROTATION";BodyFlags[BodyFlags["ACTIVE"]=0x0020]="ACTIVE";BodyFlags[BodyFlags["TOI"]=0x0040]="TOI";})(Dynamics.BodyFlags||(Dynamics.BodyFlags={}));var BodyFlags=Dynamics.BodyFlags;var BodyDefinition=(function(){function BodyDefinition(){this.position=new PhysicsType2d.Vector2(0,0);this.linearVelocity=new PhysicsType2d.Vector2(0,0);this.userData=null;this.angle=0.0;this.angularVelocity=0.0;this.linearDamping=0.0;this.angularDamping=0.0;this.allowSleep=true;this.awake=true;this.fixedRotation=false;this.bullet=false;this.type=0;this.active=true;this.gravityScale=1.0;}
BodyDefinition.prototype.Clone=function(){var def=new BodyDefinition();def.type=this.type;def.position=this.position.Clone();def.angle=this.angle;def.linearVelocity=this.linearVelocity.Clone();def.angularVelocity=this.angularVelocity;def.linearDamping=this.linearDamping;def.angularDamping=this.angularDamping;def.allowSleep=this.allowSleep;def.awake=this.awake;def.fixedRotation=this.fixedRotation;def.bullet=this.bullet;def.active=this.active;def.userData=this.userData;def.gravityScale=this.gravityScale;return def;};return BodyDefinition;})();Dynamics.BodyDefinition=BodyDefinition;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){var Filter=(function(){function Filter(){this.categoryBits=0x0001;this.maskBits=0xFFFF;this.groupIndex=0;}
Filter.prototype.Clone=function(){var f=new Filter();f.categoryBits=this.categoryBits;f.maskBits=this.maskBits;f.groupIndex=this.groupIndex;return f;};return Filter;})();Dynamics.Filter=Filter;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){var FixtureDefinition=(function(){function FixtureDefinition(){this.shape=null;this.userData=null;this.friction=0.2;this.restitution=0.0;this.density=0.0;this.isSensor=false;this.filter=new PhysicsType2d.Dynamics.Filter();}
FixtureDefinition.prototype.Clone=function(){var clone=new FixtureDefinition();clone.density=this.density;clone.filter=this.filter;clone.friction=this.friction;clone.isSensor=this.isSensor;clone.restitution=this.restitution;clone.shape=this.shape.Clone();clone.userData=this.userData;return clone;};return FixtureDefinition;})();Dynamics.FixtureDefinition=FixtureDefinition;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){var FixtureProxy=(function(){function FixtureProxy(fixture,aabb){this.aabb=aabb;this.fixture=fixture;this.childIndex=0;this.proxyId=-1;}
FixtureProxy.prototype.Clone=function(){var clone=new FixtureProxy(this.fixture,this.aabb.Clone());clone.childIndex;clone.proxyId;return clone;};return FixtureProxy;})();Dynamics.FixtureProxy=FixtureProxy;var Fixture=(function(){function Fixture(){this.m_userData=null;this.m_body=null;this.m_proxies=[];this.m_filter=null;this.m_shape=null;this.m_density=0.0;}
Fixture.prototype.GetType=function(){return this.m_shape.GetType();};Fixture.prototype.GetShape=function(){return this.m_shape;};Fixture.prototype.SetSensor=function(sensor){if(sensor!=this.m_isSensor){this.m_body.SetAwake(true);this.m_isSensor=sensor;}};Fixture.prototype.IsSensor=function(){return this.m_isSensor;};Fixture.prototype.SetFilterData=function(filter){this.m_filter=filter;this.Refilter();};Fixture.prototype.GetFilterData=function(){return this.m_filter;};Fixture.prototype.Refilter=function(){if(this.m_body==null){return;}
var list=this.m_body.GetContactEdges();while(list.MoveNext()){var contact=list.Current().contact;var fixtureA=contact.GetFixtureA();var fixtureB=contact.GetFixtureB();if(fixtureA==this||fixtureB==this){contact.FlagForFiltering();}}
var world=this.m_body.GetWorld();if(world==null){return;}
var broadPhase=world.GetContactManager().m_broadPhase;for(var i=0;i<this.m_proxies.length;++i){broadPhase.TouchProxy(this.m_proxies[i].proxyId);}};Fixture.prototype.GetBody=function(){return this.m_body;};Fixture.prototype.GetUserData=function(){return this.m_userData;};Fixture.prototype.SetUserData=function(data){this.m_userData=data;};Fixture.prototype.TestPoint=function(p){return this.m_shape.TestPoint(this.m_body.GetTransform(),p);};Fixture.prototype.RayCast=function(input,childIndex){return this.m_shape.RayCast(input,this.m_body.GetTransform(),childIndex);};Fixture.prototype.GetMassData=function(){return this.m_shape.ComputeMass(this.m_density);};Fixture.prototype.SetDensity=function(density){PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(density)&&density>=0.0);this.m_density=density;};Fixture.prototype.GetDensity=function(){return this.m_density;};Fixture.prototype.GetFriction=function(){return this.m_friction;};Fixture.prototype.SetFriction=function(friction){this.m_friction=friction;};Fixture.prototype.GetRestitution=function(){return this.m_restitution;};Fixture.prototype.SetRestitution=function(restitution){this.m_restitution=restitution;};Fixture.prototype.GetAABB=function(childIndex){PhysicsType2d.Assert(0<=childIndex&&childIndex<this.m_proxies.length);return this.m_proxies[childIndex].aabb.Clone();};Fixture.prototype.Dump=function(bodyIndex){PhysicsType2d.Utils.log("    FixtureDefinition fd;");PhysicsType2d.Utils.log("    fd.friction = {0};",this.m_friction);PhysicsType2d.Utils.log("    fd.restitution = {0};",this.m_restitution);PhysicsType2d.Utils.log("    fd.density = {0};",this.m_density);PhysicsType2d.Utils.log("    fd.isSensor = boolean({0});",this.m_isSensor);PhysicsType2d.Utils.log("    fd.filter.categoryBits = uint16({0});",this.m_filter.categoryBits);PhysicsType2d.Utils.log("    fd.filter.maskBits = uint16({0});",this.m_filter.maskBits);PhysicsType2d.Utils.log("    fd.filter.groupIndex = int16({0});",this.m_filter.groupIndex);switch(this.m_shape.GetType()){case 0:(function(){var s=this.m_shape;PhysicsType2d.Utils.log("    CircleShape shape;");PhysicsType2d.Utils.log("    shape.m_radius = {0};",s.m_radius);PhysicsType2d.Utils.log("    shape.m_p.Set({0}, {0});",s.m_p.x,s.m_p.y);})();break;case 1:(function(){var s=this.m_shape;PhysicsType2d.Utils.log("    EdgeShape shape;");PhysicsType2d.Utils.log("    shape.m_radius = {0};",s.m_radius);PhysicsType2d.Utils.log("    shape.m_vertex0.Set({0}, {1});",s.m_vertex0.x,s.m_vertex0.y);PhysicsType2d.Utils.log("    shape.m_vertex1.Set({0}, {1});",s.m_vertex1.x,s.m_vertex1.y);PhysicsType2d.Utils.log("    shape.m_vertex2.Set({0}, {1});",s.m_vertex2.x,s.m_vertex2.y);PhysicsType2d.Utils.log("    shape.m_vertex3.Set({0}, {1});",s.m_vertex3.x,s.m_vertex3.y);PhysicsType2d.Utils.log("    shape.m_hasVertex0 = boolean({0});",s.m_hasVertex0);PhysicsType2d.Utils.log("    shape.m_hasVertex3 = boolean({0});",s.m_hasVertex3);})();break;case 2:(function(){var s=this.m_shape;PhysicsType2d.Utils.log("    PolygonShape shape;");PhysicsType2d.Utils.log("    Vector2 vs[{0}];",PhysicsType2d.Settings.maxPolygonVertices);for(var i=0;i<s.m_vertices.length;++i){PhysicsType2d.Utils.log("    vs[{0}].Set({0}, {1});",i,s.m_vertices[i].x,s.m_vertices[i].y);}
PhysicsType2d.Utils.log("    shape.Set(vs, {0});",s.m_vertices.length);})();break;case 3:(function(){var s=this.m_shape;PhysicsType2d.Utils.log("    ChainShape shape;");PhysicsType2d.Utils.log("    Vector2 vs[{0}];",s.m_vertices.length);for(var i=0;i<s.m_vertices.length;++i){PhysicsType2d.Utils.log("    vs[{0}].Set({0}, {1});",i,s.m_vertices[i].x,s.m_vertices[i].y);}
PhysicsType2d.Utils.log("    shape.CreateChain(vs, {0});",s.m_vertices.length);PhysicsType2d.Utils.log("    shape.m_prevVertex.Set({0}, {1});",s.m_prevVertex.x,s.m_prevVertex.y);PhysicsType2d.Utils.log("    shape.m_nextVertex.Set({0}, {1});",s.m_nextVertex.x,s.m_nextVertex.y);PhysicsType2d.Utils.log("    shape.m_hasPrevVertex = boolean({0});",s.m_hasPrevVertex);PhysicsType2d.Utils.log("    shape.m_hasNextVertex = boolean({0});",s.m_hasNextVertex);})();break;default:return;}
PhysicsType2d.Utils.log("    fd.shape = &shape;");PhysicsType2d.Utils.log("    bodies[{0}].CreateFixture(&fd);",bodyIndex);};Fixture.Create=function(body,def){var newFixture=new Fixture();newFixture.m_userData=def.userData;newFixture.m_friction=def.friction;newFixture.m_restitution=def.restitution;newFixture.m_body=body;newFixture.m_filter=def.filter.Clone();newFixture.m_isSensor=def.isSensor;newFixture.m_shape=def.shape.Clone();newFixture.m_proxies=[];newFixture.m_density=def.density;return newFixture;};Fixture.prototype.Destroy=function(forceProxies){if(forceProxies!==true){PhysicsType2d.Assert(this.m_proxies.length==0);}
this.m_proxies=null;this.m_shape=null;};Fixture.prototype.CreateProxies=function(broadPhase,xf){PhysicsType2d.Assert(this.m_proxies.length==0);var count=this.m_shape.GetChildCount();this.m_proxies=new Array(count);for(var i=0;i<count;++i){var proxy=new FixtureProxy(this,this.m_shape.ComputeAABB(xf,i));proxy.proxyId=broadPhase.CreateProxy(proxy.aabb,proxy);proxy.childIndex=i;this.m_proxies[i]=proxy;}};Fixture.prototype.DestroyProxies=function(broadPhase){for(var i=0;i<this.m_proxies.length;++i){var proxy=this.m_proxies[i];broadPhase.DestroyProxy(proxy.proxyId);proxy.proxyId=-1;}
this.m_proxies=[];};Fixture.prototype.Synchronize=function(broadPhase,xf1,xf2){if(this.m_proxies.length==0){return;}
for(var i=0;i<this.m_proxies.length;++i){var proxy=this.m_proxies[i];var aabb1=this.m_shape.ComputeAABB(xf1,proxy.childIndex);var aabb2=this.m_shape.ComputeAABB(xf2,proxy.childIndex);proxy.aabb.Combine(aabb1,aabb2);var displacement=xf2.p.Subtract(xf1.p);broadPhase.MoveProxy(proxy.proxyId,proxy.aabb,displacement);}};Fixture.prototype.ClearBody=function(){this.m_body=null;};Fixture.prototype.SetBody=function(body){this.m_body=body;};Fixture.prototype.GetProxies=function(){return this.m_proxies;};Fixture.prototype.GetProxy=function(index){return this.m_proxies[index];};Fixture.prototype.GetProxyCount=function(){return this.m_proxies.length;};return Fixture;})();Dynamics.Fixture=Fixture;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){var Profile=(function(){function Profile(){this.step=0;this.collide=0;this.solve=0;this.solveInit=0;this.solveVelocity=0;this.solvePosition=0;this.broadphase=0;this.solveTOI=0;}
return Profile;})();Dynamics.Profile=Profile;var TimeStep=(function(){function TimeStep(){this.dt=0;this.inv_dt=0;this.dtRatio=0;this.velocityIterations=0;this.positionIterations=0;this.warmStarting=false;}
return TimeStep;})();Dynamics.TimeStep=TimeStep;var Position=(function(){function Position(c,a){this.c=c;this.a=a;}
Position.prototype.Clone=function(){return new Position(this.c.Clone(),this.a);};return Position;})();Dynamics.Position=Position;var Velocity=(function(){function Velocity(v,w){this.v=v;this.w=w;}
Velocity.prototype.Clone=function(){return new Velocity(this.v.Clone(),this.w);};return Velocity;})();Dynamics.Velocity=Velocity;var SolverData=(function(){function SolverData(step,positions,velocities){this.step=step;this.positions=positions;this.velocities=velocities;}
return SolverData;})();Dynamics.SolverData=SolverData;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){(function(JointType){JointType[JointType["UNKNOWN"]=0]="UNKNOWN";JointType[JointType["REVOLUTE"]=1]="REVOLUTE";JointType[JointType["PRISMATIC"]=2]="PRISMATIC";JointType[JointType["DISTANCE"]=3]="DISTANCE";JointType[JointType["PULLEY"]=4]="PULLEY";JointType[JointType["MOUSE"]=5]="MOUSE";JointType[JointType["GEAR"]=6]="GEAR";JointType[JointType["WHEEL"]=7]="WHEEL";JointType[JointType["WELD"]=8]="WELD";JointType[JointType["FRICTION"]=9]="FRICTION";JointType[JointType["ROPE"]=10]="ROPE";JointType[JointType["MOTOR"]=11]="MOTOR";})(Joints.JointType||(Joints.JointType={}));var JointType=Joints.JointType;;(function(LimitState){LimitState[LimitState["INACTIVE_LIMIT"]=0]="INACTIVE_LIMIT";LimitState[LimitState["AT_LOWER_LIMIT"]=1]="AT_LOWER_LIMIT";LimitState[LimitState["AT_UPPER_LIMIT"]=2]="AT_UPPER_LIMIT";LimitState[LimitState["EQUAL_LIMIT"]=3]="EQUAL_LIMIT";})(Joints.LimitState||(Joints.LimitState={}));var LimitState=Joints.LimitState;;var Jacobian=(function(){function Jacobian(){this.linear=new PhysicsType2d.Vector2(0,0);}
return Jacobian;})();Joints.Jacobian=Jacobian;;var JointDefinition=(function(){function JointDefinition(){this.type=0;this.userData=null;this.bodyA=null;this.bodyB=null;this.collideConnected=false;}
return JointDefinition;})();Joints.JointDefinition=JointDefinition;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var Joint=(function(){function Joint(def){PhysicsType2d.Assert(def.bodyA!=def.bodyB);this.m_type=def.type;this.m_bodyA=def.bodyA;this.m_bodyB=def.bodyB;this.m_index=0;this.m_collideConnected=def.collideConnected;this.m_islandFlag=false;this.m_userData=def.userData;this.m_edgeA=new PhysicsType2d.Dynamics.Joints.JointEdge();this.m_edgeA.joint=null;this.m_edgeA.other=null;this.m_edgeB=new PhysicsType2d.Dynamics.Joints.JointEdge();this.m_edgeB.joint=null;this.m_edgeB.other=null;}
Joint.prototype.GetType=function(){return this.m_type;};Joint.prototype.GetBodyA=function(){return this.m_bodyA;};Joint.prototype.GetBodyB=function(){return this.m_bodyB;};Joint.prototype.GetUserData=function(){return this.m_userData;};Joint.prototype.SetUserData=function(data){this.m_userData=data;};Joint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive();};Joint.prototype.GetCollideConnected=function(){return this.m_collideConnected;};Joint.prototype.Dump=function(){PhysicsType2d.Utils.log("// Dump is not supported for this joint type.");};Joint.Create=function(def){var joint=null;switch(def.type){case 3:{joint=new PhysicsType2d.Dynamics.Joints.DistanceJoint(def);}
break;case 5:{joint=new PhysicsType2d.Dynamics.Joints.MouseJoint(def);}
break;case 2:{joint=new PhysicsType2d.Dynamics.Joints.PrismaticJoint(def);}
break;case 1:{joint=new PhysicsType2d.Dynamics.Joints.RevoluteJoint(def);}
break;case 4:{joint=new PhysicsType2d.Dynamics.Joints.PulleyJoint(def);}
break;case 6:{joint=new PhysicsType2d.Dynamics.Joints.GearJoint(def);}
break;case 7:{joint=new PhysicsType2d.Dynamics.Joints.WheelJoint(def);}
break;case 8:{joint=new PhysicsType2d.Dynamics.Joints.WeldJoint(def);}
break;case 9:{joint=new PhysicsType2d.Dynamics.Joints.FrictionJoint(def);}
break;case 10:{joint=new PhysicsType2d.Dynamics.Joints.RopeJoint(def);}
break;case 11:{joint=new PhysicsType2d.Dynamics.Joints.MotorJoint(def);}
break;default:PhysicsType2d.Assert(false,"Unknown Joint Type.  Define the creation method.");break;}
return joint;};Joint.prototype.GetAnchorA=function(){PhysicsType2d.Assert(false);return null;};Joint.prototype.GetAnchorB=function(){PhysicsType2d.Assert(false);return null;};Joint.prototype.GetReactionForce=function(inv_dt){PhysicsType2d.Assert(false);return null;};Joint.prototype.GetReactionTorque=function(inv_dt){PhysicsType2d.Assert(false);return 0;};Joint.prototype.InitVelocityConstraints=function(data){PhysicsType2d.Assert(false);};Joint.prototype.SolveVelocityConstraints=function(data){PhysicsType2d.Assert(false);};Joint.prototype.SolvePositionConstraints=function(data){PhysicsType2d.Assert(false);return false;};return Joint;})();Joints.Joint=Joint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Contacts){function MixFriction(friction1,friction2){return Math.sqrt(friction1*friction2);}
Contacts.MixFriction=MixFriction;function MixRestitution(restitution1,restitution2){return restitution1>restitution2?restitution1:restitution2;}
Contacts.MixRestitution=MixRestitution;var ContactRegister=(function(){function ContactRegister(){}
return ContactRegister;})();Contacts.ContactRegister=ContactRegister;var ContactEdge=(function(){function ContactEdge(){}
ContactEdge.prototype.Clone=function(){var clone=new ContactEdge();clone.other=this.other;clone.contact=this.contact;return clone;};return ContactEdge;})();Contacts.ContactEdge=ContactEdge;(function(ContactFlags){ContactFlags[ContactFlags["ISLAND"]=0x0001]="ISLAND";ContactFlags[ContactFlags["TOUCHING"]=0x0002]="TOUCHING";ContactFlags[ContactFlags["ENABLED"]=0x0004]="ENABLED";ContactFlags[ContactFlags["FILTER"]=0x0008]="FILTER";ContactFlags[ContactFlags["BULLET_HIT"]=0x0010]="BULLET_HIT";ContactFlags[ContactFlags["TOI"]=0x0020]="TOI";})(Contacts.ContactFlags||(Contacts.ContactFlags={}));var ContactFlags=Contacts.ContactFlags;var Contact=(function(){function Contact(fA,indexA,fB,indexB){this.m_flags=new PhysicsType2d.BitFlag(4);this.m_fixtureA=fA;this.m_fixtureB=fB;this.m_indexA=indexA;this.m_indexB=indexB;this.m_manifold=new PhysicsType2d.Collision.Manifold();this.m_nodeA=new ContactEdge();this.m_nodeB=new ContactEdge();this.m_nodeA.contact=null;this.m_nodeA.other=null;this.m_nodeB.contact=null;this.m_nodeB.other=null;this.m_toiCount=0;this.m_toi=0;this.m_friction=MixFriction(this.m_fixtureA.GetFriction(),this.m_fixtureB.GetFriction());this.m_restitution=MixRestitution(this.m_fixtureA.GetRestitution(),this.m_fixtureB.GetRestitution());}
Contact.prototype.GetManifold=function(){return this.m_manifold;};Contact.prototype.GetWorldManifold=function(){var bodyA=this.m_fixtureA.GetBody();var bodyB=this.m_fixtureB.GetBody();var shapeA=this.m_fixtureA.GetShape();var shapeB=this.m_fixtureB.GetShape();var worldManifold=new PhysicsType2d.Collision.WorldManifold();worldManifold.Initialize(this.m_manifold,bodyA.GetTransform(),shapeA.GetRadius(),bodyB.GetTransform(),shapeB.GetRadius());return worldManifold;};Contact.prototype.IsTouching=function(){return this.IsFlagSet(2);};Contact.prototype.SetEnabled=function(flag){if(flag){this.SetFlag(4);}else{this.ClearFlag(4);}};Contact.prototype.IsEnabled=function(){return this.IsFlagSet(4);};Contact.prototype.GetFixtureA=function(){return this.m_fixtureA;};Contact.prototype.GetChildIndexA=function(){return this.m_indexA;};Contact.prototype.GetFixtureB=function(){return this.m_fixtureB;};Contact.prototype.GetChildIndexB=function(){return this.m_indexB;};Contact.prototype.SetFriction=function(friction){this.m_friction=friction;};Contact.prototype.GetFriction=function(){return this.m_friction;};Contact.prototype.ResetFriction=function(){this.m_friction=MixFriction(this.m_fixtureA.GetFriction(),this.m_fixtureB.GetFriction());};Contact.prototype.SetRestitution=function(restitution){this.m_restitution=restitution;};Contact.prototype.GetRestitution=function(){return this.m_restitution;};Contact.prototype.ResetRestitution=function(){this.m_restitution=MixRestitution(this.m_fixtureA.GetRestitution(),this.m_fixtureB.GetRestitution());};Contact.prototype.FlagForFiltering=function(){this.SetFlag(8);};Contact.prototype.Evaluate=function(manifold,xfA,xfB){throw Error("Abstract Method Not Implemented");};Contact.InitializeRegisters=function(){Contact.AddType(PhysicsType2d.Dynamics.Contacts.CircleContact.Create,0,0);Contact.AddType(PhysicsType2d.Dynamics.Contacts.PolygonAndCircleContact.Create,2,0);Contact.AddType(PhysicsType2d.Dynamics.Contacts.PolygonContact.Create,2,2);Contact.AddType(PhysicsType2d.Dynamics.Contacts.EdgeAndCircleContact.Create,1,0);Contact.AddType(PhysicsType2d.Dynamics.Contacts.EdgeAndPolygonContact.Create,1,2);Contact.AddType(PhysicsType2d.Dynamics.Contacts.ChainAndCircleContact.Create,3,0);Contact.AddType(PhysicsType2d.Dynamics.Contacts.ChainAndPolygonContact.Create,3,2);};Contact.AddType=function(create,type1,type2){PhysicsType2d.Assert(0<=type1&&type1<4);PhysicsType2d.Assert(0<=type2&&type2<4);Contact.s_registers[type1][type2].create=create;Contact.s_registers[type1][type2].primary=true;if(type1!=type2){Contact.s_registers[type2][type1].create=create;Contact.s_registers[type2][type1].primary=false;}};Contact.Create=function(fixtureA,indexA,fixtureB,indexB){if(Contact.s_initialized==false){this.InitializeRegisters();Contact.s_initialized=true;}
var type1=fixtureA.GetType();var type2=fixtureB.GetType();PhysicsType2d.Assert(0<=type1&&type1<4);PhysicsType2d.Assert(0<=type2&&type2<4);var create=Contact.s_registers[type1][type2].create;if(create){if(Contact.s_registers[type1][type2].primary){return create(fixtureA,indexA,fixtureB,indexB);}else{return create(fixtureB,indexB,fixtureA,indexA);}}else{return null;}};Contact.prototype.Destructor=function(){PhysicsType2d.Assert(Contact.s_initialized==true);if(this.m_manifold.points.length>0){this.GetFixtureA().GetBody().SetAwake(true);this.GetFixtureB().GetBody().SetAwake(true);}
var typeA=this.GetFixtureA().GetType();var typeB=this.GetFixtureB().GetType();PhysicsType2d.Assert(0<=typeA&&typeB<4);PhysicsType2d.Assert(0<=typeA&&typeB<4);};Contact.prototype.Update=function(listener){var oldManifold=this.m_manifold;this.SetFlag(4);var touching=false;var wasTouching=this.IsFlagSet(2);var sensorA=this.m_fixtureA.IsSensor();var sensorB=this.m_fixtureB.IsSensor();var sensor=sensorA||sensorB;var bodyA=this.m_fixtureA.GetBody();var bodyB=this.m_fixtureB.GetBody();var xfA=bodyA.GetTransform();var xfB=bodyB.GetTransform();if(sensor){var shapeA=this.m_fixtureA.GetShape();var shapeB=this.m_fixtureB.GetShape();touching=PhysicsType2d.Collision.TestOverlap(shapeA,this.m_indexA,shapeB,this.m_indexB,xfA,xfB);this.m_manifold.points=[];}else{this.Evaluate(this.m_manifold,xfA,xfB);touching=this.m_manifold.points.length>0;for(var i=0;i<this.m_manifold.points.length;++i){var mp2=this.m_manifold.points[i];mp2.normalImpulse=0.0;mp2.tangentImpulse=0.0;var id2=mp2.id;for(var j=0;j<oldManifold.points.length;++j){var mp1=oldManifold.points[j];if(mp1.id.key==id2.key){mp2.normalImpulse=mp1.normalImpulse;mp2.tangentImpulse=mp1.tangentImpulse;break;}}}
if(touching!=wasTouching){bodyA.SetAwake(true);bodyB.SetAwake(true);}}
if(touching){this.SetFlag(2);}else{this.ClearFlag(2);}
if(wasTouching==false&&touching==true&&listener){listener.BeginContact(this);}
if(wasTouching==true&&touching==false&&listener){listener.EndContact(this);}
if(sensor==false&&touching&&listener){listener.PreSolve(this,oldManifold);}};Contact.prototype.SetFlag=function(flag){this.m_flags.Set(flag);};Contact.prototype.ClearFlag=function(flag){this.m_flags.Clear(flag);};Contact.prototype.IsFlagSet=function(desiredFlags){return this.m_flags.IsSet(desiredFlags);};Contact.s_registers=PhysicsType2d.Utils.AllocateArray(4,function(){return PhysicsType2d.Utils.AllocateArray(4,function(){return new ContactRegister();});});Contact.s_initialized=false;return Contact;})();Contacts.Contact=Contact;})(Dynamics.Contacts||(Dynamics.Contacts={}));var Contacts=Dynamics.Contacts;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Contacts){var VelocityConstraintPoint=(function(){function VelocityConstraintPoint(){this.rA=new PhysicsType2d.Vector2(0,0);this.rB=new PhysicsType2d.Vector2(0,0);this.normalImpulse=0;this.tangentImpulse=0;this.normalMass=0;this.tangentMass=0;this.velocityBias=0;}
return VelocityConstraintPoint;})();Contacts.VelocityConstraintPoint=VelocityConstraintPoint;var ContactVelocityConstraint=(function(){function ContactVelocityConstraint(){this.points=[];this.normal=new PhysicsType2d.Vector2(0,0);this.normalMass=new PhysicsType2d.Matrix2x2();this.K=new PhysicsType2d.Matrix2x2();}
return ContactVelocityConstraint;})();Contacts.ContactVelocityConstraint=ContactVelocityConstraint;var ContactSolverDef=(function(){function ContactSolverDef(){this.step=new PhysicsType2d.Dynamics.TimeStep();this.contacts=[];this.positions=[];this.velocities=[];}
return ContactSolverDef;})();Contacts.ContactSolverDef=ContactSolverDef;var ContactPositionConstraint=(function(){function ContactPositionConstraint(){this.localPoints=[];this.localNormal=new PhysicsType2d.Vector2(0,0);this.localPoint=new PhysicsType2d.Vector2(0,0);this.indexA=0;this.indexB=0;this.invMassA=0;this.invMassB=0;this.localCenterA=new PhysicsType2d.Vector2(0,0);this.localCenterB=new PhysicsType2d.Vector2(0,0);this.invIA=0;this.invIB=0;this.type=0;this.radiusA=0;this.radiusB=0;}
return ContactPositionConstraint;})();Contacts.ContactPositionConstraint=ContactPositionConstraint;var PositionSolverManifold=(function(){function PositionSolverManifold(){this.normal=new PhysicsType2d.Vector2(0,0);this.point=new PhysicsType2d.Vector2(0,0);}
PositionSolverManifold.prototype.Initialize=function(pc,xfA,xfB,index){PhysicsType2d.Assert(pc.localPoints.length>0);switch(pc.type){case 0:{var pointA=xfA.ApplyToVector2(pc.localPoint);var pointB=xfB.ApplyToVector2(pc.localPoints[0]);this.normal=pointB.Subtract(pointA);this.normal.Normalize();this.point=(pointA.Add(pointB)).Multiply(0.5);this.separation=(pointB.Subtract(pointA)).Dot(this.normal)-pc.radiusA-pc.radiusB;}
break;case 1:{this.normal=xfA.q.ApplyToVector2(pc.localNormal);var planePoint=xfA.ApplyToVector2(pc.localPoint);var clipPoint=xfB.ApplyToVector2(pc.localPoints[index]);this.separation=(clipPoint.Subtract(planePoint)).Dot(this.normal)-pc.radiusA-pc.radiusB;this.point=clipPoint;}
break;case 2:{this.normal=xfB.q.ApplyToVector2(pc.localNormal);var planePoint=xfB.ApplyToVector2(pc.localPoint);var clipPoint=xfA.ApplyToVector2(pc.localPoints[index]);this.separation=(clipPoint.Subtract(planePoint)).Dot(this.normal)-pc.radiusA-pc.radiusB;this.point=clipPoint;this.normal=this.normal.Negative();}
break;}};return PositionSolverManifold;})();var ContactSolver=(function(){function ContactSolver(def){this.m_step=def.step;this.m_positionConstraints=[];this.m_velocityConstraints=[];this.m_positions=def.positions;this.m_velocities=def.velocities;this.m_contacts=def.contacts;for(var i=0;i<this.m_contacts.length;++i){var contact=this.m_contacts[i];var fixtureA=contact.GetFixtureA();var fixtureB=contact.GetFixtureB();var shapeA=fixtureA.GetShape();var shapeB=fixtureB.GetShape();var radiusA=shapeA.GetRadius();var radiusB=shapeB.GetRadius();var bodyA=fixtureA.GetBody();var bodyB=fixtureB.GetBody();var manifold=contact.GetManifold();var pointCount=manifold.points.length;PhysicsType2d.Assert(pointCount>0);var vc=new ContactVelocityConstraint();vc.friction=contact.GetFriction();vc.restitution=contact.GetRestitution();vc.indexA=bodyA.GetIslandIndex();vc.indexB=bodyB.GetIslandIndex();vc.invMassA=bodyA.GetInvMass();vc.invMassB=bodyB.GetInvMass();vc.invIA=bodyA.GetInvI();vc.invIB=bodyB.GetInvI();vc.contactIndex=i;vc.points=[];vc.K.SetZero();vc.normalMass.SetZero();var pc=new ContactPositionConstraint();pc.indexA=bodyA.GetIslandIndex();pc.indexB=bodyB.GetIslandIndex();pc.invMassA=bodyA.GetInvMass();pc.invMassB=bodyB.GetInvMass();pc.localCenterA=bodyA.GetSweep().localCenter;pc.localCenterB=bodyB.GetSweep().localCenter;pc.invIA=bodyA.GetInvI();pc.invIB=bodyB.GetInvI();pc.localNormal=manifold.localNormal;pc.localPoint=manifold.localPoint;pc.localPoints=[];pc.radiusA=radiusA;pc.radiusB=radiusB;pc.type=manifold.type;for(var j=0;j<pointCount;++j){var cp=manifold.points[j];var vcp=new VelocityConstraintPoint();if(this.m_step.warmStarting){vcp.normalImpulse=this.m_step.dtRatio*cp.normalImpulse;vcp.tangentImpulse=this.m_step.dtRatio*cp.tangentImpulse;}else{vcp.normalImpulse=0.0;vcp.tangentImpulse=0.0;}
vcp.rA=PhysicsType2d.Vector2.Zero();vcp.rB=PhysicsType2d.Vector2.Zero();vcp.normalMass=0.0;vcp.tangentMass=0.0;vcp.velocityBias=0.0;vc.points[j]=vcp;pc.localPoints[j]=cp.localPoint;}
this.m_positionConstraints[i]=pc;this.m_velocityConstraints[i]=vc;}}
ContactSolver.prototype.Destructor=function(){this.m_velocityConstraints=null;this.m_positionConstraints=null;};ContactSolver.prototype.InitializeVelocityConstraints=function(){for(var i=0;i<this.m_contacts.length;++i){var vc=this.m_velocityConstraints[i];var pc=this.m_positionConstraints[i];var radiusA=pc.radiusA;var radiusB=pc.radiusB;var manifold=this.m_contacts[vc.contactIndex].GetManifold();var indexA=vc.indexA;var indexB=vc.indexB;var mA=vc.invMassA;var mB=vc.invMassB;var iA=vc.invIA;var iB=vc.invIB;var localCenterA=pc.localCenterA;var localCenterB=pc.localCenterB;var cA=this.m_positions[indexA].c;var aA=this.m_positions[indexA].a;var vA=this.m_velocities[indexA].v;var wA=this.m_velocities[indexA].w;var cB=this.m_positions[indexB].c;var aB=this.m_positions[indexB].a;var vB=this.m_velocities[indexB].v;var wB=this.m_velocities[indexB].w;PhysicsType2d.Assert(manifold.points.length>0);var xfA=new PhysicsType2d.Transform();var xfB=new PhysicsType2d.Transform();xfA.q.Set(aA);xfB.q.Set(aB);xfA.p=cA.Subtract(xfA.q.ApplyToVector2(localCenterA));xfB.p=cB.Subtract(xfB.q.ApplyToVector2(localCenterB));var worldManifold=new PhysicsType2d.Collision.WorldManifold();worldManifold.Initialize(manifold,xfA,radiusA,xfB,radiusB);vc.normal=worldManifold.normal;for(var j=0;j<vc.points.length;++j){var vcp=vc.points[j];vcp.rA=worldManifold.points[j].Subtract(cA);vcp.rB=worldManifold.points[j].Subtract(cB);var rnA=PhysicsType2d.MathExtensions.Cross2x2(vcp.rA,vc.normal);var rnB=PhysicsType2d.MathExtensions.Cross2x2(vcp.rB,vc.normal);var kNormal=mA+mB+iA*rnA*rnA+iB*rnB*rnB;vcp.normalMass=kNormal>0.0?1.0/kNormal:0.0;var tangent=PhysicsType2d.MathExtensions.Cross2x1(vc.normal,1.0);var rtA=PhysicsType2d.MathExtensions.Cross2x2(vcp.rA,tangent);var rtB=PhysicsType2d.MathExtensions.Cross2x2(vcp.rB,tangent);var kTangent=mA+mB+iA*rtA*rtA+iB*rtB*rtB;vcp.tangentMass=kTangent>0.0?1.0/kTangent:0.0;vcp.velocityBias=0.0;var vRel=PhysicsType2d.MathExtensions.Dot(vc.normal,vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,vcp.rB)).Subtract(vA).Subtract(PhysicsType2d.MathExtensions.Cross1x2(wA,vcp.rA)));if(vRel<-PhysicsType2d.Settings.velocityThreshold){vcp.velocityBias=-vc.restitution*vRel;}
vc.points[j]=vcp;}
if(vc.points.length==2){var vcp1=vc.points[0];var vcp2=vc.points[1];var rn1A=PhysicsType2d.MathExtensions.Cross2x2(vcp1.rA,vc.normal);var rn1B=PhysicsType2d.MathExtensions.Cross2x2(vcp1.rB,vc.normal);var rn2A=PhysicsType2d.MathExtensions.Cross2x2(vcp2.rA,vc.normal);var rn2B=PhysicsType2d.MathExtensions.Cross2x2(vcp2.rB,vc.normal);var k11=mA+mB+iA*rn1A*rn1A+iB*rn1B*rn1B;var k22=mA+mB+iA*rn2A*rn2A+iB*rn2B*rn2B;var k12=mA+mB+iA*rn1A*rn2A+iB*rn1B*rn2B;var k_maxConditionNumber=1000.0;if(k11*k11<k_maxConditionNumber*(k11*k22-k12*k12)){vc.K.EX.Set(k11,k12);vc.K.EY.Set(k12,k22);vc.normalMass=vc.K.GetInverse();}else{vc.points=[vc.points[0]];}}}};ContactSolver.prototype.WarmStart=function(){for(var i=0;i<this.m_contacts.length;++i){var vc=this.m_velocityConstraints[i];var indexA=vc.indexA;var indexB=vc.indexB;var mA=vc.invMassA;var iA=vc.invIA;var mB=vc.invMassB;var iB=vc.invIB;var vA=this.m_velocities[indexA].v;var wA=this.m_velocities[indexA].w;var vB=this.m_velocities[indexB].v;var wB=this.m_velocities[indexB].w;var normal=vc.normal;var tangent=PhysicsType2d.MathExtensions.Cross2x1(normal,1.0);for(var j=0;j<vc.points.length;++j){var vcp=vc.points[j];var P=normal.Multiply(vcp.normalImpulse).Add(tangent.Multiply(vcp.tangentImpulse));wA-=iA*PhysicsType2d.MathExtensions.Cross2x2(vcp.rA,P);vA=vA.Subtract(P.Multiply(mA));wB+=iB*PhysicsType2d.MathExtensions.Cross2x2(vcp.rB,P);vB=vB.Add(P.Multiply(mB));}
this.m_velocities[indexA].v=vA;this.m_velocities[indexA].w=wA;this.m_velocities[indexB].v=vB;this.m_velocities[indexB].w=wB;}};ContactSolver.prototype.SolveVelocityConstraints=function(){for(var i=0;i<this.m_contacts.length;++i){var vc=this.m_velocityConstraints[i];var indexA=vc.indexA;var indexB=vc.indexB;var mA=vc.invMassA;var iA=vc.invIA;var mB=vc.invMassB;var iB=vc.invIB;var vA=this.m_velocities[indexA].v;var wA=this.m_velocities[indexA].w;var vB=this.m_velocities[indexB].v;var wB=this.m_velocities[indexB].w;var normal=vc.normal;var tangent=PhysicsType2d.MathExtensions.Cross2x1(normal,1.0);var friction=vc.friction;PhysicsType2d.Assert(vc.points.length==1||vc.points.length==2);for(var j=0;j<vc.points.length;++j){var vcp=vc.points[j];var dv=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,vcp.rB)).Subtract(vA).Subtract(PhysicsType2d.MathExtensions.Cross1x2(wA,vcp.rA));var vt=PhysicsType2d.MathExtensions.Dot(dv,tangent);var lambda=vcp.tangentMass*(-vt);var maxFriction=friction*vcp.normalImpulse;var newImpulse=PhysicsType2d.MathExtensions.Clamp(vcp.tangentImpulse+lambda,-maxFriction,maxFriction);lambda=newImpulse-vcp.tangentImpulse;vcp.tangentImpulse=newImpulse;var P=tangent.Multiply(lambda);vA=vA.Subtract(P.Multiply(mA));wA-=iA*PhysicsType2d.MathExtensions.Cross2x2(vcp.rA,P);vB=vB.Add(P.Multiply(mB));wB+=iB*PhysicsType2d.MathExtensions.Cross2x2(vcp.rB,P);}
if(vc.points.length==1){var vcp=vc.points[0];var dv=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,vcp.rB)).Subtract(vA).Subtract(PhysicsType2d.MathExtensions.Cross1x2(wA,vcp.rA));var vn=PhysicsType2d.MathExtensions.Dot(dv,normal);var lambda=-vcp.normalMass*(vn-vcp.velocityBias);var newImpulse=Math.max(vcp.normalImpulse+lambda,0.0);lambda=newImpulse-vcp.normalImpulse;vcp.normalImpulse=newImpulse;var P=normal.Multiply(lambda);vA=vA.Subtract(P.Multiply(mA));wA-=iA*PhysicsType2d.MathExtensions.Cross2x2(vcp.rA,P);vB=vB.Add(P.Multiply(mB));wB+=iB*PhysicsType2d.MathExtensions.Cross2x2(vcp.rB,P);}else{var cp1=vc.points[0];var cp2=vc.points[1];var a=new PhysicsType2d.Vector2(cp1.normalImpulse,cp2.normalImpulse);PhysicsType2d.Assert(a.x>=0.0&&a.y>=0.0);var dv1=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,cp1.rB)).Subtract(vA).Subtract(PhysicsType2d.MathExtensions.Cross1x2(wA,cp1.rA));var dv2=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,cp2.rB)).Subtract(vA).Subtract(PhysicsType2d.MathExtensions.Cross1x2(wA,cp2.rA));var vn1=PhysicsType2d.MathExtensions.Dot(dv1,normal);var vn2=PhysicsType2d.MathExtensions.Dot(dv2,normal);var b=new PhysicsType2d.Vector2(vn1-cp1.velocityBias,vn2-cp2.velocityBias);b=b.Subtract(vc.K.VectorMultiply(a));var k_errorTol=0.001;for(;;){var x=vc.normalMass.VectorMultiply(b).Negative();if(x.x>=0.0&&x.y>=0.0){var d=x.Subtract(a);var P1=normal.Multiply(d.x);var P2=normal.Multiply(d.y);vA=vA.Subtract((P1.Add(P2)).Multiply(mA));wA-=iA*(PhysicsType2d.MathExtensions.Cross2x2(cp1.rA,P1)+PhysicsType2d.MathExtensions.Cross2x2(cp2.rA,P2));vB=vB.Add((P1.Add(P2)).Multiply(mB));wB+=iB*(PhysicsType2d.MathExtensions.Cross2x2(cp1.rB,P1)+PhysicsType2d.MathExtensions.Cross2x2(cp2.rB,P2));cp1.normalImpulse=x.x;cp2.normalImpulse=x.y;break;}
x.x=-cp1.normalMass*b.x;x.y=0.0;vn1=0.0;vn2=vc.K.EX.y*x.x+b.y;if(x.x>=0.0&&vn2>=0.0){var d=x.Subtract(a);var P1=normal.Multiply(d.x);var P2=normal.Multiply(d.y);vA=vA.Subtract((P1.Add(P2)).Multiply(mA));wA-=iA*(PhysicsType2d.MathExtensions.Cross2x2(cp1.rA,P1)+PhysicsType2d.MathExtensions.Cross2x2(cp2.rA,P2));vB=vB.Add((P1.Add(P2)).Multiply(mB));wB+=iB*(PhysicsType2d.MathExtensions.Cross2x2(cp1.rB,P1)+PhysicsType2d.MathExtensions.Cross2x2(cp2.rB,P2));cp1.normalImpulse=x.x;cp2.normalImpulse=x.y;break;}
x.x=0.0;x.y=-cp2.normalMass*b.y;vn1=vc.K.EY.x*x.y+b.x;vn2=0.0;if(x.y>=0.0&&vn1>=0.0){var d=x.Subtract(a);var P1=normal.Multiply(d.x);var P2=normal.Multiply(d.y);vA=vA.Subtract((P1.Add(P2)).Multiply(mA));wA-=iA*(PhysicsType2d.MathExtensions.Cross2x2(cp1.rA,P1)+PhysicsType2d.MathExtensions.Cross2x2(cp2.rA,P2));vB=vB.Add((P1.Add(P2)).Multiply(mB));wB+=iB*(PhysicsType2d.MathExtensions.Cross2x2(cp1.rB,P1)+PhysicsType2d.MathExtensions.Cross2x2(cp2.rB,P2));cp1.normalImpulse=x.x;cp2.normalImpulse=x.y;break;}
x.x=0.0;x.y=0.0;vn1=b.x;vn2=b.y;if(vn1>=0.0&&vn2>=0.0){var d=x.Subtract(a);var P1=normal.Multiply(d.x);var P2=normal.Multiply(d.y);vA=vA.Subtract((P1.Add(P2)).Multiply(mA));wA-=iA*(PhysicsType2d.MathExtensions.Cross2x2(cp1.rA,P1)+PhysicsType2d.MathExtensions.Cross2x2(cp2.rA,P2));vB=vB.Add((P1.Add(P2)).Multiply(mB));wB+=iB*(PhysicsType2d.MathExtensions.Cross2x2(cp1.rB,P1)+PhysicsType2d.MathExtensions.Cross2x2(cp2.rB,P2));cp1.normalImpulse=x.x;cp2.normalImpulse=x.y;break;}
break;}}
this.m_velocities[indexA].v=vA;this.m_velocities[indexA].w=wA;this.m_velocities[indexB].v=vB;this.m_velocities[indexB].w=wB;}};ContactSolver.prototype.StoreImpulses=function(){for(var i=0;i<this.m_contacts.length;++i){var vc=this.m_velocityConstraints[i];var manifold=this.m_contacts[vc.contactIndex].GetManifold();for(var j=0;j<vc.points.length;++j){manifold.points[j].normalImpulse=vc.points[j].normalImpulse;manifold.points[j].tangentImpulse=vc.points[j].tangentImpulse;}}};ContactSolver.prototype.SolvePositionConstraints=function(){var minSeparation=0.0;for(var i=0;i<this.m_contacts.length;++i){var pc=this.m_positionConstraints[i];var indexA=pc.indexA;var indexB=pc.indexB;var localCenterA=pc.localCenterA;var mA=pc.invMassA;var iA=pc.invIA;var localCenterB=pc.localCenterB;var mB=pc.invMassB;var iB=pc.invIB;var cA=this.m_positions[indexA].c;var aA=this.m_positions[indexA].a;var cB=this.m_positions[indexB].c;var aB=this.m_positions[indexB].a;for(var j=0;j<pc.localPoints.length;++j){var xfA=new PhysicsType2d.Transform();var xfB=new PhysicsType2d.Transform();xfA.q.Set(aA);xfB.q.Set(aB);xfA.p=cA.Subtract(xfA.q.ApplyToVector2(localCenterA));xfB.p=cB.Subtract(xfB.q.ApplyToVector2(localCenterB));var psm=new PositionSolverManifold();psm.Initialize(pc,xfA,xfB,j);var normal=psm.normal;var point=psm.point;var separation=psm.separation;var rA=point.Subtract(cA);var rB=point.Subtract(cB);minSeparation=Math.min(minSeparation,separation);var C=PhysicsType2d.MathExtensions.Clamp(PhysicsType2d.Settings.baumgarte*(separation+PhysicsType2d.Settings.linearSlop),-PhysicsType2d.Settings.maxLinearCorrection,0.0);var rnA=PhysicsType2d.MathExtensions.Cross2x2(rA,normal);var rnB=PhysicsType2d.MathExtensions.Cross2x2(rB,normal);var K=mA+mB+iA*rnA*rnA+iB*rnB*rnB;var impulse=K>0.0?-C/K:0.0;var P=normal.Multiply(impulse);cA=cA.Subtract(P.Multiply(mA));aA-=iA*PhysicsType2d.MathExtensions.Cross2x2(rA,P);cB=cB.Add(P.Multiply(mB));aB+=iB*PhysicsType2d.MathExtensions.Cross2x2(rB,P);}
this.m_positions[indexA].c=cA;this.m_positions[indexA].a=aA;this.m_positions[indexB].c=cB;this.m_positions[indexB].a=aB;}
return minSeparation>=-3.0*PhysicsType2d.Settings.linearSlop;};ContactSolver.prototype.SolveTOIPositionConstraints=function(toiIndexA,toiIndexB){var minSeparation=0.0;for(var i=0;i<this.m_contacts.length;++i){var pc=this.m_positionConstraints[i];var indexA=pc.indexA;var indexB=pc.indexB;var localCenterA=pc.localCenterA;var localCenterB=pc.localCenterB;var mA=0.0;var iA=0.0;if(indexA==toiIndexA||indexA==toiIndexB){mA=pc.invMassA;iA=pc.invIA;}
var mB=pc.invMassB;var iB=pc.invIB;if(indexB==toiIndexA||indexB==toiIndexB){mB=pc.invMassB;iB=pc.invIB;}
var cA=this.m_positions[indexA].c;var aA=this.m_positions[indexA].a;var cB=this.m_positions[indexB].c;var aB=this.m_positions[indexB].a;for(var j=0;j<pc.localPoints.length;++j){var xfA=new PhysicsType2d.Transform();var xfB=new PhysicsType2d.Transform();xfA.q.Set(aA);xfB.q.Set(aB);xfA.p=cA.Subtract(xfA.q.ApplyToVector2(localCenterA));xfB.p=cB.Subtract(xfB.q.ApplyToVector2(localCenterB));var psm=new PositionSolverManifold();psm.Initialize(pc,xfA,xfB,j);var normal=psm.normal;var point=psm.point;var separation=psm.separation;var rA=point.Subtract(cA);var rB=point.Subtract(cB);minSeparation=Math.min(minSeparation,separation);var C=PhysicsType2d.MathExtensions.Clamp(PhysicsType2d.Settings.toiBaugarte*(separation+PhysicsType2d.Settings.linearSlop),-PhysicsType2d.Settings.maxLinearCorrection,0.0);var rnA=PhysicsType2d.MathExtensions.Cross2x2(rA,normal);var rnB=PhysicsType2d.MathExtensions.Cross2x2(rB,normal);var K=mA+mB+iA*rnA*rnA+iB*rnB*rnB;var impulse=K>0.0?-C/K:0.0;var P=normal.Multiply(impulse);cA=cA.Subtract(P.Multiply(mA));aA-=iA*PhysicsType2d.MathExtensions.Cross2x2(rA,P);cB=cB.Add(P.Multiply(mB));aB+=iB*PhysicsType2d.MathExtensions.Cross2x2(rB,P);}
this.m_positions[indexA].c=cA;this.m_positions[indexA].a=aA;this.m_positions[indexB].c=cB;this.m_positions[indexB].a=aB;}
return minSeparation>=-1.5*PhysicsType2d.Settings.linearSlop;};return ContactSolver;})();Contacts.ContactSolver=ContactSolver;})(Dynamics.Contacts||(Dynamics.Contacts={}));var Contacts=Dynamics.Contacts;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){var Island=(function(){function Island(bodyCapacity,contactCapacity,jointCapacity,listener){this.m_bodyCapacity=bodyCapacity;this.m_jointCapacity=jointCapacity;this.m_contactCapacity=contactCapacity;this.m_listener=listener;this.m_bodies=[];this.m_contacts=[];this.m_joints=[];this.m_velocities=[];this.m_positions=[];}
Island.prototype.Destructor=function(){this.m_positions=null;this.m_velocities=null;this.m_joints=null;this.m_contacts=null;this.m_bodies=null;};Island.prototype.GetBody=function(i){return this.m_bodies[i];};Island.prototype.GetContact=function(i){PhysicsType2d.Assert(i<this.m_contacts.length);return this.m_contacts[i];};Island.prototype.GetJoint=function(i){return this.m_joints[i];};Island.prototype.GetBodyCount=function(){return this.m_bodies.length;};Island.prototype.GetBodyCapacity=function(){return this.m_bodyCapacity;};Island.prototype.GetJointCount=function(){return this.m_joints.length;};Island.prototype.GetJointCapacity=function(){return this.m_jointCapacity;};Island.prototype.IntegrateVelocity=function(index,h,gravity){var b=this.m_bodies[index];var sweepClone=b.GetSweep();var c=sweepClone.c;var a=sweepClone.a;var v=b.GetLinearVelocity();var w=b.GetAngularVelocity();b.m_sweep.c0=sweepClone.c;b.m_sweep.a0=sweepClone.a;if(b.GetType()==2){var invMass=b.GetInvMass();var f=b.GetForce();var g=gravity.Multiply(b.GetGravityScale());var deltaV=(g.Add(f.Multiply(invMass))).Multiply(h);v=v.Add(deltaV);w+=h*b.GetInvI()*b.GetTorque();v=v.Multiply(PhysicsType2d.MathExtensions.Clamp(1.0-h*b.GetLinearDamping(),0.0,1.0));w*=PhysicsType2d.MathExtensions.Clamp(1.0-h*b.GetAngularDamping(),0.0,1.0);}
this.m_positions[index]=new PhysicsType2d.Dynamics.Position(c,a);this.m_velocities[index]=new PhysicsType2d.Dynamics.Velocity(v,w);};Island.prototype.Solve=function(step,gravity,allowSleep){var profile=new PhysicsType2d.Dynamics.Profile();var timer=new PhysicsType2d.Timer();var h=step.dt;for(var i=0;i<this.m_bodies.length;++i){this.IntegrateVelocity(i,h,gravity);}
timer.Reset();var solverData=new PhysicsType2d.Dynamics.SolverData(step,this.m_positions,this.m_velocities);var contactSolverDef=new PhysicsType2d.Dynamics.Contacts.ContactSolverDef();contactSolverDef.step=step;contactSolverDef.contacts=this.m_contacts;contactSolverDef.positions=this.m_positions;contactSolverDef.velocities=this.m_velocities;var contactSolver=new PhysicsType2d.Dynamics.Contacts.ContactSolver(contactSolverDef);contactSolver.InitializeVelocityConstraints();if(step.warmStarting){contactSolver.WarmStart();}
for(var i=0;i<this.m_joints.length;++i){this.m_joints[i].InitVelocityConstraints(solverData);}
profile.solveInit=timer.GetMilliseconds();timer.Reset();for(var i=0;i<step.velocityIterations;++i){for(var j=0;j<this.m_joints.length;++j){this.m_joints[j].SolveVelocityConstraints(solverData);}
contactSolver.SolveVelocityConstraints();}
contactSolver.StoreImpulses();profile.solveVelocity=timer.GetMilliseconds();for(var i=0;i<this.m_bodies.length;++i){this.IntegratePosition(i,h);}
timer.Reset();var positionSolved=false;for(var i=0;i<step.positionIterations;++i){var contactsOkay=contactSolver.SolvePositionConstraints();var jointsOkay=true;for(var j=0;j<this.m_joints.length;++j){var jointOkay=this.m_joints[j].SolvePositionConstraints(solverData);jointsOkay=jointsOkay&&jointOkay;}
if(contactsOkay&&jointsOkay){positionSolved=true;break;}}
for(var i=0;i<this.m_bodies.length;++i){var body=this.m_bodies[i];body.m_sweep.c=this.m_positions[i].c;body.m_sweep.a=this.m_positions[i].a;body.SetLinearVelocity(this.m_velocities[i].v);body.SetAngularVelocity(this.m_velocities[i].w);body.SynchronizeTransform();}
profile.solvePosition=timer.GetMilliseconds();this.Report(contactSolver.m_velocityConstraints);if(allowSleep){var minSleepTime=PhysicsType2d.Constants.MAX_FLOAT;var linTolSqr=PhysicsType2d.Settings.linearSleepTolerance*PhysicsType2d.Settings.linearSleepTolerance;var angTolSqr=PhysicsType2d.Settings.angularSleepTolerance*PhysicsType2d.Settings.angularSleepTolerance;for(var i=0;i<this.m_bodies.length;++i){var b=this.m_bodies[i];if(b.GetType()==0){continue;}
if((!b.IsFlagSet(4))||b.GetAngularVelocity()*b.GetAngularVelocity()>angTolSqr||b.GetLinearVelocity().Dot(b.GetLinearVelocity())>linTolSqr){b.SetSleepTime(0.0);minSleepTime=0.0;}else{b.SetSleepTime(b.GetSleepTime()+h);minSleepTime=Math.min(minSleepTime,b.GetSleepTime());}}
if(minSleepTime>=PhysicsType2d.Settings.timeToSleep&&positionSolved){for(var i=0;i<this.m_bodies.length;++i){var b=this.m_bodies[i];b.SetAwake(false);}}}
return profile;};Island.prototype.IntegratePosition=function(index,h){var c=this.m_positions[index].c;var a=this.m_positions[index].a;var v=this.m_velocities[index].v;var w=this.m_velocities[index].w;var translation=v.Multiply(h);if(translation.Dot(translation)>PhysicsType2d.Settings.maxTranslationSquared){var ratio=PhysicsType2d.Settings.maxTranslation/translation.Length();v=v.Multiply(ratio);}
var rotation=h*w;if(rotation*rotation>PhysicsType2d.Settings.maxRotationSquared){var ratio=PhysicsType2d.Settings.maxRotation/Math.abs(rotation);w*=ratio;}
c=c.Add(v.Multiply(h));a+=h*w;this.m_positions[index]=new PhysicsType2d.Dynamics.Position(c,a);this.m_velocities[index]=new PhysicsType2d.Dynamics.Velocity(v,w);};Island.prototype.SolveTOI=function(subStep,toiIndexA,toiIndexB){PhysicsType2d.Assert(toiIndexA<this.m_bodies.length);PhysicsType2d.Assert(toiIndexB<this.m_bodies.length);for(var i=0;i<this.m_bodies.length;++i){var b=this.m_bodies[i];var sweep=b.GetSweep();this.m_positions[i]=new PhysicsType2d.Dynamics.Position(sweep.c,sweep.a);this.m_velocities[i]=new PhysicsType2d.Dynamics.Velocity(b.GetLinearVelocity(),b.GetAngularVelocity());}
var contactSolverDef=new PhysicsType2d.Dynamics.Contacts.ContactSolverDef();contactSolverDef.contacts=this.m_contacts;contactSolverDef.step=subStep;contactSolverDef.positions=this.m_positions;contactSolverDef.velocities=this.m_velocities;var contactSolver=new PhysicsType2d.Dynamics.Contacts.ContactSolver(contactSolverDef);for(var i=0;i<subStep.positionIterations;++i){var contactsOkay=contactSolver.SolveTOIPositionConstraints(toiIndexA,toiIndexB);if(contactsOkay){break;}}
this.m_bodies[toiIndexA].m_sweep.c0=this.m_positions[toiIndexA].c;this.m_bodies[toiIndexA].m_sweep.a0=this.m_positions[toiIndexA].a;this.m_bodies[toiIndexB].m_sweep.c0=this.m_positions[toiIndexB].c;this.m_bodies[toiIndexB].m_sweep.a0=this.m_positions[toiIndexB].a;contactSolver.InitializeVelocityConstraints();for(var i=0;i<subStep.velocityIterations;++i){contactSolver.SolveVelocityConstraints();}
var h=subStep.dt;for(var i=0;i<this.m_bodies.length;++i){var c=this.m_positions[i].c;var a=this.m_positions[i].a;var v=this.m_velocities[i].v;var w=this.m_velocities[i].w;var translation=v.Multiply(h);if(translation.Dot(translation)>PhysicsType2d.Settings.maxTranslationSquared){var ratio=PhysicsType2d.Settings.maxTranslation/translation.Length();v=v.Multiply(ratio);}
var rotation=h*w;if(rotation*rotation>PhysicsType2d.Settings.maxRotationSquared){var ratio=PhysicsType2d.Settings.maxRotation/Math.abs(rotation);w*=ratio;}
c=c.Add(v.Multiply(h));a+=h*w;this.m_positions[i]=new PhysicsType2d.Dynamics.Position(c,a);this.m_velocities[i]=new PhysicsType2d.Dynamics.Velocity(v,w);var body=this.m_bodies[i];body.m_sweep.c=c;body.m_sweep.a=a;body.SetLinearVelocity(v);body.SetAngularVelocity(w);body.SynchronizeTransform();}
this.Report(contactSolver.m_velocityConstraints);};Island.prototype.Report=function(constraints){if(this.m_listener==null){return;}
for(var i=0;i<this.m_contacts.length;++i){var c=this.m_contacts[i];var vc=constraints[i];var impulse=new PhysicsType2d.Dynamics.ContactImpulse();for(var j=0;j<vc.points.length;++j){impulse.normalImpulses[j]=vc.points[j].normalImpulse;impulse.tangentImpulses[j]=vc.points[j].tangentImpulse;}
this.m_listener.PostSolve(c,impulse);}};Island.prototype.GetContactCount=function(){return this.m_contacts.length;};Island.prototype.GetContactCapacity=function(){return this.m_contactCapacity;};Island.prototype.Clear=function(){this.m_bodies=[];this.m_contacts=[];this.m_joints=[];};Island.prototype.AddBody=function(body){PhysicsType2d.Assert(this.m_bodies.length<this.m_bodyCapacity);body.SetIslandIndex(this.m_bodies.length);this.m_bodies.push(body);};Island.prototype.AddContact=function(contact){PhysicsType2d.Assert(this.m_contacts.length<this.m_contactCapacity);this.m_contacts.push(contact);};Island.prototype.AddJoint=function(joint){PhysicsType2d.Assert(this.m_joints.length<this.m_jointCapacity);this.m_joints.push(joint);};return Island;})();Dynamics.Island=Island;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){var ContactFilter=(function(){function ContactFilter(){}
ContactFilter.prototype.Destructor=function(){};ContactFilter.prototype.ShouldCollide=function(fixtureA,fixtureB){var filterA=fixtureA.GetFilterData();var filterB=fixtureB.GetFilterData();if(filterA.groupIndex==filterB.groupIndex&&filterA.groupIndex!=0){return filterA.groupIndex>0;}
var collide=(filterA.maskBits&filterB.categoryBits)!=0&&(filterA.categoryBits&filterB.maskBits)!=0;return collide;};return ContactFilter;})();Dynamics.ContactFilter=ContactFilter;var ContactImpulse=(function(){function ContactImpulse(){this.normalImpulses=[];this.tangentImpulses=[];}
ContactImpulse.prototype.Clone=function(){var clone=new ContactImpulse();clone.normalImpulses=this.normalImpulses.slice(0);clone.tangentImpulses=this.tangentImpulses.slice(0);return clone;};return ContactImpulse;})();Dynamics.ContactImpulse=ContactImpulse;var ContactListener=(function(){function ContactListener(){}
ContactListener.prototype.Destructor=function(){};ContactListener.prototype.BeginContact=function(contact){};ContactListener.prototype.EndContact=function(contact){};ContactListener.prototype.PreSolve=function(contact,oldManifold){};ContactListener.prototype.PostSolve=function(contact,impulse){};return ContactListener;})();Dynamics.ContactListener=ContactListener;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){var defaultFilter=new PhysicsType2d.Dynamics.ContactFilter();var defaultListener=new PhysicsType2d.Dynamics.ContactListener();var ContactManager=(function(){function ContactManager(){this.m_contactList=new PhysicsType2d.LinkedList();this.m_contactFilter=defaultFilter;this.m_contactListener=defaultListener;this.m_broadPhase=new PhysicsType2d.Collision.BroadPhase();}
ContactManager.prototype.Destroy=function(c){var fixtureA=c.GetFixtureA();var fixtureB=c.GetFixtureB();var bodyA=fixtureA.GetBody();var bodyB=fixtureB.GetBody();if(this.m_contactListener&&c.IsTouching()){this.m_contactListener.EndContact(c);}
this.m_contactList.Remove(c);bodyA.RemoveContactEdge(c.m_nodeA);bodyB.RemoveContactEdge(c.m_nodeB);c.Destructor();};ContactManager.prototype.Collide=function(){var iter=this.m_contactList.GetIterator();while(iter.MoveNext()){var c=iter.Current();var fixtureA=c.GetFixtureA();var fixtureB=c.GetFixtureB();var indexA=c.GetChildIndexA();var indexB=c.GetChildIndexB();var bodyA=fixtureA.GetBody();var bodyB=fixtureB.GetBody();if(c.IsFlagSet(8)){if(bodyB.ShouldCollide(bodyA)==false){this.Destroy(c);continue;}
if(this.m_contactFilter&&this.m_contactFilter.ShouldCollide(fixtureA,fixtureB)==false){this.Destroy(c);continue;}
c.ClearFlag(8);}
var activeA=bodyA.IsAwake()&&bodyA.GetType()!=0;var activeB=bodyB.IsAwake()&&bodyB.GetType()!=0;if(activeA==false&&activeB==false){continue;}
var proxyIdA=fixtureA.GetProxy(indexA).proxyId;var proxyIdB=fixtureB.GetProxy(indexB).proxyId;var overlap=this.m_broadPhase.TestOverlap(proxyIdA,proxyIdB);if(overlap==false){this.Destroy(c);continue;}
c.Update(this.m_contactListener);}};ContactManager.prototype.FindNewContacts=function(){this.m_broadPhase.UpdatePairs(this);};ContactManager.prototype.AddPair=function(proxyUserDataA,proxyUserDataB){var proxyA=proxyUserDataA;var proxyB=proxyUserDataB;var fixtureA=proxyA.fixture;var fixtureB=proxyB.fixture;var indexA=proxyA.childIndex;var indexB=proxyB.childIndex;var bodyA=fixtureA.GetBody();var bodyB=fixtureB.GetBody();if(bodyA==bodyB){return;}
var edgeIterator=bodyB.GetContactEdges();while(edgeIterator.MoveNext()){var edge=edgeIterator.Current();if(edge.other==bodyA){var fA=edge.contact.GetFixtureA();var fB=edge.contact.GetFixtureB();var iA=edge.contact.GetChildIndexA();var iB=edge.contact.GetChildIndexB();if(fA==fixtureA&&fB==fixtureB&&iA==indexA&&iB==indexB){return;}
if(fA==fixtureB&&fB==fixtureA&&iA==indexB&&iB==indexA){return;}}}
if(bodyB.ShouldCollide(bodyA)==false){return;}
if(this.m_contactFilter&&this.m_contactFilter.ShouldCollide(fixtureA,fixtureB)==false){return;}
var c=PhysicsType2d.Dynamics.Contacts.Contact.Create(fixtureA,indexA,fixtureB,indexB);if(c==null){return;}
fixtureA=c.GetFixtureA();fixtureB=c.GetFixtureB();indexA=c.GetChildIndexA();indexB=c.GetChildIndexB();bodyA=fixtureA.GetBody();bodyB=fixtureB.GetBody();this.m_contactList.Add(c);c.m_nodeA.contact=c;c.m_nodeA.other=bodyB;bodyA.AddContactEdge(c.m_nodeA);c.m_nodeB.contact=c;c.m_nodeB.other=bodyA;bodyB.AddContactEdge(c.m_nodeB);bodyA.SetAwake(true);bodyB.SetAwake(true);};ContactManager.prototype.GetContactList=function(){return this.m_contactList.GetIterator();};ContactManager.prototype.Count=function(){return this.m_contactList.Count();};return ContactManager;})();Dynamics.ContactManager=ContactManager;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(WorldFlags){WorldFlags[WorldFlags["NEW_FIXTURE"]=0x0001]="NEW_FIXTURE";WorldFlags[WorldFlags["LOCKED"]=0x0002]="LOCKED";WorldFlags[WorldFlags["CLEAR_FORCES"]=0x0004]="CLEAR_FORCES";})(Dynamics.WorldFlags||(Dynamics.WorldFlags={}));var WorldFlags=Dynamics.WorldFlags;var WorldQueryWrapper=(function(){function WorldQueryWrapper(){}
WorldQueryWrapper.prototype.QueryCallback=function(proxyId){var proxy=this.broadPhase.GetUserData(proxyId);return this.callback.ReportFixture(proxy.fixture);};WorldQueryWrapper.prototype.Clone=function(){var clone=new WorldQueryWrapper();clone.broadPhase=this.broadPhase;clone.callback=this.callback;return clone;};return WorldQueryWrapper;})();Dynamics.WorldQueryWrapper=WorldQueryWrapper;var WorldRayCastWrapper=(function(){function WorldRayCastWrapper(){}
WorldRayCastWrapper.prototype.RayCastCallback=function(input,proxyId){var userData=this.broadPhase.GetUserData(proxyId);var proxy=userData;var fixture=proxy.fixture;var index=proxy.childIndex;var output=fixture.RayCast(input,index);if(null!==output){var fraction=output.fraction;var point=(input.p1.Multiply(1.0-fraction)).Add(input.p2.Multiply(fraction));return this.callback.ReportFixture(fixture,point,output.normal,fraction);}
return input.maxFraction;};WorldRayCastWrapper.prototype.Clone=function(){var clone=new WorldRayCastWrapper();clone.broadPhase=this.broadPhase;clone.callback=this.callback;return clone;};return WorldRayCastWrapper;})();Dynamics.WorldRayCastWrapper=WorldRayCastWrapper;var World=(function(){function World(gravity){this.m_gravity=new PhysicsType2d.Vector2(0,0);this.m_destructionListener=null;this.m_debugDraw=null;this.m_bodyList=new PhysicsType2d.LinkedList();this.m_jointList=new PhysicsType2d.LinkedList();this.m_contactManager=new PhysicsType2d.Dynamics.ContactManager();this.m_warmStarting=true;this.m_continuousPhysics=true;this.m_subStepping=false;this.m_stepComplete=true;this.m_allowSleep=true;this.m_gravity=gravity;this.m_flags=new PhysicsType2d.BitFlag(4);this.m_inv_dt0=0.0;this.m_profile=new PhysicsType2d.Dynamics.Profile();}
World.prototype.GetBodyList=function(){return this.m_bodyList.GetIterator();};World.prototype.GetJoints=function(){return this.m_jointList.GetIterator();};World.prototype.GetContactList=function(){return this.m_contactManager.GetContactList();};World.prototype.GetBodyCount=function(){return this.m_bodyList.Count();};World.prototype.GetJointCount=function(){return this.m_jointList.Count();};World.prototype.GetContactCount=function(){return this.m_contactManager.Count();};World.prototype.SetGravity=function(gravity){this.m_gravity=gravity;};World.prototype.GetGravity=function(){return this.m_gravity;};World.prototype.IsLocked=function(){return this.IsFlagSet(2);};World.prototype.SetAutoClearForces=function(flag){if(flag){this.SetFlag(4);}else{this.ClearFlag(4);}};World.prototype.GetAutoClearForces=function(){return this.IsFlagSet(4);};World.prototype.GetContactManager=function(){return this.m_contactManager;};World.prototype.GetProfile=function(){return this.m_profile;};World.prototype.Destructor=function(){var iter=this.m_bodyList.GetIterator();while(iter.MoveNext()){var f=iter.Current().GetFixtures();while(f.MoveNext()){f.Current().Destroy(true);}}};World.prototype.SetDestructionListener=function(listener){this.m_destructionListener=listener;};World.prototype.SetContactFilter=function(filter){this.m_contactManager.m_contactFilter=filter;};World.prototype.SetContactListener=function(listener){this.m_contactManager.m_contactListener=listener;};World.prototype.SetDebugDraw=function(debugDraw){this.m_debugDraw=debugDraw;};World.prototype.CreateBody=function(def){PhysicsType2d.Assert(this.IsLocked()==false);if(this.IsLocked()){return null;}
var b=PhysicsType2d.Dynamics.Body.FromDefinition(def,this);this.m_bodyList.Add(b);return b;};World.prototype.DestroyBody=function(b){PhysicsType2d.Assert(this.m_bodyList.Count()>0);PhysicsType2d.Assert(this.IsLocked()==false);if(this.IsLocked()){return;}
var je=b.GetJointEdges();while(je.MoveNext()){var je0=je.Current();if(this.m_destructionListener){this.m_destructionListener.SayGoodbyeJoint(je0.joint);}
this.DestroyJoint(je0.joint);}
b.ClearJointEdges();var ce=b.GetContactEdges();while(ce.MoveNext()){this.m_contactManager.Destroy(ce.Current().contact);}
b.ClearContactEdges();var fList=b.GetFixtures();while(fList.MoveNext()){var f0=fList.Current();if(this.m_destructionListener){this.m_destructionListener.SayGoodbyeFixture(f0);}
f0.DestroyProxies(this.m_contactManager.m_broadPhase);f0.Destroy();f0=null;}
b.ClearFixtures();this.m_bodyList.Remove(b);b=null;};World.prototype.CreateJoint=function(def){PhysicsType2d.Assert(this.IsLocked()==false);if(this.IsLocked()){return null;}
var j=PhysicsType2d.Dynamics.Joints.Joint.Create(def);this.m_jointList.Add(j);j.m_edgeA.joint=j;j.m_edgeA.other=j.m_bodyB;j.m_bodyA.AddJointEdge(j.m_edgeA);j.m_edgeB.joint=j;j.m_edgeB.other=j.m_bodyA;j.m_bodyB.AddJointEdge(j.m_edgeB);var bodyA=def.bodyA;var bodyB=def.bodyB;if(def.collideConnected==false){var contacts=bodyB.GetContactEdges();while(contacts.MoveNext()){var edge=contacts.Current();if(edge.other==bodyA){edge.contact.FlagForFiltering();}}}
return j;};World.prototype.DestroyJoint=function(j){PhysicsType2d.Assert(this.IsLocked()==false);PhysicsType2d.Assert(this.m_jointList.Count()>0);if(this.IsLocked()){return;}
var collideConnected=j.m_collideConnected;this.m_jointList.Remove(j);var bodyA=j.m_bodyA;var bodyB=j.m_bodyB;bodyA.SetAwake(true);bodyB.SetAwake(true);PhysicsType2d.Assert(bodyA.RemoveJointEdge(j.m_edgeA));PhysicsType2d.Assert(bodyB.RemoveJointEdge(j.m_edgeB));j=null;if(collideConnected==false){var contacts=bodyB.GetContactEdges();while(contacts.MoveNext()){var edge=contacts.Current();if(edge.other==bodyA){edge.contact.FlagForFiltering();}}}};World.prototype.GetAllowSleeping=function(){return this.m_allowSleep;};World.prototype.SetAllowSleeping=function(flag){if(flag==this.m_allowSleep){return;}
this.m_allowSleep=flag;if(this.m_allowSleep==false){var bodies=this.m_bodyList.GetIterator();while(bodies.MoveNext()){bodies.Current().SetAwake(true);}}};World.prototype.Solve=function(step){this.m_profile.solveInit=0.0;this.m_profile.solveVelocity=0.0;this.m_profile.solvePosition=0.0;var island=new PhysicsType2d.Dynamics.Island(this.m_bodyList.Count(),this.m_contactManager.Count(),this.m_jointList.Count(),this.m_contactManager.m_contactListener);var bodyIter=this.m_bodyList.GetIterator();while(bodyIter.MoveNext()){bodyIter.Current().ClearFlag(1);}
var contactIter=this.m_contactManager.GetContactList();while(contactIter.MoveNext()){contactIter.Current().ClearFlag(1);}
var jointIter=this.m_jointList.GetIterator();while(jointIter.MoveNext()){jointIter.Current().m_islandFlag=false;}
var stackSize=this.m_bodyList.Count();var stack=new Array(stackSize);var bodyIter=this.m_bodyList.GetIterator();while(bodyIter.MoveNext()){var seed=bodyIter.Current();if(seed.IsFlagSet(1)){continue;}
if(seed.IsAwake()==false||seed.IsActive()==false){continue;}
if(seed.GetType()==0){continue;}
island.Clear();var stackCount=0;stack[stackCount++]=seed;seed.SetFlag(1);while(stackCount>0){var b=stack[--stackCount];PhysicsType2d.Assert(b.IsActive()==true);island.AddBody(b);b.SetAwake(true);if(b.GetType()==0){continue;}
var cIter=b.GetContactEdges();while(cIter.MoveNext()){var ce=cIter.Current();var contact=ce.contact;if(contact.IsFlagSet(1)){continue;}
if(contact.IsEnabled()==false||contact.IsTouching()==false){continue;}
var sensorA=contact.GetFixtureA().IsSensor();var sensorB=contact.GetFixtureB().IsSensor();if(sensorA||sensorB){continue;}
island.AddContact(contact);contact.SetFlag(1);var other=ce.other;if(other.IsFlagSet(1)){continue;}
PhysicsType2d.Assert(stackCount<stackSize);stack[stackCount++]=other;other.SetFlag(1);}
var jIter=b.GetJointEdges();while(jIter.MoveNext()){var je=jIter.Current();if(je.joint.m_islandFlag==true){continue;}
var other=je.other;if(other.IsActive()==false){continue;}
island.AddJoint(je.joint);je.joint.m_islandFlag=true;if(other.IsFlagSet(1)){continue;}
PhysicsType2d.Assert(stackCount<stackSize);stack[stackCount++]=other;other.SetFlag(1);}}
var profile=island.Solve(step,this.m_gravity,this.m_allowSleep);this.m_profile.solveInit+=profile.solveInit;this.m_profile.solveVelocity+=profile.solveVelocity;this.m_profile.solvePosition+=profile.solvePosition;for(var i=0;i<island.GetBodyCount();++i){var b=island.GetBody(i);if(b.GetType()==0){b.ClearFlag(1);}}}
(function(self){var timer=new PhysicsType2d.Timer();var iter=self.m_bodyList.GetIterator();while(iter.MoveNext()){var b=iter.Current();if(!b.IsFlagSet(1)){continue;}
if(b.GetType()==0){continue;}
b.SynchronizeFixtures();}
self.m_contactManager.FindNewContacts();self.m_profile.broadphase=timer.GetMilliseconds();})(this);};World.prototype.InvalidateTOI=function(){var bodyIter=this.m_bodyList.GetIterator();while(bodyIter.MoveNext()){var b=bodyIter.Current();b.ClearFlag(1);b.m_sweep.alpha0=0.0;}
var contactIter=this.m_contactManager.GetContactList();while(contactIter.MoveNext()){var c=contactIter.Current();c.ClearFlag(32);c.ClearFlag(1);c.m_toiCount=0;c.m_toi=1.0;}};World.prototype.SolveTOI=function(step){var island=new PhysicsType2d.Dynamics.Island(2*PhysicsType2d.Settings.maxTOIContacts,PhysicsType2d.Settings.maxTOIContacts,0,this.m_contactManager.m_contactListener);if(this.m_stepComplete){this.InvalidateTOI();}
var hasMore=true;while(hasMore){hasMore=this.FindTOI(island,step);}};World.prototype.ComputeTOIContact=function(c){var fA=c.GetFixtureA();var fB=c.GetFixtureB();var bA=fA.GetBody();var bB=fB.GetBody();var sweepA=bA.GetSweep();var sweepB=bB.GetSweep();var alpha0=sweepA.alpha0;if(sweepA.alpha0<sweepB.alpha0){alpha0=sweepB.alpha0;bA.m_sweep.Advance(alpha0);}else if(sweepB.alpha0<sweepA.alpha0){bB.m_sweep.Advance(alpha0);}
PhysicsType2d.Assert(alpha0<1.0);var indexA=c.GetChildIndexA();var indexB=c.GetChildIndexB();var input=new PhysicsType2d.Collision.TOIInput();input.proxyA.Set(fA.GetShape(),indexA);input.proxyB.Set(fB.GetShape(),indexB);input.sweepA=bA.GetSweep();input.sweepB=bB.GetSweep();input.tMax=1.0;var output=PhysicsType2d.Collision.TimeOfImpact(input);var beta=output.t;if(output.state==3){return Math.min(alpha0+(1.0-alpha0)*beta,1.0);}
return 1.0;};World.prototype.FindMinimum=function(){var minContact=null;var minAlpha=1.0;var contactIter=this.m_contactManager.GetContactList();while(contactIter.MoveNext()){var c=contactIter.Current();if(c.IsEnabled()==false){continue;}
if(c.m_toiCount>PhysicsType2d.Settings.maxSubSteps){continue;}
var alpha=1.0;if(c.IsFlagSet(32)){alpha=c.m_toi;}else{var fA=c.GetFixtureA();var fB=c.GetFixtureB();if(fA.IsSensor()||fB.IsSensor()){continue;}
var bA=fA.GetBody();var bB=fB.GetBody();var typeA=bA.GetType();var typeB=bB.GetType();PhysicsType2d.Assert(typeA==2||typeB==2);var activeA=bA.IsAwake()&&typeA!=0;var activeB=bB.IsAwake()&&typeB!=0;if(activeA==false&&activeB==false){continue;}
var collideA=bA.IsBullet()||typeA!=2;var collideB=bB.IsBullet()||typeB!=2;if(collideA==false&&collideB==false){continue;}
alpha=this.ComputeTOIContact(c);c.m_toi=alpha;c.SetFlag(32);}
if(alpha<minAlpha){minContact=c;minAlpha=alpha;}}
return{contact:minContact,alpha:minAlpha};};World.prototype.FindTOI=function(island,step){var minimum=this.FindMinimum();var minContact=minimum.contact;var minAlpha=minimum.alpha;if(minContact==null||1.0-10.0*PhysicsType2d.Constants.EPSILON<minAlpha){this.m_stepComplete=true;return false;}
var fA=minContact.GetFixtureA();var fB=minContact.GetFixtureB();var bA=fA.GetBody();var bB=fB.GetBody();var backup1=bA.GetSweep();var backup2=bB.GetSweep();bA.Advance(minAlpha);bB.Advance(minAlpha);minContact.Update(this.m_contactManager.m_contactListener);minContact.ClearFlag(32);++minContact.m_toiCount;if(minContact.IsEnabled()==false||minContact.IsTouching()==false){minContact.SetEnabled(false);bA.SetSweep(backup1);bB.SetSweep(backup2);bA.SynchronizeTransform();bB.SynchronizeTransform();return true;}
bA.SetAwake(true);bB.SetAwake(true);island.Clear();island.AddBody(bA);island.AddBody(bB);island.AddContact(minContact);bA.SetFlag(1);bB.SetFlag(1);minContact.SetFlag(1);var bodies=[bA,bB];for(var i=0;i<2;++i){var body=bodies[i];if(body.GetType()==2){var cIter=body.GetContactEdges();while(cIter.MoveNext()){var ce=cIter.Current();if(island.GetBodyCount()==island.GetBodyCapacity()){break;}
if(island.GetContactCount()==island.GetContactCapacity()){break;}
var contact=ce.contact;if(contact.IsFlagSet(1)){continue;}
var other=ce.other;if(other.GetType()==2&&body.IsBullet()==false&&other.IsBullet()==false){continue;}
var sensorA=contact.GetFixtureA().IsSensor();var sensorB=contact.GetFixtureB().IsSensor();if(sensorA||sensorB){continue;}
var backup=other.GetSweep();if(!other.IsFlagSet(1)){other.Advance(minAlpha);}
contact.Update(this.m_contactManager.m_contactListener);if(contact.IsEnabled()==false){other.SetSweep(backup);other.SynchronizeTransform();continue;}
if(contact.IsTouching()==false){other.SetSweep(backup);other.SynchronizeTransform();continue;}
contact.SetFlag(1);island.AddContact(contact);if(other.IsFlagSet(1)){continue;}
other.SetFlag(1);if(other.GetType()!=0){other.SetAwake(true);}
island.AddBody(other);}}}
var subStep=new PhysicsType2d.Dynamics.TimeStep();subStep.dt=(1.0-minAlpha)*step.dt;subStep.inv_dt=1.0/subStep.dt;subStep.dtRatio=1.0;subStep.positionIterations=20;subStep.velocityIterations=step.velocityIterations;subStep.warmStarting=false;island.SolveTOI(subStep,bA.GetIslandIndex(),bB.GetIslandIndex());for(var i=0;i<island.GetBodyCount();++i){var body=island.GetBody(i);body.ClearFlag(1);if(body.GetType()!=2){continue;}
body.SynchronizeFixtures();var cIter=body.GetContactEdges();while(cIter.MoveNext()){var ce=cIter.Current();ce.contact.ClearFlag(32);ce.contact.ClearFlag(1);}}
this.m_contactManager.FindNewContacts();if(this.m_subStepping){this.m_stepComplete=false;return false;}
return true;};World.prototype.Step=function(dt,velocityIterations,positionIterations){var stepTimer=new PhysicsType2d.Timer();if(this.IsFlagSet(1)){this.m_contactManager.FindNewContacts();this.ClearFlag(1);}
this.SetFlag(2);var step=new PhysicsType2d.Dynamics.TimeStep();step.dt=dt;step.velocityIterations=velocityIterations;step.positionIterations=positionIterations;if(dt>0.0){step.inv_dt=1.0/dt;}else{step.inv_dt=0.0;}
step.dtRatio=this.m_inv_dt0*dt;step.warmStarting=this.m_warmStarting;var timer=new PhysicsType2d.Timer();this.m_contactManager.Collide();this.m_profile.collide=timer.GetMilliseconds();timer=null;if(this.m_stepComplete&&step.dt>0.0){timer=new PhysicsType2d.Timer();this.Solve(step);this.m_profile.solve=timer.GetMilliseconds();timer=null;}
if(this.m_continuousPhysics&&step.dt>0.0){timer=new PhysicsType2d.Timer();this.SolveTOI(step);this.m_profile.solveTOI=timer.GetMilliseconds();timer=null;}
if(step.dt>0.0){this.m_inv_dt0=step.inv_dt;}
if(this.IsFlagSet(4)){this.ClearForces();}
this.ClearFlag(2);this.m_profile.step=stepTimer.GetMilliseconds();};World.prototype.ClearForces=function(){var iter=this.m_bodyList.GetIterator();while(iter.MoveNext()){var body=iter.Current();body.SetForce(PhysicsType2d.Vector2.Zero());body.SetTorque(0.0);}};World.prototype.QueryAABB=function(callback,aabb){var wrapper=new WorldQueryWrapper();wrapper.broadPhase=this.m_contactManager.m_broadPhase;wrapper.callback=callback;this.m_contactManager.m_broadPhase.Query(wrapper,aabb);};World.prototype.RayCast=function(callback,point1,point2){var wrapper=new WorldRayCastWrapper();wrapper.broadPhase=this.m_contactManager.m_broadPhase;wrapper.callback=callback;var input=new PhysicsType2d.Collision.RayCastInput();input.maxFraction=1.0;input.p1=point1;input.p2=point2;this.m_contactManager.m_broadPhase.RayCast(wrapper,input);};World.prototype.DrawDebugData=function(){if(this.m_debugDraw==null){return;}
if(this.m_debugDraw.IsFlagSet(1)){var iter=this.m_bodyList.GetIterator();while(iter.MoveNext()){var b=iter.Current();var xf=b.GetTransform();var fList=b.GetFixtures();while(fList.MoveNext()){var f=fList.Current();if(b.IsActive()==false){this.DrawShape(f,xf,this.m_debugDraw.FromRGB(0.5,0.5,0.3));}else if(b.GetType()==0){this.DrawShape(f,xf,this.m_debugDraw.FromRGB(0.5,0.9,0.5));}else if(b.GetType()==1){this.DrawShape(f,xf,this.m_debugDraw.FromRGB(0.5,0.5,0.9));}else if(b.IsAwake()==false){this.DrawShape(f,xf,this.m_debugDraw.FromRGB(0.6,0.6,0.6));}else{this.DrawShape(f,xf,this.m_debugDraw.FromRGB(0.9,0.7,0.7));}}}}
if(this.m_debugDraw.IsFlagSet(2)){var jList=this.m_jointList.GetIterator();while(jList.MoveNext()){this.DrawJoint(jList.Current());}}
if(this.m_debugDraw.IsFlagSet(8)){var color=this.m_debugDraw.FromRGB(0.3,0.9,0.9);var contactIter=this.m_contactManager.GetContactList();while(contactIter.MoveNext()){var c=contactIter.Current();var fixtureA=c.GetFixtureA();var fixtureB=c.GetFixtureB();var cA=fixtureA.GetAABB(c.GetChildIndexA()).GetCenter();var cB=fixtureB.GetAABB(c.GetChildIndexB()).GetCenter();this.m_debugDraw.DrawSegment(cA,cB,color);}}
if(this.m_debugDraw.IsFlagSet(4)){var color=this.m_debugDraw.FromRGB(0.9,0.3,0.9);var bp=this.m_contactManager.m_broadPhase;var iter=this.m_bodyList.GetIterator();while(iter.MoveNext()){var b=iter.Current();if(b.IsActive()==false){continue;}
var fList=b.GetFixtures();while(fList.MoveNext()){var f=fList.Current();var proxies=f.GetProxies();for(var i=0;i<f.GetProxyCount();++i){var proxy=proxies[i];var aabb=bp.GetFatAABB(proxy.proxyId);var vs=[];vs[0]=new PhysicsType2d.Vector2(aabb.lowerBound.x,aabb.lowerBound.y);vs[1]=new PhysicsType2d.Vector2(aabb.upperBound.x,aabb.lowerBound.y);vs[2]=new PhysicsType2d.Vector2(aabb.upperBound.x,aabb.upperBound.y);vs[3]=new PhysicsType2d.Vector2(aabb.lowerBound.x,aabb.upperBound.y);this.m_debugDraw.DrawPolygon(vs,color);}}}}
if(this.m_debugDraw.IsFlagSet(16)){var iter=this.m_bodyList.GetIterator();while(iter.MoveNext()){var b=iter.Current();var xf=b.GetTransform();xf.p=b.GetWorldCenter();this.m_debugDraw.DrawTransform(xf);}}};World.prototype.SetWarmStarting=function(flag){this.m_warmStarting=flag;};World.prototype.GetWarmStarting=function(){return this.m_warmStarting;};World.prototype.SetContinuousPhysics=function(flag){this.m_continuousPhysics=flag;};World.prototype.GetContinuousPhysics=function(){return this.m_continuousPhysics;};World.prototype.SetSubStepping=function(flag){this.m_subStepping=flag;};World.prototype.GetSubStepping=function(){return this.m_subStepping;};World.prototype.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount();};World.prototype.GetTreeHeight=function(){return this.m_contactManager.m_broadPhase.GetTreeHeight();};World.prototype.GetTreeBalance=function(){return this.m_contactManager.m_broadPhase.GetTreeBalance();};World.prototype.GetTreeQuality=function(){return this.m_contactManager.m_broadPhase.GetTreeQuality();};World.prototype.Dump=function(){if(this.IsFlagSet(2)){return;}
PhysicsType2d.Utils.log("Vector2 g({0}, {1});",this.m_gravity.x,this.m_gravity.y);PhysicsType2d.Utils.log("m_world.SetGravity(g);");PhysicsType2d.Utils.log("bodies = {0}",this.m_bodyList.Count());PhysicsType2d.Utils.log("joints = {0}",this.m_jointList.Count());var i=0;var iter=this.m_bodyList.GetIterator();while(iter.MoveNext()){var b=iter.Current();b.SetIslandIndex(i);b.Dump();++i;}
i=0;var jList=this.m_jointList.GetIterator();while(jList.MoveNext()){var j=jList.Current();j.m_index=i;++i;}
var jList=this.m_jointList.GetIterator();while(jList.MoveNext()){var j=jList.Current();if(j.m_type==6){continue;}
PhysicsType2d.Utils.log("{");j.Dump();PhysicsType2d.Utils.log("}");}
var jList=this.m_jointList.GetIterator();while(jList.MoveNext()){var j=jList.Current();if(j.m_type!=6){continue;}
PhysicsType2d.Utils.log("{");j.Dump();PhysicsType2d.Utils.log("}");}
PhysicsType2d.Utils.log("joints = null;");PhysicsType2d.Utils.log("bodies = null;");};World.prototype.DrawJoint=function(joint){var bodyA=joint.GetBodyA();var bodyB=joint.GetBodyB();var xf1=bodyA.GetTransform();var xf2=bodyB.GetTransform();var x1=xf1.p;var x2=xf2.p;var p1=joint.GetAnchorA();var p2=joint.GetAnchorB();var color=this.m_debugDraw.FromRGB(0.5,0.8,0.8);switch(joint.GetType()){case 3:this.m_debugDraw.DrawSegment(p1,p2,color);break;case 4:{var pulley=joint;var s1=pulley.GetGroundAnchorA();var s2=pulley.GetGroundAnchorB();this.m_debugDraw.DrawSegment(s1,p1,color);this.m_debugDraw.DrawSegment(s2,p2,color);this.m_debugDraw.DrawSegment(s1,s2,color);}
break;case 5:break;default:this.m_debugDraw.DrawSegment(x1,p1,color);this.m_debugDraw.DrawSegment(p1,p2,color);this.m_debugDraw.DrawSegment(x2,p2,color);}};World.prototype.DrawShape=function(fixture,xf,color){switch(fixture.GetType()){case 0:{var circle=fixture.GetShape();var center=xf.ApplyToVector2(circle.m_p);var radius=circle.m_radius;var axis=xf.q.ApplyToVector2(new PhysicsType2d.Vector2(1.0,0.0));this.m_debugDraw.DrawSolidCircle(center,radius,axis,color);}
break;case 1:{var edge=fixture.GetShape();var v1=xf.ApplyToVector2(edge.m_vertex1);var v2=xf.ApplyToVector2(edge.m_vertex2);this.m_debugDraw.DrawSegment(v1,v2,color);}
break;case 3:{var chain=fixture.GetShape();var count=chain.m_vertices.length;var vertices=chain.m_vertices;var v1=xf.ApplyToVector2(vertices[0]);for(var i=1;i<count;++i){var v2=xf.ApplyToVector2(vertices[i]);this.m_debugDraw.DrawSegment(v1,v2,color);this.m_debugDraw.DrawCircle(v1,0.05,color);v1=v2;}}
break;case 2:{var poly=fixture.GetShape();var vertexCount=poly.m_vertices.length;PhysicsType2d.Assert(vertexCount<=PhysicsType2d.Settings.maxPolygonVertices);var vertices=[];for(var i=0;i<vertexCount;++i){vertices[i]=xf.ApplyToVector2(poly.m_vertices[i]);}
this.m_debugDraw.DrawSolidPolygon(vertices,color);}
break;default:break;}};World.prototype.SetFlag=function(flag){this.m_flags.Set(flag);};World.prototype.ClearFlag=function(flag){this.m_flags.Clear(flag);};World.prototype.IsFlagSet=function(desiredFlags){return this.m_flags.IsSet(desiredFlags);};return World;})();Dynamics.World=World;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var JointEdge=(function(){function JointEdge(){}
return JointEdge;})();Joints.JointEdge=JointEdge;;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){var Body=(function(){function Body(){this.m_linearVelocity=new PhysicsType2d.Vector2(0,0);this.m_force=new PhysicsType2d.Vector2(0,0);this.m_xf=new PhysicsType2d.Transform();this.m_sweep=new PhysicsType2d.Sweep();}
Body.prototype.CreateFixtureFromDefinition=function(def){PhysicsType2d.Assert(this.m_world.IsLocked()===false);if(this.m_world.IsLocked()===true){return null;}
var fixture=PhysicsType2d.Dynamics.Fixture.Create(this,def);if(this.m_flags.IsSet(32)){var broadPhase=this.m_world.GetContactManager().m_broadPhase;fixture.CreateProxies(broadPhase,this.m_xf);}
this.m_fixtureList.Add(fixture);fixture.SetBody(this);if(fixture.GetDensity()>0.0){this.ResetMassData();}
this.m_world.SetFlag(1);return fixture;};Body.prototype.CreateFixture=function(shape,density){var def=new PhysicsType2d.Dynamics.FixtureDefinition();def.shape=shape;def.density=density;return this.CreateFixtureFromDefinition(def);};Body.prototype.DestroyFixture=function(fixture){PhysicsType2d.Assert(this.m_world.IsLocked()===false);if(this.m_world.IsLocked()===true){return;}
PhysicsType2d.Assert(fixture.GetBody()===this);PhysicsType2d.Assert(this.m_fixtureList.Remove(fixture));this.DestroyAssociatedContacts(fixture);if(this.m_flags.IsSet(32)){var broadPhase=this.m_world.GetContactManager().m_broadPhase;fixture.DestroyProxies(broadPhase);}
fixture.Destroy();fixture.ClearBody();fixture=null;this.ResetMassData();};Body.prototype.DestroyAssociatedContacts=function(fixture){var iterator=this.m_contactEdgeList.GetIterator();while(iterator.MoveNext()){var edge=iterator.Current();var c=edge.contact;var fixtureA=c.GetFixtureA();var fixtureB=c.GetFixtureB();if(fixture==fixtureA||fixture==fixtureB){this.m_contactEdgeList.DeleteCurrent(iterator);this.m_world.GetContactManager().Destroy(c);}}};Body.prototype.SetTransform=function(position,angle){PhysicsType2d.Assert(this.m_world.IsLocked()==false);if(this.m_world.IsLocked()==true){return;}
this.m_xf.q.Set(angle);this.m_xf.p=position.Clone();this.m_sweep.c=this.m_xf.ApplyToVector2(this.m_sweep.localCenter);this.m_sweep.a=angle;this.m_sweep.c0=this.m_sweep.c;this.m_sweep.a0=angle;var broadPhase=this.m_world.GetContactManager().m_broadPhase;var iterator=this.m_fixtureList.GetIterator();while(iterator.MoveNext()){iterator.Current().Synchronize(broadPhase,this.m_xf,this.m_xf);}
this.m_world.GetContactManager().FindNewContacts();};Body.prototype.GetTransform=function(){return this.m_xf.Clone();};Body.prototype.GetPosition=function(){return this.m_xf.p.Clone();};Body.prototype.GetAngle=function(){return this.m_sweep.a;};Body.prototype.GetWorldCenter=function(){return this.m_sweep.c;};Body.prototype.GetLocalCenter=function(){return this.m_sweep.localCenter.Clone();};Body.prototype.SetLinearVelocity=function(v){if(this.m_type==0){return;}
if(v.Dot(v)>0.0){this.SetAwake(true);}
this.m_linearVelocity=v.Clone();};Body.prototype.GetLinearVelocity=function(){return this.m_linearVelocity.Clone();};Body.prototype.SetAngularVelocity=function(omega){if(this.m_type==0){return;}
if(omega*omega>0.0){this.SetAwake(true);}
this.m_angularVelocity=omega;};Body.prototype.GetAngularVelocity=function(){return this.m_angularVelocity;};Body.prototype.ApplyForce=function(force,point){if(this.m_type!=2){return;}
if(this.IsAwake()==false){this.SetAwake(true);}
this.m_force=this.m_force.Add(force);this.m_torque+=(point.Subtract(this.m_sweep.c)).Cross(force);};Body.prototype.ApplyForceToCenter=function(force){if(this.m_type!=2){return;}
if(this.IsAwake()==false){this.SetAwake(true);}
this.m_force=this.m_force.Add(force);};Body.prototype.ApplyTorque=function(torque){if(this.m_type!=2){return;}
if(this.IsAwake()==false){this.SetAwake(true);}
this.m_torque+=torque;};Body.prototype.ApplyLinearImpulse=function(impulse,point){if(this.m_type!=2){return;}
if(this.IsAwake()==false){this.SetAwake(true);}
this.m_linearVelocity=this.m_linearVelocity.Add(impulse.Multiply(this.m_invMass));this.m_angularVelocity+=this.m_invI*(point.Subtract(this.m_sweep.c)).Cross(impulse);};Body.prototype.ApplyAngularImpulse=function(impulse){if(this.m_type!=2){return;}
if(this.IsAwake()==false){this.SetAwake(true);}
this.m_angularVelocity+=this.m_invI*impulse;};Body.prototype.GetMass=function(){return this.m_mass;};Body.prototype.GetInertia=function(){return this.m_I+this.m_mass*this.m_sweep.localCenter.Dot(this.m_sweep.localCenter);};Body.prototype.GetMassData=function(){var data=new PhysicsType2d.Collision.Shapes.MassData();data.mass=this.m_mass;data.I=this.m_I+this.m_mass*(this.m_sweep.localCenter.Dot(this.m_sweep.localCenter));data.center=this.m_sweep.localCenter;return data;};Body.prototype.SetMassData=function(data){PhysicsType2d.Assert(this.m_world.IsLocked()==false);if(this.m_world.IsLocked()==true){return;}
if(this.m_type!=2){return;}
this.m_invMass=0.0;this.m_I=0.0;this.m_invI=0.0;this.m_mass=data.mass;if(this.m_mass<=0.0){this.m_mass=1.0;}
this.m_invMass=1.0/this.m_mass;if(data.I>0.0&&(!this.m_flags.IsSet(16))){this.m_I=data.I-this.m_mass*data.center.Dot(data.center);PhysicsType2d.Assert(this.m_I>0.0);this.m_invI=1.0/this.m_I;}
var oldCenter=this.m_sweep.c;this.m_sweep.localCenter=data.center;this.m_sweep.c0=this.m_sweep.c=this.m_xf.ApplyToVector2(this.m_sweep.localCenter);this.m_linearVelocity=this.m_linearVelocity.Add(PhysicsType2d.MathExtensions.Cross1x2(this.m_angularVelocity,this.m_sweep.c.Subtract(oldCenter)));};Body.prototype.ResetMassData=function(){this.m_mass=0.0;this.m_invMass=0.0;this.m_I=0.0;this.m_invI=0.0;this.m_sweep.localCenter.SetZero();if(this.m_type==0||this.m_type==1){this.m_sweep.c0=this.m_xf.p;this.m_sweep.c=this.m_xf.p;this.m_sweep.a0=this.m_sweep.a;return;}
PhysicsType2d.Assert(this.m_type==2);var localCenter=PhysicsType2d.Vector2.Zero();var iter=this.m_fixtureList.GetIterator();while(iter.MoveNext()){var f=iter.Current();if(f.GetDensity()==0.0){continue;}
var massData=f.GetMassData();this.m_mass+=massData.mass;localCenter=localCenter.Add(massData.center.Multiply(massData.mass));this.m_I+=massData.I;}
if(this.m_mass>0.0){this.m_invMass=1.0/this.m_mass;localCenter=localCenter.Multiply(this.m_invMass);}else{this.m_mass=1.0;this.m_invMass=1.0;}
if(this.m_I>0.0&&(!this.m_flags.IsSet(16))){this.m_I-=this.m_mass*localCenter.Dot(localCenter);PhysicsType2d.Assert(this.m_I>0.0);this.m_invI=1.0/this.m_I;}else{this.m_I=0.0;this.m_invI=0.0;}
var oldCenter=this.m_sweep.c;this.m_sweep.localCenter=localCenter;this.m_sweep.c0=this.m_sweep.c=this.m_xf.ApplyToVector2(this.m_sweep.localCenter);this.m_linearVelocity=this.m_linearVelocity.Add(PhysicsType2d.MathExtensions.Cross1x2(this.m_angularVelocity,this.m_sweep.c.Subtract(oldCenter)));};Body.prototype.GetWorldPoint=function(localPoint){return this.m_xf.ApplyToVector2(localPoint);};Body.prototype.GetWorldVector=function(localVector){return this.m_xf.q.ApplyToVector2(localVector);};Body.prototype.GetLocalPoint=function(worldPoint){return this.m_xf.ApplyTransposeToVector2(worldPoint);};Body.prototype.GetLocalVector=function(worldVector){return this.m_xf.q.ApplyTransposeToVector2(worldVector);};Body.prototype.GetLinearVelocityFromWorldPoint=function(worldPoint){return this.m_linearVelocity.Add(PhysicsType2d.MathExtensions.Cross1x2(this.m_angularVelocity,worldPoint.Subtract(this.m_sweep.c)));};Body.prototype.GetLinearVelocityFromLocalPoint=function(localPoint){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(localPoint));};Body.prototype.GetLinearDamping=function(){return this.m_linearDamping;};Body.prototype.SetLinearDamping=function(linearDamping){this.m_linearDamping=linearDamping;};Body.prototype.GetAngularDamping=function(){return this.m_angularDamping;};Body.prototype.SetAngularDamping=function(angularDamping){this.m_angularDamping=angularDamping;};Body.prototype.GetGravityScale=function(){return this.m_gravityScale;};Body.prototype.SetGravityScale=function(scale){this.m_gravityScale=scale;};Body.prototype.SetType=function(type){PhysicsType2d.Assert(this.m_world.IsLocked()===false);if(this.m_world.IsLocked()===true){return;}
if(this.m_type==type){return;}
this.m_type=type;this.ResetMassData();if(this.m_type===0){this.m_linearVelocity.SetZero();this.m_angularVelocity=0.0;this.m_sweep.a0=this.m_sweep.a;this.m_sweep.c0=this.m_sweep.c;this.SynchronizeFixtures();}
this.SetAwake(true);this.m_force.SetZero();this.m_torque=0.0;var iter=this.m_fixtureList.GetIterator();while(iter.MoveNext()){iter.Current().Refilter();}};Body.prototype.GetType=function(){return this.m_type;};Body.prototype.SetSleepingAllowed=function(flag){if(flag){this.m_flags.Set(4);}else{this.m_flags.Clear(4);this.SetAwake(true);}};Body.prototype.IsSleepingAllowed=function(){return this.m_flags.IsSet(4);};Body.prototype.SetBullet=function(flag){if(flag){this.m_flags.Set(8);}else{this.m_flags.Clear(8);}};Body.prototype.IsBullet=function(){return this.m_flags.IsSet(8);};Body.prototype.SetAwake=function(flag){if(flag){if(!this.m_flags.IsSet(2)){this.m_flags.Set(2);this.m_sleepTime=0.0;}}else{this.m_flags.Clear(2);this.m_sleepTime=0.0;this.m_linearVelocity.SetZero();this.m_angularVelocity=0.0;this.m_force.SetZero();this.m_torque=0.0;}};Body.prototype.IsAwake=function(){return this.m_flags.IsSet(2);};Body.prototype.SetActive=function(flag){PhysicsType2d.Assert(this.m_world.IsLocked()===false);if(flag===this.IsActive()){return;}
if(flag){this.m_flags.Set(32);var broadPhase=this.m_world.GetContactManager().m_broadPhase;var iter=this.m_fixtureList.GetIterator();while(iter.MoveNext()){iter.Current().CreateProxies(broadPhase,this.m_xf);}}else{this.m_flags.Clear(32);var broadPhase=this.m_world.GetContactManager().m_broadPhase;var f=this.m_fixtureList.GetIterator();while(f.MoveNext()){f.Current().DestroyProxies(broadPhase);}
var ce=this.m_contactEdgeList.GetIterator();while(ce.MoveNext()){this.m_world.GetContactManager().Destroy(ce.Current().contact);}
this.m_contactEdgeList=new PhysicsType2d.LinkedList();}};Body.prototype.GetIslandIndex=function(){return this.m_islandIndex;};Body.prototype.SetIslandIndex=function(value){this.m_islandIndex=value;};Body.prototype.GetSweep=function(){return this.m_sweep.Clone();};Body.prototype.SetSweep=function(value){this.m_sweep=value.Clone();};Body.prototype.GetSleepTime=function(){return this.m_sleepTime;};Body.prototype.SetSleepTime=function(value){this.m_sleepTime=value;};Body.prototype.GetInvMass=function(){return this.m_invMass;};Body.prototype.GetInvI=function(){return this.m_invI;};Body.prototype.IsActive=function(){return this.m_flags.IsSet(32);};Body.prototype.SetFixedRotation=function(flag){if(flag){this.m_flags.Set(16);}else{this.m_flags.Clear(16);}
this.ResetMassData();};Body.prototype.IsFixedRotation=function(){return this.m_flags.IsSet(16);};Body.prototype.GetFixtures=function(){return this.m_fixtureList.GetIterator();};Body.prototype.ClearFixtures=function(){this.m_fixtureList=new PhysicsType2d.LinkedList();};Body.prototype.GetJointEdges=function(){return this.m_jointEdgeList.GetIterator();};Body.prototype.ClearJointEdges=function(){this.m_jointEdgeList=new PhysicsType2d.LinkedList();};Body.prototype.AddJointEdge=function(edge){this.m_jointEdgeList.Add(edge);};Body.prototype.RemoveJointEdge=function(edge){return this.m_jointEdgeList.Remove(edge);};Body.prototype.GetContactEdges=function(){return this.m_contactEdgeList.GetIterator();};Body.prototype.ClearContactEdges=function(){this.m_contactEdgeList=new PhysicsType2d.LinkedList();};Body.prototype.RemoveContactEdge=function(edge){return this.m_contactEdgeList.Remove(edge);};Body.prototype.AddContactEdge=function(edge){this.m_contactEdgeList.Add(edge);};Body.prototype.SetUserData=function(data){this.m_userData=data;};Body.prototype.GetUserData=function(){return this.m_userData;};Body.prototype.GetWorld=function(){return this.m_world;};Body.prototype.Dump=function(){var bodyIndex=this.m_islandIndex;PhysicsType2d.Utils.log("{");PhysicsType2d.Utils.log("  BodyDefinition bd;");PhysicsType2d.Utils.log("  bd.type = BodyType(%d);",this.m_type);PhysicsType2d.Utils.log("  bd.position.Set(%f, %f);",this.m_xf.p.x,this.m_xf.p.y);PhysicsType2d.Utils.log("  bd.angle = %d;",this.m_sweep.a);PhysicsType2d.Utils.log("  bd.linearVelocity.Set(%f, %f);",this.m_linearVelocity.x,this.m_linearVelocity.y);PhysicsType2d.Utils.log("  bd.angularVelocity = %d;",this.m_angularVelocity);PhysicsType2d.Utils.log("  bd.linearDamping = %f;",this.m_linearDamping);PhysicsType2d.Utils.log("  bd.angularDamping = %f;",this.m_angularDamping);PhysicsType2d.Utils.log("  bd.allowSleep = boolean(%d);",this.m_flags.IsSet(4));PhysicsType2d.Utils.log("  bd.awake = boolean(%d);",this.m_flags.IsSet(2));PhysicsType2d.Utils.log("  bd.fixedRotation = boolean(%d);",this.m_flags.IsSet(16));PhysicsType2d.Utils.log("  bd.bullet = boolean(%d);",this.m_flags.IsSet(8));PhysicsType2d.Utils.log("  bd.active = boolean(%d);",this.m_flags.IsSet(32));PhysicsType2d.Utils.log("  bd.gravityScale = %d;",this.m_gravityScale);PhysicsType2d.Utils.log("  bodies[%d] = m_world.CreateBody(&bd);",this.m_islandIndex);PhysicsType2d.Utils.log("");var iter=this.m_fixtureList.GetIterator();while(iter.MoveNext()){PhysicsType2d.Utils.log("  {");iter.Current().Dump(bodyIndex);PhysicsType2d.Utils.log("  }");}
PhysicsType2d.Utils.log("}");};Body.prototype.GetForce=function(){return this.m_force.Clone();};Body.prototype.SetForce=function(value){this.m_force=value.Clone();};Body.prototype.GetTorque=function(){return this.m_torque;};Body.prototype.SetTorque=function(value){this.m_torque=value;};Body.FromDefinition=function(def,world){var bd=def.Clone();PhysicsType2d.Assert(bd.position.IsValid());PhysicsType2d.Assert(bd.linearVelocity.IsValid());PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(bd.angle));PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(bd.angularVelocity));PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(bd.angularDamping)&&bd.angularDamping>=0.0);PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(bd.linearDamping)&&bd.linearDamping>=0.0);var newBody=new Body();newBody.m_flags=new PhysicsType2d.BitFlag(0);if(bd.bullet){newBody.m_flags.Set(8);}
if(bd.fixedRotation){newBody.m_flags.Set(16);}
if(bd.allowSleep){newBody.m_flags.Set(4);}
if(bd.awake){newBody.m_flags.Set(2);}
if(bd.active){newBody.m_flags.Set(32);}
newBody.m_world=world;newBody.m_xf.p=bd.position;newBody.m_xf.q.Set(bd.angle);newBody.m_sweep.localCenter.SetZero();newBody.m_sweep.c0=newBody.m_xf.p;newBody.m_sweep.c=newBody.m_xf.p;newBody.m_sweep.a0=bd.angle;newBody.m_sweep.a=bd.angle;newBody.m_sweep.alpha0=0.0;newBody.m_jointEdgeList=new PhysicsType2d.LinkedList();newBody.m_contactEdgeList=new PhysicsType2d.LinkedList();newBody.m_linearVelocity=bd.linearVelocity;newBody.m_angularVelocity=bd.angularVelocity;newBody.m_linearDamping=bd.linearDamping;newBody.m_angularDamping=bd.angularDamping;newBody.m_gravityScale=bd.gravityScale;newBody.m_force.SetZero();newBody.m_torque=0.0;newBody.m_sleepTime=0.0;newBody.m_type=bd.type;if(newBody.m_type==2){newBody.m_mass=1.0;newBody.m_invMass=1.0;}else{newBody.m_mass=0.0;newBody.m_invMass=0.0;}
newBody.m_I=0.0;newBody.m_invI=0.0;newBody.m_userData=bd.userData;newBody.m_fixtureList=new PhysicsType2d.LinkedList();return newBody;};Body.prototype.SynchronizeFixtures=function(){var xf1=new PhysicsType2d.Transform();xf1.q.Set(this.m_sweep.a0);xf1.p=this.m_sweep.c0.Subtract(xf1.q.ApplyToVector2(this.m_sweep.localCenter));var broadPhase=this.m_world.GetContactManager().m_broadPhase;var iter=this.m_fixtureList.GetIterator();while(iter.MoveNext()){iter.Current().Synchronize(broadPhase,xf1,this.m_xf);}};Body.prototype.SynchronizeTransform=function(){this.m_xf.q.Set(this.m_sweep.a);this.m_xf.p=this.m_sweep.c.Subtract(this.m_xf.q.ApplyToVector2(this.m_sweep.localCenter));};Body.prototype.ShouldCollide=function(other){if(this.m_type!=2&&other.m_type!=2){return false;}
var iter=this.m_jointEdgeList.GetIterator();while(iter.MoveNext()){var jn=iter.Current();if(jn.other==other){if(jn.joint.m_collideConnected==false){return false;}}}
return true;};Body.prototype.Advance=function(alpha){this.m_sweep.Advance(alpha);this.m_sweep.c=this.m_sweep.c0;this.m_sweep.a=this.m_sweep.a0;this.m_xf.q.Set(this.m_sweep.a);this.m_xf.p=this.m_sweep.c.Subtract(this.m_xf.q.ApplyToVector2(this.m_sweep.localCenter));};Body.prototype.SetFlag=function(flag){this.m_flags.Set(flag);};Body.prototype.ClearFlag=function(flag){this.m_flags.Clear(flag);};Body.prototype.IsFlagSet=function(desiredFlags){return this.m_flags.IsSet(desiredFlags);};return Body;})();Dynamics.Body=Body;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var __extends=this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d;}
__.prototype=b.prototype;d.prototype=new __();};var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Contacts){var ChainAndCircleContact=(function(_super){__extends(ChainAndCircleContact,_super);function ChainAndCircleContact(fixtureA,indexA,fixtureB,indexB){_super.call(this,fixtureA,indexA,fixtureB,indexB);PhysicsType2d.Assert(this.m_fixtureA.GetType()==3);PhysicsType2d.Assert(this.m_fixtureB.GetType()==0);}
ChainAndCircleContact.Create=function(fixtureA,indexA,fixtureB,indexB){return new ChainAndCircleContact(fixtureA,indexA,fixtureB,indexB);};ChainAndCircleContact.prototype.Evaluate=function(manifold,xfA,xfB){var chain=this.m_fixtureA.GetShape();var edge=chain.GetChildEdge(this.m_indexA);return PhysicsType2d.Collision.CollideEdgeAndCircle(manifold,edge,xfA,this.m_fixtureB.GetShape(),xfB);};return ChainAndCircleContact;})(PhysicsType2d.Dynamics.Contacts.Contact);Contacts.ChainAndCircleContact=ChainAndCircleContact;})(Dynamics.Contacts||(Dynamics.Contacts={}));var Contacts=Dynamics.Contacts;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Contacts){var ChainAndPolygonContact=(function(_super){__extends(ChainAndPolygonContact,_super);function ChainAndPolygonContact(fixtureA,indexA,fixtureB,indexB){_super.call(this,fixtureA,indexA,fixtureB,indexB);PhysicsType2d.Assert(this.m_fixtureA.GetType()==3);PhysicsType2d.Assert(this.m_fixtureB.GetType()==2);}
ChainAndPolygonContact.Create=function(fixtureA,indexA,fixtureB,indexB){return new ChainAndPolygonContact(fixtureA,indexA,fixtureB,indexB);};ChainAndPolygonContact.prototype.Evaluate=function(manifold,xfA,xfB){var chain=this.m_fixtureA.GetShape();var edge=chain.GetChildEdge(this.m_indexA);return PhysicsType2d.Collision.CollideEdgeAndPolygon(manifold,edge,xfA,this.m_fixtureB.GetShape(),xfB);};return ChainAndPolygonContact;})(PhysicsType2d.Dynamics.Contacts.Contact);Contacts.ChainAndPolygonContact=ChainAndPolygonContact;})(Dynamics.Contacts||(Dynamics.Contacts={}));var Contacts=Dynamics.Contacts;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Contacts){var CircleContact=(function(_super){__extends(CircleContact,_super);function CircleContact(fixtureA,indexA,fixtureB,indexB){_super.call(this,fixtureA,indexA,fixtureB,indexB);PhysicsType2d.Assert(this.m_fixtureA.GetType()==0);PhysicsType2d.Assert(this.m_fixtureB.GetType()==0);}
CircleContact.Create=function(fixtureA,indexA,fixtureB,indexB){return new CircleContact(fixtureA,indexA,fixtureB,indexB);};CircleContact.prototype.Evaluate=function(manifold,xfA,xfB){return PhysicsType2d.Collision.CollideCircles(manifold,this.m_fixtureA.GetShape(),xfA,this.m_fixtureB.GetShape(),xfB);};return CircleContact;})(PhysicsType2d.Dynamics.Contacts.Contact);Contacts.CircleContact=CircleContact;})(Dynamics.Contacts||(Dynamics.Contacts={}));var Contacts=Dynamics.Contacts;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Contacts){var EdgeAndCircleContact=(function(_super){__extends(EdgeAndCircleContact,_super);function EdgeAndCircleContact(fixtureA,indexA,fixtureB,indexB){_super.call(this,fixtureA,indexA,fixtureB,indexB);PhysicsType2d.Assert(this.m_fixtureA.GetType()==1);PhysicsType2d.Assert(this.m_fixtureB.GetType()==0);}
EdgeAndCircleContact.Create=function(fixtureA,indexA,fixtureB,indexB){return new EdgeAndCircleContact(fixtureA,indexA,fixtureB,indexB);};EdgeAndCircleContact.prototype.Evaluate=function(manifold,xfA,xfB){return PhysicsType2d.Collision.CollideEdgeAndCircle(manifold,this.m_fixtureA.GetShape(),xfA,this.m_fixtureB.GetShape(),xfB);};return EdgeAndCircleContact;})(PhysicsType2d.Dynamics.Contacts.Contact);Contacts.EdgeAndCircleContact=EdgeAndCircleContact;})(Dynamics.Contacts||(Dynamics.Contacts={}));var Contacts=Dynamics.Contacts;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Contacts){var EdgeAndPolygonContact=(function(_super){__extends(EdgeAndPolygonContact,_super);function EdgeAndPolygonContact(fixtureA,indexA,fixtureB,indexB){_super.call(this,fixtureA,indexA,fixtureB,indexB);PhysicsType2d.Assert(this.m_fixtureA.GetType()==1);PhysicsType2d.Assert(this.m_fixtureB.GetType()==2);}
EdgeAndPolygonContact.Create=function(fixtureA,indexA,fixtureB,indexB){return new EdgeAndPolygonContact(fixtureA,indexA,fixtureB,indexB);};EdgeAndPolygonContact.prototype.Evaluate=function(manifold,xfA,xfB){return PhysicsType2d.Collision.CollideEdgeAndPolygon(manifold,this.m_fixtureA.GetShape(),xfA,this.m_fixtureB.GetShape(),xfB);};return EdgeAndPolygonContact;})(PhysicsType2d.Dynamics.Contacts.Contact);Contacts.EdgeAndPolygonContact=EdgeAndPolygonContact;})(Dynamics.Contacts||(Dynamics.Contacts={}));var Contacts=Dynamics.Contacts;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Contacts){var PolygonAndCircleContact=(function(_super){__extends(PolygonAndCircleContact,_super);function PolygonAndCircleContact(fixtureA,indexA,fixtureB,indexB){_super.call(this,fixtureA,indexA,fixtureB,indexB);PhysicsType2d.Assert(this.m_fixtureA.GetType()==2);PhysicsType2d.Assert(this.m_fixtureB.GetType()==0);}
PolygonAndCircleContact.Create=function(fixtureA,indexA,fixtureB,indexB){return new PolygonAndCircleContact(fixtureA,indexA,fixtureB,indexB);};PolygonAndCircleContact.prototype.Evaluate=function(manifold,xfA,xfB){return PhysicsType2d.Collision.CollidePolygonAndCircle(manifold,this.m_fixtureA.GetShape(),xfA,this.m_fixtureB.GetShape(),xfB);};return PolygonAndCircleContact;})(PhysicsType2d.Dynamics.Contacts.Contact);Contacts.PolygonAndCircleContact=PolygonAndCircleContact;})(Dynamics.Contacts||(Dynamics.Contacts={}));var Contacts=Dynamics.Contacts;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Contacts){var PolygonContact=(function(_super){__extends(PolygonContact,_super);function PolygonContact(fixtureA,indexA,fixtureB,indexB){_super.call(this,fixtureA,indexA,fixtureB,indexB);PhysicsType2d.Assert(this.m_fixtureA.GetType()==2);PhysicsType2d.Assert(this.m_fixtureB.GetType()==2);}
PolygonContact.Create=function(fixtureA,indexA,fixtureB,indexB){return new PolygonContact(fixtureA,indexA,fixtureB,indexB);};PolygonContact.prototype.Evaluate=function(manifold,xfA,xfB){return PhysicsType2d.Collision.CollidePolygons(manifold,this.m_fixtureA.GetShape(),xfA,this.m_fixtureB.GetShape(),xfB);};return PolygonContact;})(PhysicsType2d.Dynamics.Contacts.Contact);Contacts.PolygonContact=PolygonContact;})(Dynamics.Contacts||(Dynamics.Contacts={}));var Contacts=Dynamics.Contacts;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var DistanceJointDefinition=(function(_super){__extends(DistanceJointDefinition,_super);function DistanceJointDefinition(){_super.call(this);this.localAnchorA=new PhysicsType2d.Vector2(0,0);this.localAnchorB=new PhysicsType2d.Vector2(0,0);this.type=3;this.length=1.0;this.frequencyHz=0.0;this.dampingRatio=0.0;}
DistanceJointDefinition.prototype.Initialize=function(bA,bB,anchorA,anchorB){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchorA);this.localAnchorB=this.bodyB.GetLocalPoint(anchorB);var d=anchorB.Subtract(anchorA);this.length=d.Length();};return DistanceJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.DistanceJointDefinition=DistanceJointDefinition;var DistanceJoint=(function(_super){__extends(DistanceJoint,_super);function DistanceJoint(def){_super.call(this,def);this.m_localAnchorA=new PhysicsType2d.Vector2(0,0);this.m_localAnchorB=new PhysicsType2d.Vector2(0,0);this.m_u=new PhysicsType2d.Vector2(0,0);this.m_rA=new PhysicsType2d.Vector2(0,0);this.m_rB=new PhysicsType2d.Vector2(0,0);this.m_localCenterA=new PhysicsType2d.Vector2(0,0);this.m_localCenterB=new PhysicsType2d.Vector2(0,0);this.m_localAnchorA=def.localAnchorA;this.m_localAnchorB=def.localAnchorB;this.m_length=def.length;this.m_frequencyHz=def.frequencyHz;this.m_dampingRatio=def.dampingRatio;this.m_impulse=0.0;this.m_gamma=0.0;this.m_bias=0.0;}
DistanceJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);};DistanceJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);};DistanceJoint.prototype.GetReactionForce=function(inv_dt){return this.m_u.Multiply(inv_dt*this.m_impulse);};DistanceJoint.prototype.GetReactionTorque=function(inv_dt){return 0.0;};DistanceJoint.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA;};DistanceJoint.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB;};DistanceJoint.prototype.SetLength=function(length){this.m_length=length;};DistanceJoint.prototype.GetLength=function(){return this.m_length;};DistanceJoint.prototype.SetFrequency=function(hz){this.m_frequencyHz=hz;};DistanceJoint.prototype.GetFrequency=function(){return this.m_frequencyHz;};DistanceJoint.prototype.SetDampingRatio=function(ratio){this.m_dampingRatio=ratio;};DistanceJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio;};DistanceJoint.prototype.Dump=function(){var indexA=this.m_bodyA.GetIslandIndex();var indexB=this.m_bodyB.GetIslandIndex();PhysicsType2d.Utils.log(" DistanceJointDef jd;");PhysicsType2d.Utils.log("  jd.bodyA = bodies[{0}];",indexA);PhysicsType2d.Utils.log("  jd.bodyB = bodies[{0}];",indexB);PhysicsType2d.Utils.log("  jd.collideConnected = boolean({0});",this.m_collideConnected);PhysicsType2d.Utils.log("  jd.localAnchorA.Set({0}, {1});",this.m_localAnchorA.x,this.m_localAnchorA.y);PhysicsType2d.Utils.log("  jd.localAnchorB.Set({0}, {1});",this.m_localAnchorB.x,this.m_localAnchorB.y);PhysicsType2d.Utils.log("  jd.length = {0};",this.m_length);PhysicsType2d.Utils.log("  jd.frequencyHz = {0};",this.m_frequencyHz);PhysicsType2d.Utils.log("  jd.dampingRatio = {0};",this.m_dampingRatio);PhysicsType2d.Utils.log("  joints[{0}] = this.m_world->CreateJoint(&jd);",this.m_index);};DistanceJoint.prototype.InitVelocityConstraints=function(data){this.m_indexA=this.m_bodyA.GetIslandIndex();this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_localCenterA=this.m_bodyA.GetSweep().localCenter;this.m_localCenterB=this.m_bodyB.GetSweep().localCenter;this.m_invMassA=this.m_bodyA.GetInvMass();this.m_invMassB=this.m_bodyB.GetInvMass();this.m_invIA=this.m_bodyA.GetInvI();this.m_invIB=this.m_bodyB.GetInvI();var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);this.m_rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));this.m_rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));this.m_u=cB.Add(this.m_rB).Subtract(cA).Subtract(this.m_rA);var length=this.m_u.Length();if(length>PhysicsType2d.Settings.linearSlop){this.m_u=this.m_u.Multiply(1.0/length);}else{this.m_u.Set(0.0,0.0);}
var crAu=this.m_rA.Cross(this.m_u);var crBu=this.m_rB.Cross(this.m_u);var invMass=this.m_invMassA+this.m_invIA*crAu*crAu+this.m_invMassB+this.m_invIB*crBu*crBu;this.m_mass=invMass!=0.0?1.0/invMass:0.0;if(this.m_frequencyHz>0.0){var C=length-this.m_length;var omega=2.0*PhysicsType2d.Constants.PI*this.m_frequencyHz;var d=2.0*this.m_mass*this.m_dampingRatio*omega;var k=this.m_mass*omega*omega;var h=data.step.dt;this.m_gamma=h*(d+h*k);this.m_gamma=this.m_gamma!=0.0?1.0/this.m_gamma:0.0;this.m_bias=C*h*k*this.m_gamma;invMass+=this.m_gamma;this.m_mass=invMass!=0.0?1.0/invMass:0.0;}else{this.m_gamma=0.0;this.m_bias=0.0;}
if(data.step.warmStarting){this.m_impulse*=data.step.dtRatio;var P=this.m_u.Multiply(this.m_impulse);vA=vA.Subtract(P.Multiply(this.m_invMassA));wA-=this.m_invIA*this.m_rA.Cross(P);vB=vB.Add(P.Multiply(this.m_invMassB));wB+=this.m_invIB*this.m_rB.Cross(P);}else{this.m_impulse=0.0;}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};DistanceJoint.prototype.SolveVelocityConstraints=function(data){var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var vpA=vA.Add(PhysicsType2d.MathExtensions.Cross1x2(wA,this.m_rA));var vpB=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,this.m_rB));var Cdot=this.m_u.Dot(vpB.Subtract(vpA));var impulse=-this.m_mass*(Cdot+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=impulse;var P=this.m_u.Multiply(impulse);vA=vA.Subtract(P.Multiply(this.m_invMassA));wA-=this.m_invIA*this.m_rA.Cross(P);vB=vB.Add(P.Multiply(this.m_invMassB));wB+=this.m_invIB*this.m_rB.Cross(P);data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};DistanceJoint.prototype.SolvePositionConstraints=function(data){if(this.m_frequencyHz>0.0){return true;}
var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));var rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var u=cB.Add(rB.Subtract(cA).Subtract(rA));var length=u.Normalize();var C=length-this.m_length;C=PhysicsType2d.MathExtensions.Clamp(C,-PhysicsType2d.Settings.maxLinearCorrection,PhysicsType2d.Settings.maxLinearCorrection);var impulse=-this.m_mass*C;var P=u.Multiply(impulse);cA=cA.Subtract(P.Multiply(this.m_invMassA));aA-=this.m_invIA*rA.Cross(P);cB=cB.Add(P.Multiply(this.m_invMassB));aB+=this.m_invIB*rB.Cross(P);data.positions[this.m_indexA].c=cA;data.positions[this.m_indexA].a=aA;data.positions[this.m_indexB].c=cB;data.positions[this.m_indexB].a=aB;return Math.abs(C)<PhysicsType2d.Settings.linearSlop;};return DistanceJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.DistanceJoint=DistanceJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var FrictionJointDefinition=(function(_super){__extends(FrictionJointDefinition,_super);function FrictionJointDefinition(){_super.call(this);this.localAnchorA=new PhysicsType2d.Vector2(0,0);this.localAnchorB=new PhysicsType2d.Vector2(0,0);this.type=9;this.maxForce=0.0;this.maxTorque=0.0;}
FrictionJointDefinition.prototype.Initialize=function(bA,bB,anchor){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchor);this.localAnchorB=this.bodyB.GetLocalPoint(anchor);};return FrictionJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.FrictionJointDefinition=FrictionJointDefinition;var FrictionJoint=(function(_super){__extends(FrictionJoint,_super);function FrictionJoint(def){_super.call(this,def);this.m_linearImpulse=new PhysicsType2d.Vector2(0,0);this.m_localAnchorA=new PhysicsType2d.Vector2(0,0);this.m_localAnchorB=new PhysicsType2d.Vector2(0,0);this.m_u=new PhysicsType2d.Vector2(0,0);this.m_rA=new PhysicsType2d.Vector2(0,0);this.m_rB=new PhysicsType2d.Vector2(0,0);this.m_localCenterA=new PhysicsType2d.Vector2(0,0);this.m_localCenterB=new PhysicsType2d.Vector2(0,0);this.m_linearMass=new PhysicsType2d.Matrix2x2();this.m_localAnchorA=def.localAnchorA;this.m_localAnchorB=def.localAnchorB;this.m_angularImpulse=0.0;this.m_maxForce=def.maxForce;this.m_maxTorque=def.maxTorque;}
FrictionJoint.prototype.InitVelocityConstraints=function(data){this.m_indexA=this.m_bodyA.GetIslandIndex();this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_localCenterA=this.m_bodyA.GetSweep().localCenter;this.m_localCenterB=this.m_bodyB.GetSweep().localCenter;this.m_invMassA=this.m_bodyA.GetInvMass();this.m_invMassB=this.m_bodyB.GetInvMass();this.m_invIA=this.m_bodyA.GetInvI();this.m_invIB=this.m_bodyB.GetInvI();var aA=data.positions[this.m_indexA].a;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);this.m_rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));this.m_rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var mA=this.m_invMassA;var mB=this.m_invMassB;var iA=this.m_invIA;var iB=this.m_invIB;var K=new PhysicsType2d.Matrix2x2();K.EX.x=mA+mB+iA*this.m_rA.y*this.m_rA.y+iB*this.m_rB.y*this.m_rB.y;K.EX.y=-iA*this.m_rA.x*this.m_rA.y-iB*this.m_rB.x*this.m_rB.y;K.EY.x=K.EX.y;K.EY.y=mA+mB+iA*this.m_rA.x*this.m_rA.x+iB*this.m_rB.x*this.m_rB.x;this.m_linearMass=K.GetInverse();this.m_angularMass=iA+iB;if(this.m_angularMass>0.0){this.m_angularMass=1.0/this.m_angularMass;}
if(data.step.warmStarting){this.m_linearImpulse=this.m_linearImpulse.Multiply(data.step.dtRatio);this.m_angularImpulse*=data.step.dtRatio;var P=new PhysicsType2d.Vector2(this.m_linearImpulse.x,this.m_linearImpulse.y);vA=vA.Subtract(P.Multiply(mA));wA-=iA*(this.m_rA.Cross(P)+this.m_angularImpulse);vB=vB.Add(P.Multiply(mB));wB+=iB*(this.m_rB.Cross(P)+this.m_angularImpulse);}else{this.m_linearImpulse.SetZero();this.m_angularImpulse=0.0;}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};FrictionJoint.prototype.SolveAngularFriction=function(velocityA,velocityB,h){var iA=this.m_invIA;var iB=this.m_invIB;var Cdot=velocityB.w-velocityA.w;var impulse=-this.m_angularMass*Cdot;var oldImpulse=this.m_angularImpulse;var maxImpulse=h*this.m_maxTorque;this.m_angularImpulse=PhysicsType2d.MathExtensions.Clamp(this.m_angularImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_angularImpulse-oldImpulse;velocityA.w-=iA*impulse;velocityB.w+=iB*impulse;};FrictionJoint.prototype.SolveLinearFriction=function(velocityA,velocityB,h){var Cdot=velocityB.v.Add(PhysicsType2d.MathExtensions.Cross1x2(velocityB.w,this.m_rB)).Subtract(velocityA.v).Subtract(PhysicsType2d.MathExtensions.Cross1x2(velocityA.w,this.m_rA));var impulse=this.m_linearMass.VectorMultiply(Cdot).Negative();var oldImpulse=this.m_linearImpulse;this.m_linearImpulse=this.m_linearImpulse.Add(impulse);var maxImpulse=h*this.m_maxForce;if(this.m_linearImpulse.LengthSquared()>maxImpulse*maxImpulse){this.m_linearImpulse.Normalize();this.m_linearImpulse=this.m_linearImpulse.Multiply(maxImpulse);}
impulse=this.m_linearImpulse.Subtract(oldImpulse);var iA=this.m_invIA;var iB=this.m_invIB;var mA=this.m_invMassA;var mB=this.m_invMassB;velocityA.v=velocityA.v.Subtract(impulse.Multiply(mA));velocityA.w-=iA*this.m_rA.Cross(impulse);velocityB.v=velocityB.v.Add(impulse.Multiply(mB));velocityB.w+=iB*this.m_rB.Cross(impulse);};FrictionJoint.prototype.SolveVelocityConstraints=function(data){var h=data.step.dt;this.SolveAngularFriction(data.velocities[this.m_indexA],data.velocities[this.m_indexB],h);this.SolveLinearFriction(data.velocities[this.m_indexA],data.velocities[this.m_indexB],h);};FrictionJoint.prototype.SolvePositionConstraints=function(data){return true;};FrictionJoint.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA;};FrictionJoint.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB;};FrictionJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);};FrictionJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);};FrictionJoint.prototype.GetReactionForce=function(inv_dt){return this.m_linearImpulse.Multiply(inv_dt);};FrictionJoint.prototype.GetReactionTorque=function(inv_dt){return inv_dt*this.m_angularImpulse;};FrictionJoint.prototype.SetMaxForce=function(force){PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(force)&&force>=0.0);this.m_maxForce=force;};FrictionJoint.prototype.GetMaxForce=function(){return this.m_maxForce;};FrictionJoint.prototype.SetMaxTorque=function(torque){PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(torque)&&torque>=0.0);this.m_maxTorque=torque;};FrictionJoint.prototype.GetMaxTorque=function(){return this.m_maxTorque;};FrictionJoint.prototype.Dump=function(){var indexA=this.m_bodyA.GetIslandIndex();var indexB=this.m_bodyB.GetIslandIndex();PhysicsType2d.Utils.log(" FrictionJointDef jd;");PhysicsType2d.Utils.log("  jd.bodyA = bodies[{0}];",indexA);PhysicsType2d.Utils.log("  jd.bodyB = bodies[{0}];",indexB);PhysicsType2d.Utils.log("  jd.collideConnected = boolean({0});",this.m_collideConnected);PhysicsType2d.Utils.log("  jd.localAnchorA.Set({0}, {1});",this.m_localAnchorA.x,this.m_localAnchorA.y);PhysicsType2d.Utils.log("  jd.localAnchorB.Set({0}, {1});",this.m_localAnchorB.x,this.m_localAnchorB.y);PhysicsType2d.Utils.log("  jd.maxForce = {0};",this.m_maxForce);PhysicsType2d.Utils.log("  jd.maxTorque = {0};",this.m_maxTorque);PhysicsType2d.Utils.log("  joints[{0}] = this.m_world->CreateJoint(&jd);",this.m_index);};return FrictionJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.FrictionJoint=FrictionJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var RevoluteJointDefinition=(function(_super){__extends(RevoluteJointDefinition,_super);function RevoluteJointDefinition(){_super.call(this);this.localAnchorA=new PhysicsType2d.Vector2(0,0);this.localAnchorB=new PhysicsType2d.Vector2(0,0);this.type=1;this.localAnchorA=new PhysicsType2d.Vector2(0.0,0.0);this.localAnchorB=new PhysicsType2d.Vector2(0.0,0.0);this.referenceAngle=0.0;this.lowerAngle=0.0;this.upperAngle=0.0;this.maxMotorTorque=0.0;this.motorSpeed=0.0;this.enableLimit=false;this.enableMotor=false;}
RevoluteJointDefinition.prototype.Initialize=function(bA,bB,anchor){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchor);this.localAnchorB=this.bodyB.GetLocalPoint(anchor);this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle();};return RevoluteJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.RevoluteJointDefinition=RevoluteJointDefinition;var RevoluteJoint=(function(_super){__extends(RevoluteJoint,_super);function RevoluteJoint(def){_super.call(this,def);this.m_localAnchorA=new PhysicsType2d.Vector2(0,0);this.m_localAnchorB=new PhysicsType2d.Vector2(0,0);this.m_rA=new PhysicsType2d.Vector2(0,0);this.m_rB=new PhysicsType2d.Vector2(0,0);this.m_localCenterA=new PhysicsType2d.Vector2(0,0);this.m_localCenterB=new PhysicsType2d.Vector2(0,0);this.m_mass=new PhysicsType2d.Matrix3x3();this.m_localAnchorA=def.localAnchorA;this.m_localAnchorB=def.localAnchorB;this.m_referenceAngle=def.referenceAngle;this.m_impulse=new PhysicsType2d.Vector3(0,0,0);this.m_motorImpulse=0.0;this.m_lowerAngle=def.lowerAngle;this.m_upperAngle=def.upperAngle;this.m_maxMotorTorque=def.maxMotorTorque;this.m_motorSpeed=def.motorSpeed;this.m_enableLimit=def.enableLimit;this.m_enableMotor=def.enableMotor;this.m_limitState=0;}
RevoluteJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);};RevoluteJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);};RevoluteJoint.prototype.GetReactionForce=function(inv_dt){var P=new PhysicsType2d.Vector2(this.m_impulse.x,this.m_impulse.y);return P.Multiply(inv_dt);};RevoluteJoint.prototype.GetReactionTorque=function(inv_dt){return inv_dt*this.m_impulse.z;};RevoluteJoint.prototype.GetJointAngle=function(){var bA=this.m_bodyA;var bB=this.m_bodyB;return bB.m_sweep.a-bA.m_sweep.a-this.m_referenceAngle;};RevoluteJoint.prototype.GetJointSpeed=function(){var bA=this.m_bodyA;var bB=this.m_bodyB;return bB.GetAngularVelocity()-bA.GetAngularVelocity();};RevoluteJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor;};RevoluteJoint.prototype.EnableMotor=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableMotor=flag;};RevoluteJoint.prototype.GetMotorTorque=function(inv_dt){return inv_dt*this.m_motorImpulse;};RevoluteJoint.prototype.SetMotorSpeed=function(speed){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_motorSpeed=speed;};RevoluteJoint.prototype.SetMaxMotorTorque=function(torque){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_maxMotorTorque=torque;};RevoluteJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit;};RevoluteJoint.prototype.EnableLimit=function(flag){if(flag!=this.m_enableLimit){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableLimit=flag;this.m_impulse.z=0.0;}};RevoluteJoint.prototype.GetLowerLimit=function(){return this.m_lowerAngle;};RevoluteJoint.prototype.GetUpperLimit=function(){return this.m_upperAngle;};RevoluteJoint.prototype.SetLimits=function(lower,upper){PhysicsType2d.Assert(lower<=upper);if(lower!=this.m_lowerAngle||upper!=this.m_upperAngle){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_impulse.z=0.0;this.m_lowerAngle=lower;this.m_upperAngle=upper;}};RevoluteJoint.prototype.Dump=function(){var indexA=this.m_bodyA.GetIslandIndex();var indexB=this.m_bodyB.GetIslandIndex();PhysicsType2d.Utils.log("  RevoluteJointDefinition jd;");PhysicsType2d.Utils.log("  jd.bodyA = bodies[{0}];",indexA);PhysicsType2d.Utils.log("  jd.bodyB = bodies[{0}];",indexB);PhysicsType2d.Utils.log("  jd.collideConnected = boolean({0});",this.m_collideConnected);PhysicsType2d.Utils.log("  jd.localAnchorA.Set({0}, {1});",this.m_localAnchorA.x,this.m_localAnchorA.y);PhysicsType2d.Utils.log("  jd.localAnchorB.Set({0}, {1});",this.m_localAnchorB.x,this.m_localAnchorB.y);PhysicsType2d.Utils.log("  jd.referenceAngle = {0};",this.m_referenceAngle);PhysicsType2d.Utils.log("  jd.enableLimit = boolean({0});",this.m_enableLimit);PhysicsType2d.Utils.log("  jd.lowerAngle = {0};",this.m_lowerAngle);PhysicsType2d.Utils.log("  jd.upperAngle = {0};",this.m_upperAngle);PhysicsType2d.Utils.log("  jd.enableMotor = boolean({0});",this.m_enableMotor);PhysicsType2d.Utils.log("  jd.motorSpeed = {0};",this.m_motorSpeed);PhysicsType2d.Utils.log("  jd.maxMotorTorque = {0};",this.m_maxMotorTorque);PhysicsType2d.Utils.log("  joints[{0}] = this.m_world->CreateJoint(&jd);",this.m_index);};RevoluteJoint.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA;};RevoluteJoint.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB;};RevoluteJoint.prototype.GetReferenceAngle=function(){return this.m_referenceAngle;};RevoluteJoint.prototype.GetMaxMotorTorque=function(){return this.m_maxMotorTorque;};RevoluteJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed;};RevoluteJoint.prototype.InitVelocityConstraints=function(data){this.m_indexA=this.m_bodyA.GetIslandIndex();this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_localCenterA=this.m_bodyA.GetSweep().localCenter;this.m_localCenterB=this.m_bodyB.GetSweep().localCenter;this.m_invMassA=this.m_bodyA.GetInvMass();this.m_invMassB=this.m_bodyB.GetInvMass();this.m_invIA=this.m_bodyA.GetInvI();this.m_invIB=this.m_bodyB.GetInvI();var aA=data.positions[this.m_indexA].a;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);this.m_rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));this.m_rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var mA=this.m_invMassA;var mB=this.m_invMassB;var iA=this.m_invIA;var iB=this.m_invIB;var fixedRotation=(iA+iB==0.0);this.m_mass.EX.x=mA+mB+this.m_rA.y*this.m_rA.y*iA+this.m_rB.y*this.m_rB.y*iB;this.m_mass.EY.x=-this.m_rA.y*this.m_rA.x*iA-this.m_rB.y*this.m_rB.x*iB;this.m_mass.EZ.x=-this.m_rA.y*iA-this.m_rB.y*iB;this.m_mass.EX.y=this.m_mass.EY.x;this.m_mass.EY.y=mA+mB+this.m_rA.x*this.m_rA.x*iA+this.m_rB.x*this.m_rB.x*iB;this.m_mass.EZ.y=this.m_rA.x*iA+this.m_rB.x*iB;this.m_mass.EX.z=this.m_mass.EZ.x;this.m_mass.EY.z=this.m_mass.EZ.y;this.m_mass.EZ.z=iA+iB;this.m_motorMass=iA+iB;if(this.m_motorMass>0.0){this.m_motorMass=1.0/this.m_motorMass;}
if(!this.m_enableMotor||fixedRotation){this.m_motorImpulse=0.0;}
if(this.m_enableLimit&&fixedRotation==false){var jointAngle=aB-aA-this.m_referenceAngle;if(Math.abs(this.m_upperAngle-this.m_lowerAngle)<2.0*PhysicsType2d.Settings.angularSlop){this.m_limitState=3;}else if(jointAngle<=this.m_lowerAngle){if(this.m_limitState!=1){this.m_impulse.z=0.0;}
this.m_limitState=1;}else if(jointAngle>=this.m_upperAngle){if(this.m_limitState!=2){this.m_impulse.z=0.0;}
this.m_limitState=2;}else{this.m_limitState=0;this.m_impulse.z=0.0;}}else{this.m_limitState=0;}
if(data.step.warmStarting){this.m_impulse=this.m_impulse.Multiply(data.step.dtRatio);this.m_motorImpulse*=data.step.dtRatio;var P=new PhysicsType2d.Vector2(this.m_impulse.x,this.m_impulse.y);vA=vA.Subtract(P.Multiply(mA));wA-=iA*(this.m_rA.Cross(P)+this.m_motorImpulse+this.m_impulse.z);vB=vB.Add(P.Multiply(mB));wB+=iB*(this.m_rB.Cross(P)+this.m_motorImpulse+this.m_impulse.z);}else{this.m_impulse.SetZero();this.m_motorImpulse=0.0;}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};RevoluteJoint.prototype.SolveVelocityConstraints=function(data){var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var mA=this.m_invMassA;var mB=this.m_invMassB;var iA=this.m_invIA;var iB=this.m_invIB;var fixedRotation=(iA+iB==0.0);if(this.m_enableMotor&&this.m_limitState!=3&&fixedRotation==false){var Cdot=wB-wA-this.m_motorSpeed;var impulse=-this.m_motorMass*Cdot;var oldImpulse=this.m_motorImpulse;var maxImpulse=data.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=PhysicsType2d.MathExtensions.Clamp(this.m_motorImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_motorImpulse-oldImpulse;wA-=iA*impulse;wB+=iB*impulse;}
if(this.m_enableLimit&&this.m_limitState!=0&&fixedRotation==false){(function(self){var Cdot1=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,self.m_rB)).Subtract(vA).Subtract(PhysicsType2d.MathExtensions.Cross1x2(wA,self.m_rA));var Cdot2=wB-wA;var Cdot=new PhysicsType2d.Vector3(Cdot1.x,Cdot1.y,Cdot2);var impulse=self.m_mass.Solve3x3(Cdot).Negative();if(self.m_limitState==3){self.m_impulse=self.m_impulse.Add(impulse);}else if(self.m_limitState==1){var newImpulse=self.m_impulse.z+impulse.z;if(newImpulse<0.0){var massVector=new PhysicsType2d.Vector2(self.m_mass.EZ.x,self.m_mass.EZ.y);var rhs=Cdot1.Negative().Add(massVector.Multiply(self.m_impulse.z));var reduced=self.m_mass.Solve2x2(rhs);impulse.x=reduced.x;impulse.y=reduced.y;impulse.z=-self.m_impulse.z;self.m_impulse.x+=reduced.x;self.m_impulse.y+=reduced.y;self.m_impulse.z=0.0;}else{self.m_impulse=self.m_impulse.Add(impulse);}}else if(self.m_limitState==2){var newImpulse=self.m_impulse.z+impulse.z;if(newImpulse>0.0){var massVector=new PhysicsType2d.Vector2(self.m_mass.EZ.x,self.m_mass.EZ.y);var rhs=Cdot1.Negative().Add(massVector.Multiply(self.m_impulse.z));var reduced=self.m_mass.Solve2x2(rhs);impulse.x=reduced.x;impulse.y=reduced.y;impulse.z=-self.m_impulse.z;self.m_impulse.x+=reduced.x;self.m_impulse.y+=reduced.y;self.m_impulse.z=0.0;}else{self.m_impulse=self.m_impulse.Add(impulse);}}
var P=new PhysicsType2d.Vector2(impulse.x,impulse.y);vA=vA.Subtract(P.Multiply(mA));wA-=iA*(self.m_rA.Cross(P)+impulse.z);vB=vB.Add(P.Multiply(mB));wB+=iB*(self.m_rB.Cross(P)+impulse.z);})(this);}else{(function(self){var Cdot=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,self.m_rB)).Subtract(vA).Subtract(PhysicsType2d.MathExtensions.Cross1x2(wA,self.m_rA));var impulse=self.m_mass.Solve2x2(Cdot.Negative());self.m_impulse.x+=impulse.x;self.m_impulse.y+=impulse.y;vA=vA.Subtract(impulse.Multiply(mA));wA-=iA*self.m_rA.Cross(impulse);vB=vB.Add(impulse.Multiply(mB));wB+=iB*self.m_rB.Cross(impulse);})(this);}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};RevoluteJoint.prototype.SolvePositionConstraints=function(data){var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var angularError=0.0;var positionError=0.0;var fixedRotation=(this.m_invIA+this.m_invIB==0.0);if(this.m_enableLimit&&this.m_limitState!=0&&fixedRotation==false){var angle=aB-aA-this.m_referenceAngle;var limitImpulse=0.0;if(this.m_limitState==3){var C=PhysicsType2d.MathExtensions.Clamp(angle-this.m_lowerAngle,-PhysicsType2d.Settings.maxAngularCorrection,PhysicsType2d.Settings.maxAngularCorrection);limitImpulse=-this.m_motorMass*C;angularError=Math.abs(C);}else if(this.m_limitState==1){var C=angle-this.m_lowerAngle;angularError=-C;C=PhysicsType2d.MathExtensions.Clamp(C+PhysicsType2d.Settings.angularSlop,-PhysicsType2d.Settings.maxAngularCorrection,0.0);limitImpulse=-this.m_motorMass*C;}else if(this.m_limitState==2){var C=angle-this.m_upperAngle;angularError=C;C=PhysicsType2d.MathExtensions.Clamp(C-PhysicsType2d.Settings.angularSlop,0.0,PhysicsType2d.Settings.maxAngularCorrection);limitImpulse=-this.m_motorMass*C;}
aA-=this.m_invIA*limitImpulse;aB+=this.m_invIB*limitImpulse;}
(function(self){qA.Set(aA);qB.Set(aB);var rA=qA.ApplyToVector2(self.m_localAnchorA.Subtract(self.m_localCenterA));var rB=qB.ApplyToVector2(self.m_localAnchorB.Subtract(self.m_localCenterB));var C=cB.Add(rB).Subtract(cA).Subtract(rA);positionError=C.Length();var mA=self.m_invMassA;var mB=self.m_invMassB;var iA=self.m_invIA;var iB=self.m_invIB;var K=new PhysicsType2d.Matrix2x2();K.EX.x=mA+mB+iA*rA.y*rA.y+iB*rB.y*rB.y;K.EX.y=-iA*rA.x*rA.y-iB*rB.x*rB.y;K.EY.x=K.EX.y;K.EY.y=mA+mB+iA*rA.x*rA.x+iB*rB.x*rB.x;var impulse=K.Solve(C).Negative();cA=cA.Subtract(impulse.Multiply(mA));aA-=iA*rA.Cross(impulse);cB=cB.Add(impulse.Multiply(mB));aB+=iB*rB.Cross(impulse);})(this);data.positions[this.m_indexA].c=cA;data.positions[this.m_indexA].a=aA;data.positions[this.m_indexB].c=cB;data.positions[this.m_indexB].a=aB;return positionError<=PhysicsType2d.Settings.linearSlop&&angularError<=PhysicsType2d.Settings.angularSlop;};return RevoluteJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.RevoluteJoint=RevoluteJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var PrismaticJointDefinition=(function(_super){__extends(PrismaticJointDefinition,_super);function PrismaticJointDefinition(){_super.call(this);this.localAnchorA=new PhysicsType2d.Vector2(0,0);this.localAnchorB=new PhysicsType2d.Vector2(0,0);this.localAxisA=new PhysicsType2d.Vector2(0,0);this.type=2;this.localAxisA=new PhysicsType2d.Vector2(1.0,0.0);this.referenceAngle=0.0;this.enableLimit=false;this.lowerTranslation=0.0;this.upperTranslation=0.0;this.enableMotor=false;this.maxMotorForce=0.0;this.motorSpeed=0.0;}
PrismaticJointDefinition.prototype.Initialize=function(bA,bB,anchor,axis){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchor);this.localAnchorB=this.bodyB.GetLocalPoint(anchor);this.localAxisA=this.bodyA.GetLocalVector(axis);this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle();};return PrismaticJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.PrismaticJointDefinition=PrismaticJointDefinition;var PrismaticJoint=(function(_super){__extends(PrismaticJoint,_super);function PrismaticJoint(def){_super.call(this,def);this.m_localXAxisA=new PhysicsType2d.Vector2(0,0);this.m_localYAxisA=new PhysicsType2d.Vector2(0,0);this.m_localAnchorA=new PhysicsType2d.Vector2(0,0);this.m_localAnchorB=new PhysicsType2d.Vector2(0,0);this.m_localCenterA=new PhysicsType2d.Vector2(0,0);this.m_localCenterB=new PhysicsType2d.Vector2(0,0);this.m_axis=new PhysicsType2d.Vector2(0,0);this.m_perp=new PhysicsType2d.Vector2(0,0);this.m_K=new PhysicsType2d.Matrix3x3();this.m_localAnchorA=def.localAnchorA;this.m_localAnchorB=def.localAnchorB;this.m_localXAxisA=def.localAxisA;this.m_localXAxisA.Normalize();this.m_localYAxisA=PhysicsType2d.MathExtensions.Cross1x2(1.0,this.m_localXAxisA);this.m_referenceAngle=def.referenceAngle;this.m_impulse=new PhysicsType2d.Vector3(0,0,0);this.m_motorMass=0.0;this.m_motorImpulse=0.0;this.m_lowerTranslation=def.lowerTranslation;this.m_upperTranslation=def.upperTranslation;this.m_maxMotorForce=def.maxMotorForce;this.m_motorSpeed=def.motorSpeed;this.m_enableLimit=def.enableLimit;this.m_enableMotor=def.enableMotor;this.m_limitState=0;}
PrismaticJoint.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA;};PrismaticJoint.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB;};PrismaticJoint.prototype.GetLocalAxisA=function(){return this.m_localXAxisA;};PrismaticJoint.prototype.GetReferenceAngle=function(){return this.m_referenceAngle;};PrismaticJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed;};PrismaticJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);};PrismaticJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);};PrismaticJoint.prototype.GetReactionForce=function(inv_dt){return((this.m_perp.Multiply(this.m_impulse.x)).Add(this.m_axis.Multiply(this.m_motorImpulse+this.m_impulse.z))).Multiply(inv_dt);};PrismaticJoint.prototype.GetReactionTorque=function(inv_dt){return inv_dt*this.m_impulse.y;};PrismaticJoint.prototype.GetJointTranslation=function(){var pA=this.m_bodyA.GetWorldPoint(this.m_localAnchorA);var pB=this.m_bodyB.GetWorldPoint(this.m_localAnchorB);var d=pB.Subtract(pA);var axis=this.m_bodyA.GetWorldVector(this.m_localXAxisA);var translation=d.Dot(axis);return translation;};PrismaticJoint.prototype.GetJointSpeed=function(){var bA=this.m_bodyA;var bB=this.m_bodyB;var rA=bA.GetTransform().q.ApplyToVector2(this.m_localAnchorA.Subtract(bA.GetSweep().localCenter));var rB=bB.GetTransform().q.ApplyToVector2(this.m_localAnchorB.Subtract(bB.GetSweep().localCenter));var p1=bA.GetSweep().c.Add(rA);var p2=bB.GetSweep().c.Add(rB);var d=p2.Subtract(p1);var axis=bA.GetTransform().q.ApplyToVector2(this.m_localXAxisA);var vA=bA.GetLinearVelocity();var vB=bB.GetLinearVelocity();var wA=bA.GetAngularVelocity();var wB=bB.GetAngularVelocity();var speed=d.Dot(PhysicsType2d.MathExtensions.Cross1x2(wA,axis))+axis.Dot(vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,rB)).Subtract(vA).Subtract(PhysicsType2d.MathExtensions.Cross1x2(wA,rA)));return speed;};PrismaticJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit;};PrismaticJoint.prototype.EnableLimit=function(flag){if(flag!=this.m_enableLimit){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableLimit=flag;this.m_impulse.z=0.0;}};PrismaticJoint.prototype.GetLowerLimit=function(){return this.m_lowerTranslation;};PrismaticJoint.prototype.GetUpperLimit=function(){return this.m_upperTranslation;};PrismaticJoint.prototype.SetLimits=function(lower,upper){PhysicsType2d.Assert(lower<=upper);if(lower!=this.m_lowerTranslation||upper!=this.m_upperTranslation){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_lowerTranslation=lower;this.m_upperTranslation=upper;this.m_impulse.z=0.0;}};PrismaticJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor;};PrismaticJoint.prototype.EnableMotor=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableMotor=flag;};PrismaticJoint.prototype.SetMotorSpeed=function(speed){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_motorSpeed=speed;};PrismaticJoint.prototype.SetMaxMotorForce=function(force){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_maxMotorForce=force;};PrismaticJoint.prototype.GetMotorForce=function(inv_dt){return inv_dt*this.m_motorImpulse;};PrismaticJoint.prototype.Dump=function(){var indexA=this.m_bodyA.GetIslandIndex();var indexB=this.m_bodyB.GetIslandIndex();PhysicsType2d.Utils.log(" PrismaticJointDef jd;");PhysicsType2d.Utils.log("  jd.bodyA = bodies[{0}];",indexA);PhysicsType2d.Utils.log("  jd.bodyB = bodies[{0}];",indexB);PhysicsType2d.Utils.log("  jd.collideConnected = boolean({0});",this.m_collideConnected);PhysicsType2d.Utils.log("  jd.localAnchorA.Set({0}, {1});",this.m_localAnchorA.x,this.m_localAnchorA.y);PhysicsType2d.Utils.log("  jd.localAnchorB.Set({0}, {1});",this.m_localAnchorB.x,this.m_localAnchorB.y);PhysicsType2d.Utils.log("  jd.localAxisA.Set({0}, {1});",this.m_localXAxisA.x,this.m_localXAxisA.y);PhysicsType2d.Utils.log("  jd.referenceAngle = {0};",this.m_referenceAngle);PhysicsType2d.Utils.log("  jd.enableLimit = boolean({0});",this.m_enableLimit);PhysicsType2d.Utils.log("  jd.lowerTranslation = {0};",this.m_lowerTranslation);PhysicsType2d.Utils.log("  jd.upperTranslation = {0};",this.m_upperTranslation);PhysicsType2d.Utils.log("  jd.enableMotor = boolean({0});",this.m_enableMotor);PhysicsType2d.Utils.log("  jd.motorSpeed = {0};",this.m_motorSpeed);PhysicsType2d.Utils.log("  jd.maxMotorForce = {0};",this.m_maxMotorForce);PhysicsType2d.Utils.log("  joints[{0}] = this.m_world->CreateJoint(&jd);",this.m_index);};PrismaticJoint.prototype.InitVelocityConstraints=function(data){this.m_indexA=this.m_bodyA.GetIslandIndex();this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_localCenterA=this.m_bodyA.GetSweep().localCenter;this.m_localCenterB=this.m_bodyB.GetSweep().localCenter;this.m_invMassA=this.m_bodyA.GetInvMass();this.m_invMassB=this.m_bodyB.GetInvMass();this.m_invIA=this.m_bodyA.GetInvI();this.m_invIB=this.m_bodyB.GetInvI();var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));var rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var d=cB.Subtract(cA).Add(rB).Subtract(rA);var mA=this.m_invMassA;var mB=this.m_invMassB;var iA=this.m_invIA;var iB=this.m_invIB;{this.m_axis=qA.ApplyToVector2(this.m_localXAxisA);this.m_a1=(d.Add(rA)).Cross(this.m_axis);this.m_a2=rB.Cross(this.m_axis);this.m_motorMass=mA+mB+iA*this.m_a1*this.m_a1+iB*this.m_a2*this.m_a2;if(this.m_motorMass>0.0){this.m_motorMass=1.0/this.m_motorMass;}}
{this.m_perp=qA.ApplyToVector2(this.m_localYAxisA);this.m_s1=(d.Add(rA)).Cross(this.m_perp);this.m_s2=rB.Cross(this.m_perp);var k11=mA+mB+iA*this.m_s1*this.m_s1+iB*this.m_s2*this.m_s2;var k12=iA*this.m_s1+iB*this.m_s2;var k13=iA*this.m_s1*this.m_a1+iB*this.m_s2*this.m_a2;var k22=iA+iB;if(k22==0.0){k22=1.0;}
var k23=iA*this.m_a1+iB*this.m_a2;var k33=mA+mB+iA*this.m_a1*this.m_a1+iB*this.m_a2*this.m_a2;this.m_K.EX.Set(k11,k12,k13);this.m_K.EY.Set(k12,k22,k23);this.m_K.EZ.Set(k13,k23,k33);}
if(this.m_enableLimit){var jointTranslation=this.m_axis.Dot(d);if(Math.abs(this.m_upperTranslation-this.m_lowerTranslation)<2.0*PhysicsType2d.Settings.linearSlop){this.m_limitState=3;}else if(jointTranslation<=this.m_lowerTranslation){if(this.m_limitState!=1){this.m_limitState=1;this.m_impulse.z=0.0;}}else if(jointTranslation>=this.m_upperTranslation){if(this.m_limitState!=2){this.m_limitState=2;this.m_impulse.z=0.0;}}else{this.m_limitState=0;this.m_impulse.z=0.0;}}else{this.m_limitState=0;this.m_impulse.z=0.0;}
if(this.m_enableMotor==false){this.m_motorImpulse=0.0;}
if(data.step.warmStarting){this.m_impulse=this.m_impulse.Multiply(data.step.dtRatio);this.m_motorImpulse*=data.step.dtRatio;var P=(this.m_perp.Multiply(this.m_impulse.x)).Add(this.m_axis.Multiply(this.m_motorImpulse+this.m_impulse.z));var LA=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1;var LB=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;vA=vA.Subtract(P.Multiply(mA));wA-=iA*LA;vB=vB.Add(P.Multiply(mB));wB+=iB*LB;}else{this.m_impulse.SetZero();this.m_motorImpulse=0.0;}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};PrismaticJoint.prototype.SolveVelocityConstraints=function(data){var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var mA=this.m_invMassA,mB=this.m_invMassB;var iA=this.m_invIA,iB=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!=3){(function(self){var Cdot=self.m_axis.Dot(vB.Subtract(vA))+self.m_a2*wB-self.m_a1*wA;var impulse=self.m_motorMass*(self.m_motorSpeed-Cdot);var oldImpulse=self.m_motorImpulse;var maxImpulse=data.step.dt*self.m_maxMotorForce;self.m_motorImpulse=PhysicsType2d.MathExtensions.Clamp(self.m_motorImpulse+impulse,-maxImpulse,maxImpulse);impulse=self.m_motorImpulse-oldImpulse;var P=self.m_axis.Multiply(impulse);var LA=impulse*self.m_a1;var LB=impulse*self.m_a2;vA=vA.Subtract(P.Multiply(mA));wA-=iA*LA;vB=vB.Add(P.Multiply(mB));wB+=iB*LB;})(this);}
var Cdot1=new PhysicsType2d.Vector2(0,0);Cdot1.x=this.m_perp.Dot(vB.Subtract(vA))+this.m_s2*wB-this.m_s1*wA;Cdot1.y=wB-wA;if(this.m_enableLimit&&this.m_limitState!=0){(function(self){var Cdot2=self.m_axis.Dot(vB.Subtract(vA))+self.m_a2*wB-self.m_a1*wA;var Cdot=new PhysicsType2d.Vector3(Cdot1.x,Cdot1.y,Cdot2);var f1=self.m_impulse;var df=self.m_K.Solve3x3(Cdot.Negative());self.m_impulse=self.m_impulse.Add(df);if(self.m_limitState==1){self.m_impulse.z=Math.max(self.m_impulse.z,0.0);}else if(self.m_limitState==2){self.m_impulse.z=Math.min(self.m_impulse.z,0.0);}
var b=(Cdot1.Negative()).Subtract((new PhysicsType2d.Vector2(self.m_K.EZ.x,self.m_K.EZ.y)).Multiply(self.m_impulse.z-f1.z));var f2r=self.m_K.Solve2x2(b).Add(new PhysicsType2d.Vector2(f1.x,f1.y));self.m_impulse.x=f2r.x;self.m_impulse.y=f2r.y;df=self.m_impulse.Subtract(f1);var P=(self.m_perp.Multiply(df.x)).Add(self.m_axis.Multiply(df.z));var LA=df.x*self.m_s1+df.y+df.z*self.m_a1;var LB=df.x*self.m_s2+df.y+df.z*self.m_a2;vA=vA.Subtract(P.Multiply(mA));wA-=iA*LA;vB=vB.Add(P.Multiply(mB));wB+=iB*LB;})(this);}else{(function(self){var df=self.m_K.Solve2x2(Cdot1.Negative());self.m_impulse.x+=df.x;self.m_impulse.y+=df.y;var P=self.m_perp.Multiply(df.x);var LA=df.x*self.m_s1+df.y;var LB=df.x*self.m_s2+df.y;vA=vA.Subtract(P.Multiply(mA));wA-=iA*LA;vB=vB.Add(P.Multiply(mB));wB+=iB*LB;var Cdot10=Cdot1;Cdot1.x=self.m_perp.Dot(vB.Subtract(vA))+self.m_s2*wB-self.m_s1*wA;Cdot1.y=wB-wA;if(Math.abs(Cdot1.x)>0.01||Math.abs(Cdot1.y)>0.01){var test=self.m_K.Vector2Multiply(df);Cdot1.x+=0.0;}})(this);}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};PrismaticJoint.prototype.SolvePositionConstraints=function(data){var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var mA=this.m_invMassA;var mB=this.m_invMassB;var iA=this.m_invIA;var iB=this.m_invIB;var rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));var rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var d=cB.Add(rB).Subtract(cA).Subtract(rA);var axis=qA.ApplyToVector2(this.m_localXAxisA);var a1=(d.Add(rA)).Cross(axis);var a2=rB.Cross(axis);var perp=qA.ApplyToVector2(this.m_localYAxisA);var s1=(d.Add(rA)).Cross(perp);var s2=rB.Cross(perp);var impulse=new PhysicsType2d.Vector3(0,0,0);var C1=new PhysicsType2d.Vector2(perp.Dot(d),aB-aA-this.m_referenceAngle);var linearError=Math.abs(C1.x);var angularError=Math.abs(C1.y);var active=false;var C2=0.0;if(this.m_enableLimit){var translation=axis.Dot(d);if(Math.abs(this.m_upperTranslation-this.m_lowerTranslation)<2.0*PhysicsType2d.Settings.linearSlop){C2=PhysicsType2d.MathExtensions.Clamp(translation,-PhysicsType2d.Settings.maxLinearCorrection,PhysicsType2d.Settings.maxLinearCorrection);linearError=Math.max(linearError,Math.abs(translation));active=true;}else if(translation<=this.m_lowerTranslation){C2=PhysicsType2d.MathExtensions.Clamp(translation-this.m_lowerTranslation+PhysicsType2d.Settings.linearSlop,-PhysicsType2d.Settings.maxLinearCorrection,0.0);linearError=Math.max(linearError,this.m_lowerTranslation-translation);active=true;}else if(translation>=this.m_upperTranslation){C2=PhysicsType2d.MathExtensions.Clamp(translation-this.m_upperTranslation-PhysicsType2d.Settings.linearSlop,0.0,PhysicsType2d.Settings.maxLinearCorrection);linearError=Math.max(linearError,translation-this.m_upperTranslation);active=true;}}
if(active){(function(self){var k11=mA+mB+iA*s1*s1+iB*s2*s2;var k12=iA*s1+iB*s2;var k13=iA*s1*a1+iB*s2*a2;var k22=iA+iB;if(k22==0.0){k22=1.0;}
var k23=iA*a1+iB*a2;var k33=mA+mB+iA*a1*a1+iB*a2*a2;var K=new PhysicsType2d.Matrix3x3;K.EX.Set(k11,k12,k13);K.EY.Set(k12,k22,k23);K.EZ.Set(k13,k23,k33);var C=new PhysicsType2d.Vector3(0,0,0);C.x=C1.x;C.y=C1.y;C.z=C2;impulse=K.Solve3x3(C.Negative());})(this);}else{(function(self){var k11=mA+mB+iA*s1*s1+iB*s2*s2;var k12=iA*s1+iB*s2;var k22=iA+iB;if(k22==0.0){k22=1.0;}
var K=new PhysicsType2d.Matrix2x2();K.EX.Set(k11,k12);K.EY.Set(k12,k22);var impulse1=K.Solve(C1.Negative());impulse.x=impulse1.x;impulse.y=impulse1.y;impulse.z=0.0;})(this);}
var P=(perp.Multiply(impulse.x)).Add(axis.Multiply(impulse.z));var LA=impulse.x*s1+impulse.y+impulse.z*a1;var LB=impulse.x*s2+impulse.y+impulse.z*a2;cA=cA.Subtract(P.Multiply(mA));aA-=iA*LA;cB=cB.Add(P.Multiply(mB));aB+=iB*LB;data.positions[this.m_indexA].c=cA;data.positions[this.m_indexA].a=aA;data.positions[this.m_indexB].c=cB;data.positions[this.m_indexB].a=aB;return linearError<=PhysicsType2d.Settings.linearSlop&&angularError<=PhysicsType2d.Settings.angularSlop;};return PrismaticJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.PrismaticJoint=PrismaticJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var GearJointDefinition=(function(_super){__extends(GearJointDefinition,_super);function GearJointDefinition(){_super.call(this);this.type=6;this.joint1=null;this.joint2=null;this.ratio=1.0;}
return GearJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.GearJointDefinition=GearJointDefinition;var GearJoint=(function(_super){__extends(GearJoint,_super);function GearJoint(def){_super.call(this,def);this.m_localAnchorC=new PhysicsType2d.Vector2(0,0);this.m_localAnchorD=new PhysicsType2d.Vector2(0,0);this.m_localAxisC=new PhysicsType2d.Vector2(0,0);this.m_localAxisD=new PhysicsType2d.Vector2(0,0);this.m_localAnchorA=new PhysicsType2d.Vector2(0,0);this.m_localAnchorB=new PhysicsType2d.Vector2(0,0);this.m_lcA=new PhysicsType2d.Vector2(0,0);this.m_lcB=new PhysicsType2d.Vector2(0,0);this.m_lcC=new PhysicsType2d.Vector2(0,0);this.m_lcD=new PhysicsType2d.Vector2(0,0);this.m_JvAC=new PhysicsType2d.Vector2(0,0);this.m_JvBD=new PhysicsType2d.Vector2(0,0);this.m_joint1=def.joint1;this.m_joint2=def.joint2;this.m_typeA=this.m_joint1.GetType();this.m_typeB=this.m_joint2.GetType();PhysicsType2d.Assert(this.m_typeA==1||this.m_typeA==2);PhysicsType2d.Assert(this.m_typeB==1||this.m_typeB==2);var coordinateA;var coordinateB;this.m_bodyC=this.m_joint1.GetBodyA();this.m_bodyA=this.m_joint1.GetBodyB();var xfA=this.m_bodyA.GetTransform();var aA=this.m_bodyA.GetSweep().a;var xfC=this.m_bodyC.GetTransform();var aC=this.m_bodyC.GetSweep().a;if(this.m_typeA==1){var revolute=def.joint1;this.m_localAnchorC=revolute.GetLocalAnchorA();this.m_localAnchorA=revolute.GetLocalAnchorB();this.m_referenceAngleA=revolute.GetReferenceAngle();coordinateA=aA-aC-this.m_referenceAngleA;}else{var prismatic=def.joint1;this.m_localAnchorC=prismatic.GetLocalAnchorA();this.m_localAnchorA=prismatic.GetLocalAnchorB();this.m_referenceAngleA=prismatic.GetReferenceAngle();this.m_localAxisC=prismatic.GetLocalAxisA();var pC=this.m_localAnchorC;var pA=xfC.q.ApplyTransposeToVector2(xfA.q.ApplyToVector2(this.m_localAnchorA).Add(xfA.p.Subtract(xfC.p)));coordinateA=(pA.Subtract(pC)).Dot(this.m_localAxisC);}
this.m_bodyD=this.m_joint2.GetBodyA();this.m_bodyB=this.m_joint2.GetBodyB();var xfB=this.m_bodyB.GetTransform();var aB=this.m_bodyB.GetSweep().a;var xfD=this.m_bodyD.GetTransform();var aD=this.m_bodyD.GetSweep().a;if(this.m_typeB==1){var revolute=def.joint2;this.m_localAnchorD=revolute.GetLocalAnchorA();this.m_localAnchorB=revolute.GetLocalAnchorB();this.m_referenceAngleB=revolute.GetReferenceAngle();coordinateB=aB-aD-this.m_referenceAngleB;}else{var prismatic=def.joint2;this.m_localAnchorD=prismatic.GetLocalAnchorA();this.m_localAnchorB=prismatic.GetLocalAnchorB();this.m_referenceAngleB=prismatic.GetReferenceAngle();this.m_localAxisD=prismatic.GetLocalAxisA();var pD=this.m_localAnchorD;var pB=xfD.q.ApplyTransposeToVector2(xfB.q.ApplyToVector2(this.m_localAnchorB).Add(xfB.p.Subtract(xfD.p)));coordinateB=(pB.Subtract(pD)).Dot(this.m_localAxisD);}
this.m_ratio=def.ratio;this.m_constant=coordinateA+this.m_ratio*coordinateB;this.m_impulse=0.0;}
GearJoint.prototype.InitVelocityConstraints=function(data){this.m_indexA=this.m_bodyA.GetIslandIndex();this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_indexC=this.m_bodyC.GetIslandIndex();this.m_indexD=this.m_bodyD.GetIslandIndex();this.m_lcA=this.m_bodyA.GetSweep().localCenter;this.m_lcB=this.m_bodyB.GetSweep().localCenter;this.m_lcC=this.m_bodyC.GetSweep().localCenter;this.m_lcD=this.m_bodyD.GetSweep().localCenter;this.m_mA=this.m_bodyA.GetInvMass();this.m_mB=this.m_bodyB.GetInvMass();this.m_mC=this.m_bodyC.GetInvMass();this.m_mD=this.m_bodyD.GetInvMass();this.m_iA=this.m_bodyA.GetInvI();this.m_iB=this.m_bodyB.GetInvI();this.m_iC=this.m_bodyC.GetInvI();this.m_iD=this.m_bodyD.GetInvI();var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var cC=data.positions[this.m_indexC].c;var aC=data.positions[this.m_indexC].a;var vC=data.velocities[this.m_indexC].v;var wC=data.velocities[this.m_indexC].w;var cD=data.positions[this.m_indexD].c;var aD=data.positions[this.m_indexD].a;var vD=data.velocities[this.m_indexD].v;var wD=data.velocities[this.m_indexD].w;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var qC=PhysicsType2d.Rotation.FromRadians(aC);var qD=PhysicsType2d.Rotation.FromRadians(aD);this.m_mass=0.0;if(this.m_typeA==1){this.m_JvAC.SetZero();this.m_JwA=1.0;this.m_JwC=1.0;this.m_mass+=this.m_iA+this.m_iC;}else{var u=qC.ApplyToVector2(this.m_localAxisC);var rC=qC.ApplyToVector2(this.m_localAnchorC.Subtract(this.m_lcC));var rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_lcA));this.m_JvAC=u;this.m_JwC=rC.Cross(u);this.m_JwA=rA.Cross(u);this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA;}
if(this.m_typeB==1){this.m_JvBD.SetZero();this.m_JwB=this.m_ratio;this.m_JwD=this.m_ratio;this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);}else{var u=qD.ApplyToVector2(this.m_localAxisD);var rD=qD.ApplyToVector2(this.m_localAnchorD.Subtract(this.m_lcD));var rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_lcB));this.m_JvBD=u.Multiply(this.m_ratio);this.m_JwD=this.m_ratio*rD.Cross(u);this.m_JwB=this.m_ratio*rB.Cross(u);this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB;}
this.m_mass=this.m_mass>0.0?1.0/this.m_mass:0.0;if(data.step.warmStarting){vA=vA.Add(this.m_JvAC.Multiply(this.m_mA*this.m_impulse));wA+=this.m_iA*this.m_impulse*this.m_JwA;vB=vB.Add(this.m_JvBD.Multiply(this.m_mB*this.m_impulse));wB+=this.m_iB*this.m_impulse*this.m_JwB;vC=vC.Subtract(this.m_JvAC.Multiply(this.m_mC*this.m_impulse));wC-=this.m_iC*this.m_impulse*this.m_JwC;vD=vD.Subtract(this.m_JvBD.Multiply(this.m_mD*this.m_impulse));wD-=this.m_iD*this.m_impulse*this.m_JwD;}else{this.m_impulse=0.0;}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;data.velocities[this.m_indexC].v=vC;data.velocities[this.m_indexC].w=wC;data.velocities[this.m_indexD].v=vD;data.velocities[this.m_indexD].w=wD;};GearJoint.prototype.SolveVelocityConstraints=function(data){var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var vC=data.velocities[this.m_indexC].v;var wC=data.velocities[this.m_indexC].w;var vD=data.velocities[this.m_indexD].v;var wD=data.velocities[this.m_indexD].w;var Cdot=this.m_JvAC.Dot(vA.Subtract(vC))+this.m_JvBD.Dot(vB.Subtract(vD));Cdot+=(this.m_JwA*wA-this.m_JwC*wC)+(this.m_JwB*wB-this.m_JwD*wD);var impulse=-this.m_mass*Cdot;this.m_impulse+=impulse;vA=vA.Add(this.m_JvAC.Multiply(this.m_mA*impulse));wA+=this.m_iA*impulse*this.m_JwA;vB=vB.Add(this.m_JvBD.Multiply(this.m_mB*impulse));wB+=this.m_iB*impulse*this.m_JwB;vC=vC.Subtract(this.m_JvAC.Multiply(this.m_mC*impulse));wC-=this.m_iC*impulse*this.m_JwC;vD=vD.Subtract(this.m_JvBD.Multiply(this.m_mD*impulse));wD-=this.m_iD*impulse*this.m_JwD;data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;data.velocities[this.m_indexC].v=vC;data.velocities[this.m_indexC].w=wC;data.velocities[this.m_indexD].v=vD;data.velocities[this.m_indexD].w=wD;};GearJoint.prototype.SolvePositionConstraints=function(data){var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var cC=data.positions[this.m_indexC].c;var aC=data.positions[this.m_indexC].a;var cD=data.positions[this.m_indexD].c;var aD=data.positions[this.m_indexD].a;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var qC=PhysicsType2d.Rotation.FromRadians(aC);var qD=PhysicsType2d.Rotation.FromRadians(aD);var linearError=0.0;var coordinateA;var coordinateB;var JvAC=new PhysicsType2d.Vector2(0,0);var JvBD=new PhysicsType2d.Vector2(0,0);var JwA;var JwB;var JwC;var JwD;var mass=0.0;if(this.m_typeA==1){JvAC.SetZero();JwA=1.0;JwC=1.0;mass+=this.m_iA+this.m_iC;coordinateA=aA-aC-this.m_referenceAngleA;}else{var u=qC.ApplyToVector2(this.m_localAxisC);var rC=qC.ApplyToVector2(this.m_localAnchorC.Subtract(this.m_lcC));var rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_lcA));JvAC=u;JwC=rC.Cross(u);JwA=rA.Cross(u);mass+=this.m_mC+this.m_mA+this.m_iC*JwC*JwC+this.m_iA*JwA*JwA;var pC=this.m_localAnchorC.Subtract(this.m_lcC);var pA=qC.ApplyTransposeToVector2(rA.Add(cA.Subtract(cC)));coordinateA=(pA.Subtract(pC)).Dot(this.m_localAxisC);}
if(this.m_typeB==1){JvBD.SetZero();JwB=this.m_ratio;JwD=this.m_ratio;mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);coordinateB=aB-aD-this.m_referenceAngleB;}else{var u=qD.ApplyToVector2(this.m_localAxisD);var rD=qD.ApplyToVector2(this.m_localAnchorD.Subtract(this.m_lcD));var rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_lcB));JvBD=u.Multiply(this.m_ratio);JwD=this.m_ratio*rD.Cross(u);JwB=this.m_ratio*rB.Cross(u);mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*JwD*JwD+this.m_iB*JwB*JwB;var pD=this.m_localAnchorD.Subtract(this.m_lcD);var pB=qD.ApplyTransposeToVector2(rB.Add(cB.Subtract(cD)));coordinateB=(pB.Subtract(pD)).Dot(this.m_localAxisD);}
var C=(coordinateA+this.m_ratio*coordinateB)-this.m_constant;var impulse=0.0;if(mass>0.0){impulse=-C/mass;}
cA=cA.Add(JvAC.Multiply(this.m_mA*impulse));aA+=this.m_iA*impulse*JwA;cB=cB.Add(JvBD.Multiply(this.m_mB*impulse));aB+=this.m_iB*impulse*JwB;cC=cC.Subtract(JvAC.Multiply(this.m_mC*impulse));aC-=this.m_iC*impulse*JwC;cD=cD.Subtract(JvBD.Multiply(this.m_mD*impulse));aD-=this.m_iD*impulse*JwD;data.positions[this.m_indexA].c=cA;data.positions[this.m_indexA].a=aA;data.positions[this.m_indexB].c=cB;data.positions[this.m_indexB].a=aB;data.positions[this.m_indexC].c=cC;data.positions[this.m_indexC].a=aC;data.positions[this.m_indexD].c=cD;data.positions[this.m_indexD].a=aD;return linearError<PhysicsType2d.Settings.linearSlop;};GearJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);};GearJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);};GearJoint.prototype.GetReactionForce=function(inv_dt){var P=this.m_JvAC.Multiply(this.m_impulse);return P.Multiply(inv_dt);};GearJoint.prototype.GetReactionTorque=function(inv_dt){var L=this.m_impulse*this.m_JwA;return inv_dt*L;};GearJoint.prototype.SetRatio=function(ratio){PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(ratio));this.m_ratio=ratio;};GearJoint.prototype.GetRatio=function(){return this.m_ratio;};GearJoint.prototype.Dump=function(){var indexA=this.m_bodyA.GetIslandIndex();var indexB=this.m_bodyB.GetIslandIndex();var index1=this.m_joint1.m_index;var index2=this.m_joint2.m_index;PhysicsType2d.Utils.log("  GearJointDef jd;");PhysicsType2d.Utils.log("  jd.bodyA = bodies[{0}];",indexA);PhysicsType2d.Utils.log("  jd.bodyB = bodies[{0}];",indexB);PhysicsType2d.Utils.log("  jd.collideConnected = boolean({0});",this.m_collideConnected);PhysicsType2d.Utils.log("  jd.joint1 = joints[{0}];",index1);PhysicsType2d.Utils.log("  jd.joint2 = joints[{0}];",index2);PhysicsType2d.Utils.log("  jd.ratio = {0};",this.m_ratio);PhysicsType2d.Utils.log("  joints[{0}] = this.m_world->CreateJoint(&jd);",this.m_index);};GearJoint.prototype.GetJoint1=function(){return this.m_joint1;};GearJoint.prototype.GetJoint2=function(){return this.m_joint2;};return GearJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.GearJoint=GearJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var MouseJointDefinition=(function(_super){__extends(MouseJointDefinition,_super);function MouseJointDefinition(){_super.call(this);this.target=new PhysicsType2d.Vector2(0,0);this.type=5;this.maxForce=0.0;this.frequencyHz=5.0;this.dampingRatio=0.7;}
return MouseJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.MouseJointDefinition=MouseJointDefinition;var MouseJoint=(function(_super){__extends(MouseJoint,_super);function MouseJoint(def){_super.call(this,def);this.m_localAnchorB=new PhysicsType2d.Vector2(0,0);this.m_targetA=new PhysicsType2d.Vector2(0,0);this.m_impulse=new PhysicsType2d.Vector2(0,0);this.m_rB=new PhysicsType2d.Vector2(0,0);this.m_localCenterB=new PhysicsType2d.Vector2(0,0);this.m_mass=new PhysicsType2d.Matrix2x2();this.m_C=new PhysicsType2d.Vector2(0,0);PhysicsType2d.Assert(def.target.IsValid());PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(def.maxForce)&&def.maxForce>=0.0);PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(def.frequencyHz)&&def.frequencyHz>=0.0);PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(def.dampingRatio)&&def.dampingRatio>=0.0);this.m_targetA=def.target;this.m_localAnchorB=this.m_bodyB.GetTransform().ApplyTransposeToVector2(this.m_targetA);this.m_maxForce=def.maxForce;this.m_frequencyHz=def.frequencyHz;this.m_dampingRatio=def.dampingRatio;this.m_beta=0.0;this.m_gamma=0.0;}
MouseJoint.prototype.SetTarget=function(target){if(!this.m_bodyB.IsAwake()){this.m_bodyB.SetAwake(true);}
this.m_targetA=target;};MouseJoint.prototype.GetTarget=function(){return this.m_targetA;};MouseJoint.prototype.SetMaxForce=function(force){this.m_maxForce=force;};MouseJoint.prototype.GetMaxForce=function(){return this.m_maxForce;};MouseJoint.prototype.SetFrequency=function(hz){this.m_frequencyHz=hz;};MouseJoint.prototype.GetFrequency=function(){return this.m_frequencyHz;};MouseJoint.prototype.SetDampingRatio=function(ratio){this.m_dampingRatio=ratio;};MouseJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio;};MouseJoint.prototype.GetAnchorA=function(){return this.m_targetA;};MouseJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);};MouseJoint.prototype.GetReactionForce=function(inv_dt){return this.m_impulse.Multiply(inv_dt);};MouseJoint.prototype.GetReactionTorque=function(inv_dt){return inv_dt*0.0;};MouseJoint.prototype.InitVelocityConstraints=function(data){this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_localCenterB=this.m_bodyB.GetSweep().localCenter;this.m_invMassB=this.m_bodyB.GetInvMass();this.m_invIB=this.m_bodyB.GetInvI();var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var qB=PhysicsType2d.Rotation.FromRadians(aB);var mass=this.m_bodyB.GetMass();var omega=2.0*PhysicsType2d.Constants.PI*this.m_frequencyHz;var d=2.0*mass*this.m_dampingRatio*omega;var k=mass*(omega*omega);var h=data.step.dt;PhysicsType2d.Assert(d+h*k>PhysicsType2d.Constants.EPSILON);this.m_gamma=h*(d+h*k);if(this.m_gamma!=0.0){this.m_gamma=1.0/this.m_gamma;}
this.m_beta=h*k*this.m_gamma;this.m_rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var K=new PhysicsType2d.Matrix2x2();K.EX.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma;K.EX.y=-this.m_invIB*this.m_rB.x*this.m_rB.y;K.EY.x=K.EX.y;K.EY.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma;this.m_mass=K.GetInverse();this.m_C=cB.Add(this.m_rB).Subtract(this.m_targetA);this.m_C=this.m_C.Multiply(this.m_beta);wB*=0.98;if(data.step.warmStarting){this.m_impulse=this.m_impulse.Multiply(data.step.dtRatio);vB=vB.Add(this.m_impulse.Multiply(this.m_invMassB));wB+=this.m_invIB*this.m_rB.Cross(this.m_impulse);}else{this.m_impulse.SetZero();}
data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};MouseJoint.prototype.SolveVelocityConstraints=function(data){var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var Cdot=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,this.m_rB));var impulse=this.m_mass.VectorMultiply(Cdot.Add(this.m_C).Add(this.m_impulse.Multiply(this.m_gamma)).Negative());var oldImpulse=this.m_impulse;this.m_impulse=this.m_impulse.Add(impulse);var maxImpulse=data.step.dt*this.m_maxForce;if(this.m_impulse.LengthSquared()>maxImpulse*maxImpulse){this.m_impulse=this.m_impulse.Multiply(maxImpulse/this.m_impulse.Length());}
impulse=this.m_impulse.Subtract(oldImpulse);vB=vB.Add(impulse.Multiply(this.m_invMassB));wB+=this.m_invIB*this.m_rB.Cross(impulse);data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};MouseJoint.prototype.SolvePositionConstraints=function(data){return true;};return MouseJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.MouseJoint=MouseJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var MotorJointDefinition=(function(_super){__extends(MotorJointDefinition,_super);function MotorJointDefinition(){_super.call(this);this.linearOffset=new PhysicsType2d.Vector2(0,0);this.type=11;this.angularOffset=0.0;this.maxForce=1.0;this.maxTorque=1.0;this.correctionFactor=0.3;}
MotorJointDefinition.prototype.Initialize=function(bA,bB){this.bodyA=bA;this.bodyB=bB;var xB=this.bodyB.GetPosition();this.linearOffset=this.bodyA.GetLocalPoint(xB);var angleA=this.bodyA.GetAngle();var angleB=this.bodyB.GetAngle();this.angularOffset=angleB-angleA;};return MotorJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.MotorJointDefinition=MotorJointDefinition;var MotorJoint=(function(_super){__extends(MotorJoint,_super);function MotorJoint(def){_super.call(this,def);this.m_linearOffset=new PhysicsType2d.Vector2(0,0);this.m_linearImpulse=new PhysicsType2d.Vector2(0,0);this.m_rA=new PhysicsType2d.Vector2(0,0);this.m_rB=new PhysicsType2d.Vector2(0,0);this.m_localCenterA=new PhysicsType2d.Vector2(0,0);this.m_localCenterB=new PhysicsType2d.Vector2(0,0);this.m_linearError=new PhysicsType2d.Vector2(0,0);this.m_linearMass=new PhysicsType2d.Matrix2x2();this.m_linearOffset=def.linearOffset;this.m_angularOffset=def.angularOffset;this.m_angularImpulse=0.0;this.m_maxForce=def.maxForce;this.m_maxTorque=def.maxTorque;this.m_correctionFactor=def.correctionFactor;}
MotorJoint.prototype.SetMaxForce=function(force){PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(force)&&force>=0.0);this.m_maxForce=force;};MotorJoint.prototype.GetMaxForce=function(){return this.m_maxForce;};MotorJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetPosition();};MotorJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetPosition();};MotorJoint.prototype.GetReactionForce=function(inv_dt){return this.m_linearImpulse.Multiply(inv_dt);};MotorJoint.prototype.GetReactionTorque=function(inv_dt){return inv_dt*this.m_angularImpulse;};MotorJoint.prototype.InitVelocityConstraints=function(data){this.m_indexA=this.m_bodyA.GetIslandIndex();this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_localCenterA=this.m_bodyA.GetSweep().localCenter;this.m_localCenterB=this.m_bodyB.GetSweep().localCenter;this.m_invMassA=this.m_bodyA.GetInvMass();this.m_invMassB=this.m_bodyB.GetInvMass();this.m_invIA=this.m_bodyA.GetInvI();this.m_invIB=this.m_bodyB.GetInvI();var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);this.m_rA=qA.ApplyToVector2(this.m_localCenterA.Negative());this.m_rB=qB.ApplyToVector2(this.m_localCenterB.Negative());var mA=this.m_invMassA;var mB=this.m_invMassB;var iA=this.m_invIA;var iB=this.m_invIB;var K=new PhysicsType2d.Matrix2x2();K.EX.x=mA+mB+iA*this.m_rA.y*this.m_rA.y+iB*this.m_rB.y*this.m_rB.y;K.EX.y=-iA*this.m_rA.x*this.m_rA.y-iB*this.m_rB.x*this.m_rB.y;K.EY.x=K.EX.y;K.EY.y=mA+mB+iA*this.m_rA.x*this.m_rA.x+iB*this.m_rB.x*this.m_rB.x;this.m_linearMass=K.GetInverse();this.m_angularMass=iA+iB;if(this.m_angularMass>0.0){this.m_angularMass=1.0/this.m_angularMass;}
this.m_linearError=cB.Add(this.m_rB).Subtract(cA).Subtract(this.m_rA).Subtract(qA.ApplyToVector2(this.m_linearOffset));this.m_angularError=aB-aA-this.m_angularOffset;if(data.step.warmStarting){this.m_linearImpulse=this.m_linearImpulse.Multiply(data.step.dtRatio);this.m_angularImpulse*=data.step.dtRatio;var P=new PhysicsType2d.Vector2(this.m_linearImpulse.x,this.m_linearImpulse.y);vA=vA.Subtract(P.Multiply(mA));wA-=iA*(PhysicsType2d.MathExtensions.Cross2x2(this.m_rA,P)+this.m_angularImpulse);vB=vB.Add(P.Multiply(mB));wB+=iB*(PhysicsType2d.MathExtensions.Cross2x2(this.m_rB,P)+this.m_angularImpulse);}else{this.m_linearImpulse.SetZero();this.m_angularImpulse=0.0;}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};MotorJoint.prototype.SolveAngularFriction=function(velocityA,velocityB,h,inv_h){var Cdot=velocityB.w-velocityA.w+inv_h*this.m_correctionFactor*this.m_angularError;var impulse=-this.m_angularMass*Cdot;var oldImpulse=this.m_angularImpulse;var maxImpulse=h*this.m_maxTorque;this.m_angularImpulse=PhysicsType2d.MathExtensions.Clamp(this.m_angularImpulse+impulse,-maxImpulse,maxImpulse);impulse=this.m_angularImpulse-oldImpulse;var iA=this.m_invIA;var iB=this.m_invIB;velocityA.w-=iA*impulse;velocityB.w+=iB*impulse;};MotorJoint.prototype.SolveLinearFriction=function(velocityA,velocityB,h,inv_h){var Cdot=velocityB.v.Add(PhysicsType2d.MathExtensions.Cross1x2(velocityB.w,this.m_rB)).Subtract(velocityA.v).Subtract(PhysicsType2d.MathExtensions.Cross1x2(velocityA.w,this.m_rA)).Add(this.m_linearError.Multiply(inv_h*this.m_correctionFactor));var impulse=this.m_linearMass.VectorMultiply(Cdot).Negative();var oldImpulse=this.m_linearImpulse;this.m_linearImpulse=this.m_linearImpulse.Add(impulse);var maxImpulse=h*this.m_maxForce;if(this.m_linearImpulse.LengthSquared()>maxImpulse*maxImpulse){this.m_linearImpulse.Normalize();this.m_linearImpulse=this.m_linearImpulse.Multiply(maxImpulse);}
impulse=this.m_linearImpulse.Subtract(oldImpulse);var mA=this.m_invMassA;var mB=this.m_invMassB;var iA=this.m_invIA;var iB=this.m_invIB;velocityA.v=velocityA.v.Subtract(impulse.Multiply(mA));velocityA.w-=iA*PhysicsType2d.MathExtensions.Cross2x2(this.m_rA,impulse);velocityB.v=velocityB.v.Add(impulse.Multiply(mB));velocityB.w+=iB*PhysicsType2d.MathExtensions.Cross2x2(this.m_rB,impulse);};MotorJoint.prototype.SolveVelocityConstraints=function(data){var h=data.step.dt;var inv_h=data.step.inv_dt;this.SolveAngularFriction(data.velocities[this.m_indexA],data.velocities[this.m_indexB],h,inv_h);this.SolveLinearFriction(data.velocities[this.m_indexA],data.velocities[this.m_indexB],h,inv_h);};MotorJoint.prototype.SolvePositionConstraints=function(data){return true;};MotorJoint.prototype.Dump=function(){var indexA=this.m_bodyA.GetIslandIndex();var indexB=this.m_bodyB.GetIslandIndex();PhysicsType2d.Utils.log(" MotorJointDef jd;");PhysicsType2d.Utils.log("  jd.bodyA = bodies[{0}];",indexA);PhysicsType2d.Utils.log("  jd.bodyB = bodies[{0}];",indexB);PhysicsType2d.Utils.log("  jd.collideConnected = bool({0});",this.m_collideConnected);PhysicsType2d.Utils.log("  jd.linearOffset.Set({0}, {1});",this.m_linearOffset.x,this.m_linearOffset.y);PhysicsType2d.Utils.log("  jd.angularOffset = {0};",this.m_angularOffset);PhysicsType2d.Utils.log("  jd.maxForce = {0};",this.m_maxForce);PhysicsType2d.Utils.log("  jd.maxTorque = {0};",this.m_maxTorque);PhysicsType2d.Utils.log("  jd.correctionFactor = {0};",this.m_correctionFactor);PhysicsType2d.Utils.log("  joints[{0}] = this.m_world.CreateJoint(&jd);",this.m_index);};MotorJoint.prototype.SetLinearOffset=function(linearOffset){if(linearOffset.x!=this.m_linearOffset.x||linearOffset.y!=this.m_linearOffset.y){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_linearOffset=linearOffset;}};MotorJoint.prototype.GetLinearOffset=function(){return this.m_linearOffset;};MotorJoint.prototype.SetAngularOffset=function(angularOffset){if(angularOffset!=this.m_angularOffset){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_angularOffset=angularOffset;}};MotorJoint.prototype.GetAngularOffset=function(){return this.m_angularOffset;};MotorJoint.prototype.SetMaxTorque=function(torque){PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(torque)&&torque>=0.0);this.m_maxTorque=torque;};MotorJoint.prototype.GetMaxTorque=function(){return this.m_maxTorque;};MotorJoint.prototype.SetCorrectionFactor=function(factor){PhysicsType2d.Assert(PhysicsType2d.MathExtensions.IsValid(factor)&&0.0<=factor&&factor<=1.0);this.m_correctionFactor=factor;};MotorJoint.prototype.GetCorrectionFactor=function(){return this.m_correctionFactor;};return MotorJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.MotorJoint=MotorJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var PulleyJointDefinition=(function(_super){__extends(PulleyJointDefinition,_super);function PulleyJointDefinition(){_super.call(this);this.groundAnchorA=new PhysicsType2d.Vector2(0,0);this.groundAnchorB=new PhysicsType2d.Vector2(0,0);this.localAnchorA=new PhysicsType2d.Vector2(0,0);this.localAnchorB=new PhysicsType2d.Vector2(0,0);this.type=4;this.groundAnchorA=new PhysicsType2d.Vector2(-1.0,1.0);this.groundAnchorB=new PhysicsType2d.Vector2(1.0,1.0);this.localAnchorA=new PhysicsType2d.Vector2(-1.0,0.0);this.localAnchorB=new PhysicsType2d.Vector2(1.0,0.0);this.lengthA=0.0;this.lengthB=0.0;this.ratio=1.0;this.collideConnected=true;}
PulleyJointDefinition.prototype.Initialize=function(bA,bB,groundA,groundB,anchorA,anchorB,r){this.bodyA=bA;this.bodyB=bB;this.groundAnchorA=groundA;this.groundAnchorB=groundB;this.localAnchorA=this.bodyA.GetLocalPoint(anchorA);this.localAnchorB=this.bodyB.GetLocalPoint(anchorB);var dA=anchorA.Subtract(groundA);this.lengthA=dA.Length();var dB=anchorB.Subtract(groundB);this.lengthB=dB.Length();this.ratio=r;PhysicsType2d.Assert(this.ratio>PhysicsType2d.Constants.EPSILON);};return PulleyJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.PulleyJointDefinition=PulleyJointDefinition;var PulleyJoint=(function(_super){__extends(PulleyJoint,_super);function PulleyJoint(def){_super.call(this,def);this.m_groundAnchorA=new PhysicsType2d.Vector2(0,0);this.m_groundAnchorB=new PhysicsType2d.Vector2(0,0);this.m_localAnchorA=new PhysicsType2d.Vector2(0,0);this.m_localAnchorB=new PhysicsType2d.Vector2(0,0);this.m_rA=new PhysicsType2d.Vector2(0,0);this.m_rB=new PhysicsType2d.Vector2(0,0);this.m_localCenterA=new PhysicsType2d.Vector2(0,0);this.m_localCenterB=new PhysicsType2d.Vector2(0,0);this.m_uA=new PhysicsType2d.Vector2(0,0);this.m_uB=new PhysicsType2d.Vector2(0,0);this.m_groundAnchorA=def.groundAnchorA;this.m_groundAnchorB=def.groundAnchorB;this.m_localAnchorA=def.localAnchorA;this.m_localAnchorB=def.localAnchorB;this.m_lengthA=def.lengthA;this.m_lengthB=def.lengthB;PhysicsType2d.Assert(def.ratio!=0.0);this.m_ratio=def.ratio;this.m_constant=def.lengthA+this.m_ratio*def.lengthB;this.m_impulse=0.0;}
PulleyJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);};PulleyJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);};PulleyJoint.prototype.GetReactionForce=function(inv_dt){var P=this.m_uB.Multiply(this.m_impulse);return P.Multiply(inv_dt);};PulleyJoint.prototype.GetReactionTorque=function(inv_dt){return 0.0;};PulleyJoint.prototype.GetGroundAnchorA=function(){return this.m_groundAnchorA;};PulleyJoint.prototype.GetGroundAnchorB=function(){return this.m_groundAnchorB;};PulleyJoint.prototype.GetLengthA=function(){var p=this.m_bodyA.GetWorldPoint(this.m_localAnchorA);var s=this.m_groundAnchorA;var d=p.Subtract(s);return d.Length();};PulleyJoint.prototype.GetLengthB=function(){var p=this.m_bodyB.GetWorldPoint(this.m_localAnchorB);var s=this.m_groundAnchorB;var d=p.Subtract(s);return d.Length();};PulleyJoint.prototype.GetRatio=function(){return this.m_ratio;};PulleyJoint.prototype.Dump=function(){var indexA=this.m_bodyA.GetIslandIndex();var indexB=this.m_bodyB.GetIslandIndex();PhysicsType2d.Utils.log(" PulleyJointDef jd;");PhysicsType2d.Utils.log("  jd.bodyA = bodies[{0}];",indexA);PhysicsType2d.Utils.log("  jd.bodyB = bodies[{0}];",indexB);PhysicsType2d.Utils.log("  jd.collideConnected = boolean({0});",this.m_collideConnected);PhysicsType2d.Utils.log("  jd.groundAnchorA.Set({0}, {1});",this.m_groundAnchorA.x,this.m_groundAnchorA.y);PhysicsType2d.Utils.log("  jd.groundAnchorB.Set({0}, {1});",this.m_groundAnchorB.x,this.m_groundAnchorB.y);PhysicsType2d.Utils.log("  jd.localAnchorA.Set({0}, {1});",this.m_localAnchorA.x,this.m_localAnchorA.y);PhysicsType2d.Utils.log("  jd.localAnchorB.Set({0}, {1});",this.m_localAnchorB.x,this.m_localAnchorB.y);PhysicsType2d.Utils.log("  jd.lengthA = {0};",this.m_lengthA);PhysicsType2d.Utils.log("  jd.lengthB = {0};",this.m_lengthB);PhysicsType2d.Utils.log("  jd.ratio = {0};",this.m_ratio);PhysicsType2d.Utils.log("  joints[{0}] = this.m_world->CreateJoint(&jd);",this.m_index);};PulleyJoint.prototype.InitVelocityConstraints=function(data){this.m_indexA=this.m_bodyA.GetIslandIndex();this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_localCenterA=this.m_bodyA.GetSweep().localCenter;this.m_localCenterB=this.m_bodyB.GetSweep().localCenter;this.m_invMassA=this.m_bodyA.GetInvMass();this.m_invMassB=this.m_bodyB.GetInvMass();this.m_invIA=this.m_bodyA.GetInvI();this.m_invIB=this.m_bodyB.GetInvI();var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);this.m_rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));this.m_rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));this.m_uA=cA.Add(this.m_rA).Subtract(this.m_groundAnchorA);this.m_uB=cB.Add(this.m_rB).Subtract(this.m_groundAnchorB);var lengthA=this.m_uA.Length();var lengthB=this.m_uB.Length();if(lengthA>10.0*PhysicsType2d.Settings.linearSlop){this.m_uA=this.m_uA.Multiply(1.0/lengthA);}else{this.m_uA.SetZero();}
if(lengthB>10.0*PhysicsType2d.Settings.linearSlop){this.m_uB=this.m_uB.Multiply(1.0/lengthB);}else{this.m_uB.SetZero();}
var ruA=this.m_rA.Cross(this.m_uA);var ruB=this.m_rB.Cross(this.m_uB);var mA=this.m_invMassA+this.m_invIA*ruA*ruA;var mB=this.m_invMassB+this.m_invIB*ruB*ruB;this.m_mass=mA+this.m_ratio*this.m_ratio*mB;if(this.m_mass>0.0){this.m_mass=1.0/this.m_mass;}
if(data.step.warmStarting){this.m_impulse*=data.step.dtRatio;var PA=this.m_uA.Multiply(-this.m_impulse);var PB=this.m_uB.Multiply(-this.m_ratio*this.m_impulse);vA=vA.Add(PA.Multiply(this.m_invMassA));wA+=this.m_invIA*this.m_rA.Cross(PA);vB=vB.Add(PB.Multiply(this.m_invMassB));wB+=this.m_invIB*this.m_rB.Cross(PB);}else{this.m_impulse=0.0;}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};PulleyJoint.prototype.SolveVelocityConstraints=function(data){var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var vpA=vA.Add(PhysicsType2d.MathExtensions.Cross1x2(wA,this.m_rA));var vpB=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,this.m_rB));var Cdot=-this.m_uA.Dot(vpA)-this.m_ratio*this.m_uB.Dot(vpB);var impulse=-this.m_mass*Cdot;this.m_impulse+=impulse;var PA=this.m_uA.Multiply(-impulse);var PB=this.m_uB.Multiply(-this.m_ratio*impulse);vA=vA.Add(PA.Multiply(this.m_invMassA));wA+=this.m_invIA*this.m_rA.Cross(PA);vB=vB.Add(PB.Multiply(this.m_invMassB));wB+=this.m_invIB*this.m_rB.Cross(PB);data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};PulleyJoint.prototype.SolvePositionConstraints=function(data){var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));var rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var uA=cA.Add(rA).Subtract(this.m_groundAnchorA);var uB=cB.Add(rB).Subtract(this.m_groundAnchorB);var lengthA=uA.Length();var lengthB=uB.Length();if(lengthA>10.0*PhysicsType2d.Settings.linearSlop){uA=uA.Multiply(1.0/lengthA);}else{uA.SetZero();}
if(lengthB>10.0*PhysicsType2d.Settings.linearSlop){uB=uB.Multiply(1.0/lengthB);}else{uB.SetZero();}
var ruA=rA.Cross(uA);var ruB=rB.Cross(uB);var mA=this.m_invMassA+this.m_invIA*ruA*ruA;var mB=this.m_invMassB+this.m_invIB*ruB*ruB;var mass=mA+this.m_ratio*this.m_ratio*mB;if(mass>0.0){mass=1.0/mass;}
var C=this.m_constant-lengthA-this.m_ratio*lengthB;var linearError=Math.abs(C);var impulse=-mass*C;var PA=uA.Multiply(-impulse);var PB=uB.Multiply(-this.m_ratio*impulse);cA=cA.Add(PA.Multiply(this.m_invMassA));aA+=this.m_invIA*rA.Cross(PA);cB=cB.Add(PB.Multiply(this.m_invMassB));aB+=this.m_invIB*rB.Cross(PB);data.positions[this.m_indexA].c=cA;data.positions[this.m_indexA].a=aA;data.positions[this.m_indexB].c=cB;data.positions[this.m_indexB].a=aB;return linearError<PhysicsType2d.Settings.linearSlop;};return PulleyJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.PulleyJoint=PulleyJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var RopeJointDefinition=(function(_super){__extends(RopeJointDefinition,_super);function RopeJointDefinition(){_super.call(this);this.localAnchorA=new PhysicsType2d.Vector2(0,0);this.localAnchorB=new PhysicsType2d.Vector2(0,0);this.type=10;this.localAnchorA=new PhysicsType2d.Vector2(-1.0,0.0);this.localAnchorB=new PhysicsType2d.Vector2(1.0,0.0);this.maxLength=0.0;}
return RopeJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.RopeJointDefinition=RopeJointDefinition;var RopeJoint=(function(_super){__extends(RopeJoint,_super);function RopeJoint(def){_super.call(this,def);this.m_localAnchorA=new PhysicsType2d.Vector2(0,0);this.m_localAnchorB=new PhysicsType2d.Vector2(0,0);this.m_u=new PhysicsType2d.Vector2(0,0);this.m_rA=new PhysicsType2d.Vector2(0,0);this.m_rB=new PhysicsType2d.Vector2(0,0);this.m_localCenterA=new PhysicsType2d.Vector2(0,0);this.m_localCenterB=new PhysicsType2d.Vector2(0,0);this.m_localAnchorA=def.localAnchorA;this.m_localAnchorB=def.localAnchorB;this.m_maxLength=def.maxLength;this.m_mass=0.0;this.m_impulse=0.0;this.m_state=0;this.m_length=0.0;}
RopeJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);};RopeJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);};RopeJoint.prototype.GetReactionForce=function(inv_dt){var F=this.m_u.Multiply(inv_dt*this.m_impulse);return F;};RopeJoint.prototype.GetReactionTorque=function(inv_dt){return 0.0;};RopeJoint.prototype.GetMaxLength=function(){return this.m_maxLength;};RopeJoint.prototype.GetLimitState=function(){return this.m_state;};RopeJoint.prototype.Dump=function(){var indexA=this.m_bodyA.GetIslandIndex();var indexB=this.m_bodyB.GetIslandIndex();PhysicsType2d.Utils.log(" RopeJointDef jd;");PhysicsType2d.Utils.log("  jd.bodyA = bodies[{0}];",indexA);PhysicsType2d.Utils.log("  jd.bodyB = bodies[{0}];",indexB);PhysicsType2d.Utils.log("  jd.collideConnected = boolean({0});",this.m_collideConnected);PhysicsType2d.Utils.log("  jd.localAnchorA.Set({0}, {1});",this.m_localAnchorA.x,this.m_localAnchorA.y);PhysicsType2d.Utils.log("  jd.localAnchorB.Set({0}, {1});",this.m_localAnchorB.x,this.m_localAnchorB.y);PhysicsType2d.Utils.log("  jd.maxLength = {0};",this.m_maxLength);PhysicsType2d.Utils.log("  joints[{0}] = this.m_world->CreateJoint(&jd);",this.m_index);};RopeJoint.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA;};RopeJoint.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB;};RopeJoint.prototype.SetMaxLength=function(length){this.m_maxLength=length;};RopeJoint.prototype.InitVelocityConstraints=function(data){this.m_indexA=this.m_bodyA.GetIslandIndex();this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_localCenterA=this.m_bodyA.GetSweep().localCenter;this.m_localCenterB=this.m_bodyB.GetSweep().localCenter;this.m_invMassA=this.m_bodyA.GetInvMass();this.m_invMassB=this.m_bodyB.GetInvMass();this.m_invIA=this.m_bodyA.GetInvI();this.m_invIB=this.m_bodyB.GetInvI();var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);this.m_rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));this.m_rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));this.m_u=cB.Add(this.m_rB).Subtract(cA).Subtract(this.m_rA);this.m_length=this.m_u.Length();var C=this.m_length-this.m_maxLength;if(C>0.0){this.m_state=2;}else{this.m_state=0;}
if(this.m_length>PhysicsType2d.Settings.linearSlop){this.m_u=this.m_u.Multiply(1.0/this.m_length);}else{this.m_u.SetZero();this.m_mass=0.0;this.m_impulse=0.0;return;}
var crA=this.m_rA.Cross(this.m_u);var crB=this.m_rB.Cross(this.m_u);var invMass=this.m_invMassA+this.m_invIA*crA*crA+this.m_invMassB+this.m_invIB*crB*crB;this.m_mass=invMass!=0.0?1.0/invMass:0.0;if(data.step.warmStarting){this.m_impulse*=data.step.dtRatio;var P=this.m_u.Multiply(this.m_impulse);vA=vA.Subtract(P.Multiply(this.m_invMassA));wA-=this.m_invIA*this.m_rA.Cross(P);vB=vB.Add(P.Multiply(this.m_invMassB));wB+=this.m_invIB*this.m_rB.Cross(P);}else{this.m_impulse=0.0;}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};RopeJoint.prototype.SolveVelocityConstraints=function(data){var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var vpA=vA.Add(PhysicsType2d.MathExtensions.Cross1x2(wA,this.m_rA));var vpB=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,this.m_rB));var C=this.m_length-this.m_maxLength;var Cdot=this.m_u.Dot(vpB.Subtract(vpA));if(C<0.0){Cdot+=data.step.inv_dt*C;}
var impulse=-this.m_mass*Cdot;var oldImpulse=this.m_impulse;this.m_impulse=Math.min(0.0,this.m_impulse+impulse);impulse=this.m_impulse-oldImpulse;var P=this.m_u.Multiply(impulse);vA=vA.Subtract(P.Multiply(this.m_invMassA));wA-=this.m_invIA*this.m_rA.Cross(P);vB=vB.Add(P.Multiply(this.m_invMassB));wB+=this.m_invIB*this.m_rB.Cross(P);data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};RopeJoint.prototype.SolvePositionConstraints=function(data){var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));var rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var u=cB.Add(rB).Subtract(cA).Subtract(rA);var length=u.Normalize();var C=length-this.m_maxLength;C=PhysicsType2d.MathExtensions.Clamp(C,0.0,PhysicsType2d.Settings.maxLinearCorrection);var impulse=-this.m_mass*C;var P=u.Multiply(impulse);cA=cA.Subtract(P.Multiply(this.m_invMassA));aA-=this.m_invIA*rA.Cross(P);cB=cB.Add(P.Multiply(this.m_invMassB));aB+=this.m_invIB*rB.Cross(P);data.positions[this.m_indexA].c=cA;data.positions[this.m_indexA].a=aA;data.positions[this.m_indexB].c=cB;data.positions[this.m_indexB].a=aB;return length-this.m_maxLength<PhysicsType2d.Settings.linearSlop;};return RopeJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.RopeJoint=RopeJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var WeldJointDefinition=(function(_super){__extends(WeldJointDefinition,_super);function WeldJointDefinition(){_super.call(this);this.localAnchorA=new PhysicsType2d.Vector2(0,0);this.localAnchorB=new PhysicsType2d.Vector2(0,0);this.type=8;this.localAnchorA=new PhysicsType2d.Vector2(0.0,0.0);this.localAnchorB=new PhysicsType2d.Vector2(0.0,0.0);this.referenceAngle=0.0;this.frequencyHz=0.0;this.dampingRatio=0.0;}
WeldJointDefinition.prototype.Initialize=function(bA,bB,anchor){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=this.bodyA.GetLocalPoint(anchor);this.localAnchorB=this.bodyB.GetLocalPoint(anchor);this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle();};return WeldJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.WeldJointDefinition=WeldJointDefinition;var WeldJoint=(function(_super){__extends(WeldJoint,_super);function WeldJoint(def){_super.call(this,def);this.m_impulse=new PhysicsType2d.Vector3(0,0,0);this.m_localAnchorA=new PhysicsType2d.Vector2(0,0);this.m_localAnchorB=new PhysicsType2d.Vector2(0,0);this.m_rA=new PhysicsType2d.Vector2(0,0);this.m_rB=new PhysicsType2d.Vector2(0,0);this.m_localCenterA=new PhysicsType2d.Vector2(0,0);this.m_localCenterB=new PhysicsType2d.Vector2(0,0);this.m_mass=new PhysicsType2d.Matrix3x3();this.m_localAnchorA=def.localAnchorA;this.m_localAnchorB=def.localAnchorB;this.m_referenceAngle=def.referenceAngle;this.m_frequencyHz=def.frequencyHz;this.m_dampingRatio=def.dampingRatio;}
WeldJoint.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA;};WeldJoint.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB;};WeldJoint.prototype.GetReferenceAngle=function(){return this.m_referenceAngle;};WeldJoint.prototype.SetFrequency=function(hz){this.m_frequencyHz=hz;};WeldJoint.prototype.GetFrequency=function(){return this.m_frequencyHz;};WeldJoint.prototype.SetDampingRatio=function(ratio){this.m_dampingRatio=ratio;};WeldJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio;};WeldJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);};WeldJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);};WeldJoint.prototype.GetReactionForce=function(inv_dt){var P=new PhysicsType2d.Vector2(this.m_impulse.x,this.m_impulse.y);return P.Multiply(inv_dt);};WeldJoint.prototype.GetReactionTorque=function(inv_dt){return inv_dt*this.m_impulse.z;};WeldJoint.prototype.Dump=function(){var indexA=this.m_bodyA.GetIslandIndex();var indexB=this.m_bodyB.GetIslandIndex();PhysicsType2d.Utils.log("  WeldJointDef jd;");PhysicsType2d.Utils.log("  jd.bodyA = bodies[{0}];",indexA);PhysicsType2d.Utils.log("  jd.bodyB = bodies[{0}];",indexB);PhysicsType2d.Utils.log("  jd.collideConnected = boolean({0});",this.m_collideConnected);PhysicsType2d.Utils.log("  jd.localAnchorA.Set({0}, {1});",this.m_localAnchorA.x,this.m_localAnchorA.y);PhysicsType2d.Utils.log("  jd.localAnchorB.Set({0}, {1});",this.m_localAnchorB.x,this.m_localAnchorB.y);PhysicsType2d.Utils.log("  jd.referenceAngle = {0};",this.m_referenceAngle);PhysicsType2d.Utils.log("  jd.frequencyHz = {0};",this.m_frequencyHz);PhysicsType2d.Utils.log("  jd.dampingRatio = {0};",this.m_dampingRatio);PhysicsType2d.Utils.log("  joints[{0}] = this.m_world->CreateJoint(&jd);",this.m_index);};WeldJoint.prototype.InitVelocityConstraints=function(data){this.m_indexA=this.m_bodyA.GetIslandIndex();this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_localCenterA=this.m_bodyA.GetSweep().localCenter;this.m_localCenterB=this.m_bodyB.GetSweep().localCenter;this.m_invMassA=this.m_bodyA.GetInvMass();this.m_invMassB=this.m_bodyB.GetInvMass();this.m_invIA=this.m_bodyA.GetInvI();this.m_invIB=this.m_bodyB.GetInvI();var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);this.m_rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));this.m_rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var mA=this.m_invMassA,mB=this.m_invMassB;var iA=this.m_invIA,iB=this.m_invIB;var K=new PhysicsType2d.Matrix3x3();K.EX.x=mA+mB+this.m_rA.y*this.m_rA.y*iA+this.m_rB.y*this.m_rB.y*iB;K.EY.x=-this.m_rA.y*this.m_rA.x*iA-this.m_rB.y*this.m_rB.x*iB;K.EZ.x=-this.m_rA.y*iA-this.m_rB.y*iB;K.EX.y=K.EY.x;K.EY.y=mA+mB+this.m_rA.x*this.m_rA.x*iA+this.m_rB.x*this.m_rB.x*iB;K.EZ.y=this.m_rA.x*iA+this.m_rB.x*iB;K.EX.z=K.EZ.x;K.EY.z=K.EZ.y;K.EZ.z=iA+iB;if(this.m_frequencyHz>0.0){this.m_mass=K.GetInverse22();var invM=iA+iB;var m=invM>0.0?1.0/invM:0.0;var C=aB-aA-this.m_referenceAngle;var omega=2.0*PhysicsType2d.Constants.PI*this.m_frequencyHz;var d=2.0*m*this.m_dampingRatio*omega;var k=m*omega*omega;var h=data.step.dt;this.m_gamma=h*(d+h*k);this.m_gamma=this.m_gamma!=0.0?1.0/this.m_gamma:0.0;this.m_bias=C*h*k*this.m_gamma;invM+=this.m_gamma;this.m_mass.EZ.z=invM!=0.0?1.0/invM:0.0;}else{this.m_mass=K.GetSymInverse33();this.m_gamma=0.0;this.m_bias=0.0;}
if(data.step.warmStarting){this.m_impulse=this.m_impulse.Multiply(data.step.dtRatio);var P=new PhysicsType2d.Vector2(this.m_impulse.x,this.m_impulse.y);vA=vA.Subtract(P.Multiply(mA));wA-=iA*(this.m_rA.Cross(P)+this.m_impulse.z);vB=vB.Add(P.Multiply(mB));wB+=iB*(this.m_rB.Cross(P)+this.m_impulse.z);}else{this.m_impulse.SetZero();}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};WeldJoint.prototype.SolveVelocityConstraints=function(data){var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var mA=this.m_invMassA,mB=this.m_invMassB;var iA=this.m_invIA,iB=this.m_invIB;if(this.m_frequencyHz>0.0){var Cdot2=wB-wA;var impulse2=-this.m_mass.EZ.z*(Cdot2+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=impulse2;wA-=iA*impulse2;wB+=iB*impulse2;var Cdot1=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,this.m_rB)).Subtract(vA).Subtract(PhysicsType2d.MathExtensions.Cross1x2(wA,this.m_rA));var impulse1=this.m_mass.Vector2Multiply(Cdot1).Negative();this.m_impulse.x+=impulse1.x;this.m_impulse.y+=impulse1.y;var P=impulse1;vA=vA.Subtract(P.Multiply(mA));wA-=iA*this.m_rA.Cross(P);vB=vB.Add(P.Multiply(mB));wB+=iB*this.m_rB.Cross(P);}else{var Cdot1=vB.Add(PhysicsType2d.MathExtensions.Cross1x2(wB,this.m_rB)).Subtract(vA).Subtract(PhysicsType2d.MathExtensions.Cross1x2(wA,this.m_rA));var Cdot2=wB-wA;var Cdot=new PhysicsType2d.Vector3(Cdot1.x,Cdot1.y,Cdot2);var impulse=this.m_mass.Vector3Multiply(Cdot).Negative();this.m_impulse=this.m_impulse.Add(impulse);var P=new PhysicsType2d.Vector2(impulse.x,impulse.y);vA=vA.Subtract(P.Multiply(mA));wA-=iA*(this.m_rA.Cross(P)+impulse.z);vB=vB.Add(P.Multiply(mB));wB+=iB*(this.m_rB.Cross(P)+impulse.z);}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};WeldJoint.prototype.SolvePositionConstraints=function(data){var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var mA=this.m_invMassA,mB=this.m_invMassB;var iA=this.m_invIA,iB=this.m_invIB;var rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));var rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var positionError=0;var angularError=0;var K=new PhysicsType2d.Matrix3x3();K.EX.x=mA+mB+rA.y*rA.y*iA+rB.y*rB.y*iB;K.EY.x=-rA.y*rA.x*iA-rB.y*rB.x*iB;K.EZ.x=-rA.y*iA-rB.y*iB;K.EX.y=K.EY.x;K.EY.y=mA+mB+rA.x*rA.x*iA+rB.x*rB.x*iB;K.EZ.y=rA.x*iA+rB.x*iB;K.EX.z=K.EZ.x;K.EY.z=K.EZ.y;K.EZ.z=iA+iB;if(this.m_frequencyHz>0.0){var C1=cB.Add(rB).Subtract(cA).Subtract(rA);positionError=C1.Length();angularError=0.0;var P=K.Solve2x2(C1).Negative();cA=cA.Subtract(P.Multiply(mA));aA-=iA*rA.Cross(P);cB=cB.Add(P.Multiply(mB));aB+=iB*rB.Cross(P);}else{var C1=cB.Add(rB).Subtract(cA).Subtract(rA);var C2=aB-aA-this.m_referenceAngle;positionError=C1.Length();angularError=Math.abs(C2);var C=new PhysicsType2d.Vector3(C1.x,C1.y,C2);var impulse=K.Solve3x3(C).Negative();var P=new PhysicsType2d.Vector2(impulse.x,impulse.y);cA=cA.Subtract(P.Multiply(mA));aA-=iA*(rA.Cross(P)+impulse.z);cB=cB.Add(P.Multiply(mB));aB+=iB*(rB.Cross(P)+impulse.z);}
data.positions[this.m_indexA].c=cA;data.positions[this.m_indexA].a=aA;data.positions[this.m_indexB].c=cB;data.positions[this.m_indexB].a=aB;return positionError<=PhysicsType2d.Settings.linearSlop&&angularError<=PhysicsType2d.Settings.angularSlop;};return WeldJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.WeldJoint=WeldJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var WheelJointDefinition=(function(_super){__extends(WheelJointDefinition,_super);function WheelJointDefinition(){_super.call(this);this.type=7;this.enableMotor=false;this.maxMotorTorque=0.0;this.motorSpeed=0.0;this.frequencyHz=2.0;this.dampingRatio=0.7;this.localAnchorA=new PhysicsType2d.Vector2(0,0);this.localAnchorB=new PhysicsType2d.Vector2(0,0);this.localAxisA=new PhysicsType2d.Vector2(1,0);}
WheelJointDefinition.prototype.Initialize=function(bA,bB,anchor,axis){this.bodyA=bA;this.bodyB=bB;this.localAnchorA=bA.GetLocalPoint(anchor);this.localAnchorB=bB.GetLocalPoint(anchor);this.localAxisA=bA.GetLocalVector(axis);};return WheelJointDefinition;})(PhysicsType2d.Dynamics.Joints.JointDefinition);Joints.WheelJointDefinition=WheelJointDefinition;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));var PhysicsType2d;(function(PhysicsType2d){(function(Dynamics){(function(Joints){var WheelJoint=(function(_super){__extends(WheelJoint,_super);function WheelJoint(def){_super.call(this,def);this.m_localAnchorA=new PhysicsType2d.Vector2(0,0);this.m_localAnchorB=new PhysicsType2d.Vector2(0,0);this.m_localXAxisA=new PhysicsType2d.Vector2(0,0);this.m_localYAxisA=new PhysicsType2d.Vector2(0,0);this.m_localCenterA=new PhysicsType2d.Vector2(0,0);this.m_localCenterB=new PhysicsType2d.Vector2(0,0);this.m_ax=new PhysicsType2d.Vector2(0,0);this.m_ay=new PhysicsType2d.Vector2(0,0);this.m_localAnchorA=def.localAnchorA.Clone();this.m_localAnchorB=def.localAnchorB.Clone();this.m_localXAxisA=def.localAxisA.Clone();this.m_localYAxisA=PhysicsType2d.MathExtensions.Cross1x2(1.0,this.m_localXAxisA);this.m_mass=0.0;this.m_impulse=0.0;this.m_motorMass=0.0;this.m_motorImpulse=0.0;this.m_springMass=0.0;this.m_springImpulse=0.0;this.m_maxMotorTorque=def.maxMotorTorque;this.m_motorSpeed=def.motorSpeed;this.m_enableMotor=def.enableMotor;this.m_frequencyHz=def.frequencyHz;this.m_dampingRatio=def.dampingRatio;this.m_bias=0.0;this.m_gamma=0.0;}
WheelJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);};WheelJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);};WheelJoint.prototype.GetReactionForce=function(inv_dt){return(this.m_ay.Multiply(this.m_impulse).Add(this.m_ax.Multiply(this.m_springImpulse))).Multiply(inv_dt);};WheelJoint.prototype.GetReactionTorque=function(inv_dt){return inv_dt*this.m_motorImpulse;};WheelJoint.prototype.GetLocalAnchorA=function(){return this.m_localAnchorA;};WheelJoint.prototype.GetLocalAnchorB=function(){return this.m_localAnchorB;};WheelJoint.prototype.GetLocalAxisA=function(){return this.m_localXAxisA;};WheelJoint.prototype.GetJointTranslation=function(){var bA=this.m_bodyA;var bB=this.m_bodyB;var pA=bA.GetWorldPoint(this.m_localAnchorA);var pB=bB.GetWorldPoint(this.m_localAnchorB);var d=pB.Subtract(pA);var axis=bA.GetWorldVector(this.m_localXAxisA);var translation=d.Dot(axis);return translation;};WheelJoint.prototype.GetJointSpeed=function(){var wA=this.m_bodyA.GetAngularVelocity();var wB=this.m_bodyB.GetAngularVelocity();return wB-wA;};WheelJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor;};WheelJoint.prototype.EnableMotor=function(flag){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_enableMotor=flag;};WheelJoint.prototype.SetMotorSpeed=function(speed){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_motorSpeed=speed;};WheelJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed;};WheelJoint.prototype.SetMaxMotorTorque=function(torque){this.m_bodyA.SetAwake(true);this.m_bodyB.SetAwake(true);this.m_maxMotorTorque=torque;};WheelJoint.prototype.GetMaxMotorTorque=function(){return this.m_maxMotorTorque;};WheelJoint.prototype.GetMotorTorque=function(inv_dt){return inv_dt*this.m_motorImpulse;};WheelJoint.prototype.SetSpringFrequencyHz=function(hz){this.m_frequencyHz=hz;};WheelJoint.prototype.GetSpringFrequencyHz=function(){return this.m_frequencyHz;};WheelJoint.prototype.SetSpringDampingRatio=function(ratio){this.m_dampingRatio=ratio;};WheelJoint.prototype.GetSpringDampingRatio=function(){return this.m_dampingRatio;};WheelJoint.prototype.Dump=function(){var indexA=this.m_bodyA.GetIslandIndex();var indexB=this.m_bodyB.GetIslandIndex();PhysicsType2d.Utils.log("  WheelJointDef jd;");PhysicsType2d.Utils.log("  jd.bodyA = bodies[{0}];",indexA);PhysicsType2d.Utils.log("  jd.bodyB = bodies[{0}];",indexB);PhysicsType2d.Utils.log("  jd.collideConnected = boolean({0});",this.m_collideConnected);PhysicsType2d.Utils.log("  jd.localAnchorA.Set({0}, {1});",this.m_localAnchorA.x,this.m_localAnchorA.y);PhysicsType2d.Utils.log("  jd.localAnchorB.Set({0}, {1});",this.m_localAnchorB.x,this.m_localAnchorB.y);PhysicsType2d.Utils.log("  jd.localAxisA.Set({0}, {1});",this.m_localXAxisA.x,this.m_localXAxisA.y);PhysicsType2d.Utils.log("  jd.enableMotor = boolean({0});",this.m_enableMotor);PhysicsType2d.Utils.log("  jd.motorSpeed = {0};",this.m_motorSpeed);PhysicsType2d.Utils.log("  jd.maxMotorTorque = {0};",this.m_maxMotorTorque);PhysicsType2d.Utils.log("  jd.frequencyHz = {0};",this.m_frequencyHz);PhysicsType2d.Utils.log("  jd.dampingRatio = {0};",this.m_dampingRatio);PhysicsType2d.Utils.log("  joints[{0}] = this.m_world.CreateJoint(&jd);",this.m_index);};WheelJoint.prototype.InitVelocityConstraints=function(data){this.m_indexA=this.m_bodyA.GetIslandIndex();this.m_indexB=this.m_bodyB.GetIslandIndex();this.m_localCenterA=this.m_bodyA.GetSweep().localCenter;this.m_localCenterB=this.m_bodyB.GetSweep().localCenter;this.m_invMassA=this.m_bodyA.GetInvMass();this.m_invMassB=this.m_bodyB.GetInvMass();this.m_invIA=this.m_bodyA.GetInvI();this.m_invIB=this.m_bodyB.GetInvI();var mA=this.m_invMassA,mB=this.m_invMassB;var iA=this.m_invIA,iB=this.m_invIB;var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));var rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var d=cB.Add(rB).Subtract(cA).Subtract(rA);{this.m_ay=qA.ApplyToVector2(this.m_localYAxisA);this.m_sAy=(d.Add(rA)).Cross(this.m_ay);this.m_sBy=rB.Cross(this.m_ay);this.m_mass=mA+mB+iA*this.m_sAy*this.m_sAy+iB*this.m_sBy*this.m_sBy;if(this.m_mass>0.0){this.m_mass=1.0/this.m_mass;}}
this.m_springMass=0.0;this.m_bias=0.0;this.m_gamma=0.0;if(this.m_frequencyHz>0.0){this.m_ax=qA.ApplyToVector2(this.m_localXAxisA);this.m_sAx=(d.Add(rA)).Cross(this.m_ax);this.m_sBx=rB.Cross(this.m_ax);var invMass=mA+mB+iA*this.m_sAx*this.m_sAx+iB*this.m_sBx*this.m_sBx;if(invMass>0.0){this.m_springMass=1.0/invMass;var C=d.Dot(this.m_ax);var omega=2.0*PhysicsType2d.Constants.PI*this.m_frequencyHz;var damping=2.0*this.m_springMass*this.m_dampingRatio*omega;var k=this.m_springMass*omega*omega;var h=data.step.dt;this.m_gamma=h*(damping+h*k);if(this.m_gamma>0.0){this.m_gamma=1.0/this.m_gamma;}
this.m_bias=C*h*k*this.m_gamma;this.m_springMass=invMass+this.m_gamma;if(this.m_springMass>0.0){this.m_springMass=1.0/this.m_springMass;}}}else{this.m_springImpulse=0.0;}
if(this.m_enableMotor){this.m_motorMass=iA+iB;if(this.m_motorMass>0.0){this.m_motorMass=1.0/this.m_motorMass;}}else{this.m_motorMass=0.0;this.m_motorImpulse=0.0;}
if(data.step.warmStarting){this.m_impulse*=data.step.dtRatio;this.m_springImpulse*=data.step.dtRatio;this.m_motorImpulse*=data.step.dtRatio;var P=(this.m_ay.Multiply(this.m_impulse)).Add(this.m_ax.Multiply(this.m_springImpulse));var LA=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse;var LB=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;vA=vA.Subtract(P.Multiply(this.m_invMassA));wA-=this.m_invIA*LA;vB=vB.Add(P.Multiply(this.m_invMassB));wB+=this.m_invIB*LB;}else{this.m_impulse=0.0;this.m_springImpulse=0.0;this.m_motorImpulse=0.0;}
data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};WheelJoint.prototype.SolveVelocityConstraints=function(data){var mA=this.m_invMassA;var mB=this.m_invMassB;var iA=this.m_invIA;var iB=this.m_invIB;var vA=data.velocities[this.m_indexA].v;var wA=data.velocities[this.m_indexA].w;var vB=data.velocities[this.m_indexB].v;var wB=data.velocities[this.m_indexB].w;(function(self){var Cdot=self.m_ax.Dot(vB.Subtract(vA))+self.m_sBx*wB-self.m_sAx*wA;var impulse=-self.m_springMass*(Cdot+self.m_bias+self.m_gamma*self.m_springImpulse);self.m_springImpulse+=impulse;var P=self.m_ax.Multiply(impulse);var LA=impulse*self.m_sAx;var LB=impulse*self.m_sBx;vA=vA.Subtract(P.Multiply(mA));wA-=iA*LA;vB=vB.Add(P.Multiply(mB));wB+=iB*LB;})(this);(function(self){var Cdot=wB-wA-self.m_motorSpeed;var impulse=-self.m_motorMass*Cdot;var oldImpulse=self.m_motorImpulse;var maxImpulse=data.step.dt*self.m_maxMotorTorque;self.m_motorImpulse=PhysicsType2d.MathExtensions.Clamp(self.m_motorImpulse+impulse,-maxImpulse,maxImpulse);impulse=self.m_motorImpulse-oldImpulse;wA-=iA*impulse;wB+=iB*impulse;})(this);(function(self){var Cdot=self.m_ay.Dot(vB.Subtract(vA))+self.m_sBy*wB-self.m_sAy*wA;var impulse=-self.m_mass*Cdot;self.m_impulse+=impulse;var P=self.m_ay.Multiply(impulse);var LA=impulse*self.m_sAy;var LB=impulse*self.m_sBy;vA=vA.Subtract(P.Multiply(mA));wA-=iA*LA;vB=vB.Add(P.Multiply(mB));wB+=iB*LB;})(this);data.velocities[this.m_indexA].v=vA;data.velocities[this.m_indexA].w=wA;data.velocities[this.m_indexB].v=vB;data.velocities[this.m_indexB].w=wB;};WheelJoint.prototype.SolvePositionConstraints=function(data){var cA=data.positions[this.m_indexA].c;var aA=data.positions[this.m_indexA].a;var cB=data.positions[this.m_indexB].c;var aB=data.positions[this.m_indexB].a;var qA=PhysicsType2d.Rotation.FromRadians(aA);var qB=PhysicsType2d.Rotation.FromRadians(aB);var rA=qA.ApplyToVector2(this.m_localAnchorA.Subtract(this.m_localCenterA));var rB=qB.ApplyToVector2(this.m_localAnchorB.Subtract(this.m_localCenterB));var d=cB.Subtract(cA).Add(rB.Subtract(rA));var ay=qA.ApplyToVector2(this.m_localYAxisA);var sAy=(d.Add(rA)).Cross(ay);var sBy=rB.Cross(ay);var C=d.Dot(ay);var k=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;var impulse=0.0;if(k!=0.0){impulse=-C/k;}
var P=ay.Multiply(impulse);var LA=impulse*sAy;var LB=impulse*sBy;cA=cA.Subtract(P.Multiply(this.m_invMassA));aA-=this.m_invIA*LA;cB=cB.Add(P.Multiply(this.m_invMassB));aB+=this.m_invIB*LB;data.positions[this.m_indexA].c=cA;data.positions[this.m_indexA].a=aA;data.positions[this.m_indexB].c=cB;data.positions[this.m_indexB].a=aB;return Math.abs(C)<=PhysicsType2d.Settings.linearSlop;};return WheelJoint;})(PhysicsType2d.Dynamics.Joints.Joint);Joints.WheelJoint=WheelJoint;})(Dynamics.Joints||(Dynamics.Joints={}));var Joints=Dynamics.Joints;})(PhysicsType2d.Dynamics||(PhysicsType2d.Dynamics={}));var Dynamics=PhysicsType2d.Dynamics;})(PhysicsType2d||(PhysicsType2d={}));